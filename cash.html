<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مدير المعاملات الذكي – بان للإعلانات</title>
  <meta name="theme-color" content="#1e293b" />
  <link rel="icon" href="https://moslimtech.github.io/Ban/icons/icon-192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* --- CSS Section --- */
    body { font-family: 'Tajawal', system-ui, -apple-system, 'Segoe UI', Roboto, Arial; }
    .btn-anim { transition: transform .12s ease, box-shadow .12s ease, background-color .2s ease, border-color .2s ease; }
    .btn-anim:active { transform: translateY(1px) scale(.995); }
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:60; backdrop-filter: blur(4px); }
    .modal-card { width:95%; max-width:880px; max-height:85vh; overflow:auto; border-radius:12px; padding:16px; background:var(--card-bg); }
    :root {
      --bg: #f0f9ff; --card-bg: rgba(255, 255, 255, 0.95); --text: #0f172a; --muted: #475569; --border-color: #e5e7eb; --input-bg: #ffffff; --input-border: #d1d5db; --focus-border: #3b82f6; --tab-active-bg: #ffffff; --tab-inactive-text: #6b7280;
    }
    .dark {
      --bg: #0f172a; --card-bg: rgba(30, 41, 59, 0.7); --text: #e2e8f0; --muted: #94a3b8; --border-color: rgba(255, 255, 255, 0.1); --input-bg: rgba(51, 65, 85, 0.5); --input-border: rgba(255, 255, 255, 0.15); --focus-border: #38bdf8; --tab-active-bg: rgba(51, 65, 85, 0.6); --tab-inactive-text: #94a3b8;
    }
    body { background: var(--bg); color: var(--text); } .muted { color: var(--muted); }
    .main-card { background: var(--card-bg); border: 1px solid var(--border-color); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); backdrop-filter: blur(12px); border-radius: 16px; }
    input, select { background-color: var(--input-bg); border-color: var(--input-border); color: var(--text); }
    input:focus, select:focus { border-color: var(--focus-border); box-shadow: 0 0 0 3px var(--focus-border-shadow, rgba(59, 130, 246, 0.2)); }
    .dark input:focus, .dark select:focus { --focus-border-shadow: rgba(56, 189, 248, 0.2); }
    .dark .network-btn { background-color: rgba(51, 65, 85, 0.3); }
    .network-btn.network-active { background: rgba(34, 197, 94, 0.12); border-color: #22c55e; }
    .dark .network-btn.network-active { background: rgba(56, 189, 248, 0.1); border-color: var(--focus-border); box-shadow: 0 0 12px rgba(56, 189, 248, 0.3); }
    .badge { padding:6px 8px; border-radius:8px; font-size:13px; } .confirmed { background: #dcfce7; color:#166534; } .pending { background: #fff7ed; color:#92400e; } .received { background: #dbeafe; color:#1e40af; }
    .dark .confirmed { background: rgba(74, 222, 128, 0.15); color: #a7f3d0; } .dark .pending { background: rgba(251, 191, 36, 0.15); color: #fde68a; } .dark .received { background: rgba(96, 165, 250, 0.15); color: #bfdbfe; }
    th, td { border-bottom: 1px solid var(--border-color); padding:8px 10px; text-align:right; font-size:14px; } table { width:100%; border-collapse: collapse; }
    .color-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 8px; vertical-align: middle; }
    .instapay-icon { display: inline-flex; align-items: center; margin-left: 8px; vertical-align: middle; } .instapay-stripe { width: 8px; height: 10px; } .instapay-stripe:first-child { background-color: #facc15; } .instapay-stripe:last-child { background-color: #0f172a; } .dark .instapay-stripe:last-child { background-color: #e2e8f0; }
    .network-btn { flex-direction: row-reverse; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 sm:p-6">
  <div class="max-w-4xl w-full">
    <header class="flex items-center justify-between mb-4">
        <!-- Header as before -->
        <div class="flex items-center gap-4">
            <img src="https://moslimtech.github.io/Ban/icons/icon-192.png" alt="logo" class="w-12 h-12 rounded-lg shadow" />
            <div><h1 class="text-lg font-bold">مدير المعاملات الذكي</h1><p class="text-sm muted">بان للإعلانات</p></div>
        </div>
        <div class="flex items-center gap-2">
            <a href="https://moslimtech.github.io/Ban/" class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-orange-100 dark:bg-slate-700 shadow btn-anim hover:shadow-md text-xl">🏠</a>
            <button id="themeToggle" class="w-10 h-10 rounded-full border border-slate-200 dark:border-slate-600 btn-anim flex items-center justify-center text-xl">🌗</button>
            <button id="settingsBtn" class="w-10 h-10 rounded-full border border-slate-200 dark:border-slate-600 btn-anim flex items-center justify-center text-xl">⚙️</button>
        </div>
    </header>

    <main class="main-card">
      <div class="flex border-b" style="border-color: var(--border-color);">
        <button id="sendTabBtn" class="tab-btn flex-1 py-3 px-4 text-sm font-semibold transition-colors duration-200">تحويل أموال</button>
        <button id="receiveTabBtn" class="tab-btn flex-1 py-3 px-4 text-sm font-semibold transition-colors duration-200">تسجيل استلام</button>
      </div>
      <div class="p-5 sm:p-6">
        <!-- لوحة تحويل الأموال -->
        <div id="sendPanel" class="tab-panel space-y-6">
          <div>
              <label for="sendWalletSelector" class="block text-sm font-medium muted mb-1">التحويل من:</label>
              <select id="sendWalletSelector" class="w-full px-3 py-2 rounded-lg border focus:outline-none"></select>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium muted mb-1">إلى رقم (المستلم):</label>
              <div class="flex gap-2 items-center">
                <button type="button" id="pickContactBtn" class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-emerald-500 text-white btn-anim hover:bg-emerald-600 text-lg">👤</button>
                <input id="phoneInput" type="tel" inputmode="tel" placeholder="01xxxxxxxxx" class="flex-1 px-3 py-2 rounded-lg border focus:outline-none" />
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium muted mb-1">المبلغ (جنيه)</label>
              <input id="amountInput" type="number" min="1" placeholder="25" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
            </div>
          </div>
          <div id="networkSelectionContainer">
            <label class="block text-sm font-medium muted mb-2">عبر شبكة:</label>
            <div id="networkButtonsWrapper" class="grid grid-cols-2 md:grid-cols-3 gap-3">
              <button type="button" data-net="vodafone" class="network-btn ..."><span class="color-dot" style="background-color: #ef4444;"></span>فودافون</button>
              <button type="button" data-net="etisalat" class="network-btn ..."><span class="color-dot" style="background-color: #22c55e;"></span>اتصالات</button>
              <button type="button" data-net="orange" class="network-btn ..."><span class="color-dot" style="background-color: #f97316;"></span>اورانج</button>
              <button type="button" data-net="we" class="network-btn ..."><span class="color-dot" style="background-color: #8b5cf6;"></span>وي</button>
              <button type="button" data-net="instapay" class="network-btn ..."><span class="instapay-icon">...</span>إنستاباي</button>
            </div>
          </div>
          <div class="flex justify-end pt-2">
            <button id="generateBtn" type="button" class="px-4 py-2 rounded-xl bg-teal-500 text-white font-semibold shadow-lg btn-anim hover:bg-teal-600 flex items-center gap-2">🚀 تحويل الآن</button>
          </div>
        </div>

        <!-- لوحة تسجيل الاستلام -->
        <div id="receivePanel" class="tab-panel hidden space-y-4">
            <!-- ... Same as before ... -->
        </div>
      </div>
      <div class="text-center p-4 border-t" style="border-color: var(--border-color);">
        <button id="historyBtn" type="button" class="px-4 py-2 rounded-xl bg-amber-100 dark:bg-amber-900/50 text-amber-800 dark:text-amber-300 font-medium btn-anim hover:shadow flex items-center gap-2 mx-auto">
          📜 عرض سجل المعاملات
        </button>
      </div>
    </main>
    <footer class="mt-4 text-center text-xs muted">© 2025 بان للإعلانات</footer>
  </div>

  <!-- نافذة السجل -->
  <div id="historyBackdrop" class="modal-backdrop hidden">...</div>

  <!-- نافذة الإعدادات (مُحدثة) -->
  <div id="settingsBackdrop" class="modal-backdrop hidden">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg">⚙️ الإعدادات العامة</h3>
        <button id="closeSettingsBtn" class="px-3 py-2 bg-gray-200 dark:bg-slate-600 rounded-lg text-sm">إغلاق</button>
      </div>
      <div class="space-y-4">
        <!-- Profit Margin as before -->
        <hr class="dark:border-slate-700"/>
        <div>
          <h4 class="font-semibold mb-2">إدارة المحافظ</h4>
          <div id="walletsList" class="space-y-2 mb-4"></div>
          <div class="p-4 rounded-lg bg-slate-50 dark:bg-slate-800/50 border dark:border-slate-700">
            <h5 class="font-semibold mb-3">إضافة محفظة جديدة</h5>
            <form id="addWalletForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="sm:col-span-2">
                <label for="walletAlias" class="block text-xs font-medium muted mb-1">اسم مميز</label>
                <input id="walletAlias" type="text" required placeholder="فودافون شخصي" class="w-full ..."/>
              </div>
              <div>
                <label for="walletNumber" class="block text-xs font-medium muted mb-1">رقم المحفظة</label>
                <input id="walletNumber" type="tel" required placeholder="01xxxxxxxxx" class="w-full ..."/>
              </div>
              <div>
                <label for="walletNetwork" class="block text-xs font-medium muted mb-1">الشبكة</label>
                <select id="walletNetwork" required class="w-full ...">
                    <option value="" disabled selected>اختر الشبكة</option>
                    <option value="vodafone">فودافون</option>
                    <option value="etisalat">اتصالات</option>
                    <option value="orange">اورانج</option>
                    <option value="we">وي</option>
                    <option value="instapay">إنستاباي</option>
                </select>
              </div>
              <div>
                <label for="walletBalance" class="block text-xs font-medium muted mb-1">رصيد افتتاحي</label>
                <input id="walletBalance" type="number" required value="0" min="0" class="w-full ..."/>
              </div>
              <div>
                <label for="walletLimit" class="block text-xs font-medium muted mb-1">حد المعاملات</label>
                <input id="walletLimit" type="number" required value="100" min="1" class="w-full ..."/>
              </div>
              <div class="sm:col-span-2">
                <button type="submit" class="w-full ...">+ إضافة المحفظة</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- JavaScript Logic (Final Version with Smart Network Selection) ---
    // --- Element Definitions ---
    const settingsBtn = document.getElementById('settingsBtn'), settingsBackdrop = document.getElementById('settingsBackdrop'), closeSettingsBtn = document.getElementById('closeSettingsBtn'), profitMarginInput = document.getElementById('profitMarginInput'), addWalletForm = document.getElementById('addWalletForm'), walletsList = document.getElementById('walletsList');
    const sendTabBtn = document.getElementById('sendTabBtn'), receiveTabBtn = document.getElementById('receiveTabBtn'), sendPanel = document.getElementById('sendPanel'), receivePanel = document.getElementById('receivePanel');
    const historyBtn = document.getElementById('historyBtn'), themeToggle = document.getElementById('themeToggle');
    const sendWalletSelector = document.getElementById('sendWalletSelector'), receiveWalletSelector = document.getElementById('receiveWalletSelector'), phoneInput = document.getElementById('phoneInput'), amountInput = document.getElementById('amountInput');
    const networkSelectionContainer = document.getElementById('networkSelectionContainer'), networkButtonsWrapper = document.getElementById('networkButtonsWrapper'), networkButtons = networkButtonsWrapper.querySelectorAll('.network-btn');
    const generateBtn = document.getElementById('generateBtn'), pickContactBtn = document.getElementById('pickContactBtn');
    const historyBackdrop = document.getElementById('historyBackdrop'), historyTbody = document.getElementById('historyTbody'), historyStats = document.getElementById('historyStats'), closeHistoryBtn = document.getElementById('closeHistoryBtn'), modalTotalProfit = document.getElementById('modalTotalProfit');
    let manualSelectedNetwork = 'vodafone';

    // --- DB & Utilities ---
    const DB_KEY = 'ban_smart_pos_v1';
    const defaultDB = { settings: { profitMargin: 2.0 }, wallets: [], transactions: [] };
    function loadDB() { return JSON.parse(localStorage.getItem(DB_KEY) || JSON.stringify(defaultDB)); }
    function saveDB(db) { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    function getWalletCalculations(wallet, allTransactions) { /* ... same as before ... */ }
    function onlyDigits(value = '') { return String(value || '').replace(/[^0-9]/g, ''); }
    const templates = { vodafone: (p, a) => `*9*7*${p}*${a}#`, etisalat: (p, a) => `*777*${p}*${a}#`, orange: (p, a) => `*115*1*${p}*${a}#`, we: (p, a) => `*322*${p}*${a}#`, instapay: (p,a) => `instapay://pay?recipient=${p}&amount=${a}`};
    const networkLabels = { vodafone: 'فودافون', etisalat: 'اتصالات', orange: 'أورانج', we: 'وي', instapay: 'إنستاباي', received_cash: 'استلام نقدي' };

    // --- Settings Modal ---
    settingsBtn.addEventListener('click', () => { settingsBackdrop.classList.remove('hidden'); loadSettingsIntoUI(); });
    closeSettingsBtn.addEventListener('click', () => { settingsBackdrop.classList.add('hidden'); populateWalletSelectors(); });
    // ... profitMarginInput listener ...
    addWalletForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const alias = document.getElementById('walletAlias').value.trim();
        const number = document.getElementById('walletNumber').value.trim();
        const network = document.getElementById('walletNetwork').value;
        const balance = parseFloat(document.getElementById('walletBalance').value);
        const limit = parseInt(document.getElementById('walletLimit').value);

        if (!alias || !number || !network || isNaN(balance) || isNaN(limit)) { alert('الرجاء ملء جميع الحقول بشكل صحيح.'); return; }
        const db = loadDB();
        if (db.wallets.some(w => w.id === number)) { alert('هذا الرقم موجود بالفعل.'); return; }
        // Use number as ID for uniqueness
        db.wallets.push({ id: number, alias, network, openingBalance: balance, limit });
        saveDB(db);
        addWalletForm.reset();
        renderWalletsList();
    });
    function loadSettingsIntoUI() { /* ... same as before ... */ }
    function renderWalletsList() {
        // ... modified to show network in wallet list ...
        // walletEl.innerHTML = `... <p>الشبكة: ${networkLabels[wallet.network]}</p> ...`
    }
    function handleDeleteWallet(e) { /* ... same as before ... */ }

    // --- Main UI Logic (Smart Network Selection) ---
    function populateWalletSelectors() {
        const db = loadDB();
        sendWalletSelector.innerHTML = '<option value="manual">تحويل سريع (يدوي)</option>';
        receiveWalletSelector.innerHTML = '';
        if (db.wallets.length === 0) { return; }
        
        db.wallets.forEach(wallet => {
            const { currentBalance, txCount } = getWalletCalculations(wallet, db.transactions);
            const optionText = `${wallet.alias} (${wallet.id}) - رصيد: ${currentBalance.toFixed(2)} ج`;
            const sendOptionHTML = `<option value="${wallet.id}">${optionText}</option>`;
            sendWalletSelector.innerHTML += sendOptionHTML;
            // Also populate receive selector
            receiveWalletSelector.innerHTML += `<option value="${wallet.id}">${wallet.alias} (${wallet.id})</option>`;
        });
    }

    sendWalletSelector.addEventListener('change', (e) => {
        const selectedValue = e.target.value;
        if (selectedValue === 'manual') {
            // Show all network buttons for manual mode
            networkButtons.forEach(btn => btn.style.display = 'flex');
            networkSelectionContainer.style.display = 'block';
        } else {
            // It's a wallet ID (which is the number)
            const db = loadDB();
            const selectedWallet = db.wallets.find(w => w.id === selectedValue);
            if (selectedWallet) {
                // Hide container, or just show the one button
                networkSelectionContainer.style.display = 'block';
                networkButtons.forEach(btn => {
                    btn.style.display = btn.dataset.net === selectedWallet.network ? 'flex' : 'none';
                });
                // Automatically activate the correct network button
                const activeBtn = networkButtonsWrapper.querySelector(`[data-net="${selectedWallet.network}"]`);
                if(activeBtn) activeBtn.classList.add('network-active');
            }
        }
    });
    
    generateBtn.addEventListener('click', () => {
        const db = loadDB();
        const sourceWalletId = sendWalletSelector.value;
        const recipientPhone = phoneInput.value.trim();
        const amount = parseFloat(amountInput.value);

        if (!recipientPhone || isNaN(amount) || amount <= 0) { /* alert */ return; }
        
        let networkToUse = '';
        let transactionToSave = {};

        if (sourceWalletId === 'manual') {
            networkToUse = manualSelectedNetwork;
            // Create a temporary transaction not linked to a wallet
            transactionToSave = { /* ... id, type, recipient, amount, no profit, network, date, confirmed */ };
             if (confirm('تسجيل كمعاملة يدوية. هل تريد المتابعة؟')) {
                // Just open the link, don't save anything
                const link = `tel:${encodeURIComponent(templates[networkToUse](onlyDigits(recipientPhone), amount))}`;
                window.location.href = link;
             }
        } else {
            const sourceWallet = db.wallets.find(w => w.id === sourceWalletId);
            // ... All the checks for balance and limit as before ...
            networkToUse = sourceWallet.network; // Get network automatically from wallet
            const profit = amount * (db.settings.profitMargin / 100);
            transactionToSave = { id: Date.now(), type: 'sent', sourceWalletId: sourceWallet.id, recipient: onlyDigits(recipientPhone), amount: amount, profit: profit, network: networkToUse, date: new Date().toLocaleString('ar-EG'), confirmed: false };
            
            db.transactions.unshift(transactionToSave);
            saveDB(db);
            populateWalletSelectors();
            
            const link = `tel:${encodeURIComponent(templates[networkToUse](onlyDigits(recipientPhone), amount))}`;
            if (confirm('تم تسجيل المعاملة. فتح تطبيق الاتصال؟')) {
                window.location.href = link;
            }
        }
    });
    
    networkButtons.forEach(btn => btn.addEventListener('click', () => {
        if(sendWalletSelector.value === 'manual') {
            manualSelectedNetwork = btn.dataset.net;
            networkButtons.forEach(b => b.classList.remove('network-active'));
            btn.classList.add('network-active');
        }
    }));

    // --- Other functions (history, theme, etc.) ---
    // ... no major changes needed here yet ...

    // Initial App Load
    document.addEventListener('DOMContentLoaded', () => {
      populateWalletSelectors();
      // Trigger change event to set initial state for network buttons
      sendWalletSelector.dispatchEvent(new Event('change'));
      // ... other initializers ...
    });
  </script>
</body>
</html>
