<!-- <!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙˆÙ„Ù‘Ø¯ Ø£ÙƒÙˆØ§Ø¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ â€“ Ø¨Ø§Ù† Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
  <meta name="theme-color" content="#0d9488" />
  <link rel="icon" href="/Ban/icons/icon-192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Tajawal', system-ui, -apple-system, 'Segoe UI', Roboto, Arial; }
    .glass { background: rgba(255,255,255,0.6); backdrop-filter: blur(6px); }
    .btn-anim { transition: transform .12s ease, box-shadow .12s ease; }
    .btn-anim:active { transform: translateY(2px) scale(.995); }
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:60; }
    .modal-card { width:95%; max-width:880px; max-height:85vh; overflow:auto; border-radius:12px; padding:16px; background:var(--card-bg); }
    :root {
      --bg: linear-gradient(180deg,#f0f9ff,#ecfdf5);
      --card-bg: rgba(255,255,255,0.95);
      --text: #0f172a;
      --muted: #475569;
    }
    .dark {
      --bg: linear-gradient(180deg,#071627,#042f2f);
      --card-bg: rgba(2,6,23,0.75);
      --text: #e6eef0;
      --muted: #94a3b8;
    }
    body { background: var(--bg); color: var(--text); }
    .muted { color: var(--muted); }
    .network-active { background: rgba(34,197,94,0.12); border-color: rgba(34,197,94,0.25); }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px 10px; border-bottom:1px solid rgba(0,0,0,0.06); text-align:right; font-size:14px; }
    .badge { padding:6px 8px; border-radius:8px; font-size:13px; }
    .confirmed { background: #dcfce7; color:#166534; }
    .pending { background: #fff7ed; color:#92400e; }
  </style>

 
  <script>
    const userLang = navigator.language || navigator.userLanguage || 'ar';
    const manifest = document.createElement('link');
    manifest.rel = 'manifest';
    if (userLang.startsWith('ar')) manifest.href = '/Ban/manifest-ar.json?v=1';
    else manifest.href = '/Ban/manifest-en.json?v=1';
    document.head.appendChild(manifest);
  </script>
</head>
<body class="min-h-screen flex items-center justify-center p-6">
  <div class="max-w-4xl w-full">
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-4">
        <img src="https://moslimtech.github.io/Ban/icons/icon-192.png" alt="logo" class="w-12 h-12 rounded-lg shadow" />
        <div>
          <h1 class="text-lg font-bold">Ù…ÙˆÙ„Ù‘Ø¯ Ø£ÙƒÙˆØ§Ø¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ â€“ Ø¨Ø§Ù† Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h1>
          <p class="text-sm muted">Ø³Ù‡Ù„ â€¢ Ø³Ø±ÙŠØ¹ â€¢ ÙŠÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="themeToggle" class="px-3 py-2 rounded-lg border btn-anim">ğŸŒ—</button>
        <a href="https://moslimtech.github.io/Ban/" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white shadow btn-anim hover:shadow-md">ğŸ“¢</a>
      </div>
    </header>

    <main class="modal-card glass p-5">
      <form id="cashForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium muted mb-1">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
            <div class="flex gap-2">
              <input id="phoneInput" type="tel" inputmode="tel" class="flex-1 px-3 py-2 rounded-lg border focus:outline-none" />
        
              <button type="button" id="pickContactBtn" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-sky-600 text-white btn-anim hover:bg-sky-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 9a3 3 0 100-6 3 3 0 000 6z"/><path fill-rule="evenodd" d="M2 13a6 6 0 1112 0v1H2v-1z" clip-rule="evenodd"/></svg>
               
              </button>
            

          <div>
            <label class="block text-sm font-medium muted mb-1">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬Ù†ÙŠÙ‡)</label>
            <input id="amountInput" type="number" min="1" placeholder="25" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium muted mb-2">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¨ÙƒØ©</label>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
            <button type="button" data-net="vodafone" class="network-btn px-3 py-2 rounded-lg border bg-white">ÙÙˆØ¯Ø§ÙÙˆÙ†</button>
            <button type="button" data-net="etisalat" class="network-btn px-3 py-2 rounded-lg border bg-white">Ø§ØªØµØ§Ù„Ø§Øª</button>
            <button type="button" data-net="orange" class="network-btn px-3 py-2 rounded-lg border bg-white">Ø§ÙˆØ±Ø§Ù†Ø¬</button>
            <button type="button" data-net="we" class="network-btn px-3 py-2 rounded-lg border bg-white">ÙˆÙŠ</button>
            <button type="button" data-net="instapay" class="network-btn px-3 py-2 rounded-lg border bg-white">Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ</button>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button id="generateBtn" type="button" class="ml-auto px-4 py-2 rounded-xl bg-emerald-500 text-white font-semibold shadow-lg btn-anim hover:bg-emerald-600">ğŸ” ØªØ­ÙˆÙŠÙ„</button>
          <button id="previewBtn" type="button" class="px-4 py-2 rounded-xl bg-white border font-medium btn-anim hover:shadow">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
          <button id="historyBtn" type="button" class="px-4 py-2 rounded-xl bg-amber-500 text-white btn-anim hover:bg-amber-600">ğŸ“œ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</button>
        </div>

        <div id="resultBox" class="mt-4 hidden p-4 rounded-lg bg-white border">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-sm muted">ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·/Ø§Ù„ÙƒÙˆØ¯ â€” Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£Ùˆ Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯:</p>
              <pre id="resultText" class="code mt-2 text-sm"></pre>
              <div class="mt-3 flex gap-2">
                <button id="copyBtn" class="px-3 py-2 rounded bg-sky-600 text-white">Ù†Ø³Ø®</button>
                <a id="openLinkBtn" class="px-3 py-2 rounded bg-emerald-500 text-white" href="#" target="_blank" rel="noopener">ÙØªØ­</a>
                <a id="whatsappBtn" class="px-3 py-2 rounded bg-green-600 text-white" href="#" target="_blank" rel="noopener">ÙˆØ§ØªØ³Ø§Ø¨</a>
              </div>
            </div>
            <div class="text-sm muted text-right">
              <div>Ø§Ù„Ø´Ø¨ÙƒØ©: <span id="showNetwork">-</span></div>
              <div class="mt-2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¤ÙƒØ¯: <strong id="totalConfirmed">0</strong> Ø¬</div>
            </div>
          </div>
        </div>

      </form>
    </main>

    <footer class="mt-4 text-center text-xs muted">Â© Ø¨Ø§Ù† Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</footer>
  </div>


  <div id="historyBackdrop" class="modal-backdrop hidden">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-bold text-lg">ğŸ“œ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
        <div class="flex gap-2">
          <button id="downloadCsvBtn" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ğŸ“¥</button>
          <button id="clearHistoryBtn" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">ğŸ—‘ï¸</button>
          <button id="closeHistoryBtn" class="px-3 py-2 bg-gray-200 rounded-lg">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div id="historyStats" class="mb-3 text-sm muted"></div>

      <div id="historyTableWrapper" class="overflow-auto">
        <table id="historyTable" class="bg-transparent">
          <thead>
            <tr>
              <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>ğŸ“± Ø§Ù„Ø±Ù‚Ù…</th>
              <th>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>ğŸ“¶ Ø§Ù„Ø´Ø¨ÙƒØ©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="historyTbody">
         
          </tbody>
        </table>
      </div>

      <div class="mt-4 text-right">
        <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¤ÙƒØ¯: <span id="modalTotalConfirmed">0</span> Ø¬Ù†ÙŠÙ‡</strong>
      </div>
    </div>
  </div>

  <script>
   
    const templates = {
      vodafone: (localPhone, amount) => `*9*7*${localPhone}*${amount}#`,
      etisalat: (localPhone, amount) => `*777*${localPhone}*${amount}#`,
      orange: (localPhone, amount) => `*115*1*${localPhone}*${amount}#`,
      we: (localPhone, amount) => `*322*${localPhone}*${amount}#`,
      instapayDeep: (phone, amount) => `instapay://pay?recipient=${phone}&amount=${amount}`,
      instapayWeb: (phone, amount) => `https://ipn.eg/S/instapay?recipient=${phone}&amount=${amount}`
    };

    /********** Elements **********/
    const phoneInput = document.getElementById('phoneInput');
    const amountInput = document.getElementById('amountInput');
    const networkButtons = document.querySelectorAll('.network-btn');
    const generateBtn = document.getElementById('generateBtn');
    const previewBtn = document.getElementById('previewBtn');
    const historyBtn = document.getElementById('historyBtn');
    const resultBox = document.getElementById('resultBox');
    const resultText = document.getElementById('resultText');
    const copyBtn = document.getElementById('copyBtn');
    const openLinkBtn = document.getElementById('openLinkBtn');
    const whatsappBtn = document.getElementById('whatsappBtn');
    const showNetwork = document.getElementById('showNetwork');
    const totalConfirmedSpan = document.getElementById('totalConfirmed');

    const pickContactBtn = document.getElementById('pickContactBtn');
    const historyBackdrop = document.getElementById('historyBackdrop');
    const historyTbody = document.getElementById('historyTbody');
    const historyStats = document.getElementById('historyStats');
    const closeHistoryBtn = document.getElementById('closeHistoryBtn');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const modalTotalConfirmed = document.getElementById('modalTotalConfirmed');
    const themeToggle = document.getElementById('themeToggle');

    let selectedNetwork = 'vodafone';

    /********** Theme (light/dark) **********/
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    function applyTheme(t) {
      if (t === 'dark') document.documentElement.classList.add('dark'), localStorage.setItem('theme','dark');
      else document.documentElement.classList.remove('dark'), localStorage.setItem('theme','light');
    }
    const saved = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
    applyTheme(saved);
    themeToggle.textContent = saved === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    themeToggle.addEventListener('click', () => {
      const now = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(now);
      themeToggle.textContent = now === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    });

    /********** Network selection visuals **********/
    function markSelected() {
      networkButtons.forEach(b => {
        if (b.dataset.net === selectedNetwork) b.classList.add('network-active');
        else b.classList.remove('network-active');
      });
    }
    networkButtons.forEach(btn => btn.addEventListener('click', () => { selectedNetwork = btn.dataset.net; markSelected(); }));
    markSelected();

    /********** Contact picker (best-effort) **********/
    pickContactBtn.addEventListener('click', async () => {
      try {
        if (navigator.contacts && navigator.contacts.select) {
          const props = ['tel','name'];
          const opts = { multiple:false };
          const contacts = await navigator.contacts.select(props, opts);
          if (contacts && contacts.length) {
            const tel = (contacts[0].tel && contacts[0].tel[0]) || '';
            phoneInput.value = tel.replace(/\s|-|\(|\)/g,'');
            return;
          }
        }
        phoneInput.focus();
        alert('Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ù…Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹.');
      } catch(e) {
        console.error(e);
        phoneInput.focus();
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ â€” Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹.');
      }
    });

    /********** Helpers: clean and convert numbers **********/
    function onlyDigits(s=''){ return String(s||'').replace(/[^0-9]/g,''); }
    function toLocal(cleaned) {
      if (!cleaned) return '';
      if (cleaned.startsWith('20')) return '0' + cleaned.slice(2);
      if (cleaned.startsWith('2') && cleaned.length===11) return '0' + cleaned.slice(1);
      if (cleaned.startsWith('0')) return cleaned;
      if (cleaned.length === 9) return '0' + cleaned;
      return cleaned;
    }
    function toInternational(cleaned) {
      if (!cleaned) return '';
      if (cleaned.startsWith('0')) return '2' + cleaned.slice(1);
      if (cleaned.startsWith('20')) return cleaned;
      if (cleaned.startsWith('2') && cleaned.length>2) return cleaned;
      return cleaned;
    }

    /********** Build action links **********/
    function buildActionLink(network, phoneRaw, amountRaw) {
      const cleaned = onlyDigits(phoneRaw);
      const amount = Number(amountRaw) || 0;
      if (!cleaned || amount <= 0) return null;

      const local = toLocal(cleaned);
      const intl = toInternational(cleaned);

      if (network === 'instapay') {
        return { type:'instapay', deep: templates.instapayDeep(intl, amount), web: templates.instapayWeb(intl, amount), local, intl, amount };
      }

      const code = templates[network](local, amount);
      return { type:'ussd', url: 'tel:' + encodeURIComponent(code), code: code, local, intl, amount };
    }

    /********** History (localStorage) **********/
    const STORAGE_KEY = 'ban_cash_transactions_v1';
    function loadHistory() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch(e){ return []; }
    }
    function saveHistory(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
    function addHistoryItem(item) {
      const arr = loadHistory();
      arr.unshift(item);
      if (arr.length > 500) arr.pop();
      saveHistory(arr);
    }
    function clearHistory() { localStorage.removeItem(STORAGE_KEY); }

    /********** UI: show preview & open **********/
    function showResult(obj) {
      resultBox.classList.remove('hidden');
      if (obj.type === 'instapay') {
        resultText.textContent = obj.web;
        openLinkBtn.href = obj.deep;
        openLinkBtn.setAttribute('data-fallback', obj.web);
        showNetwork.textContent = 'Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ';
      } else {
        resultText.textContent = obj.code;
        openLinkBtn.href = obj.url;
        openLinkBtn.removeAttribute('data-fallback');
        showNetwork.textContent = (selectedNetwork === 'vodafone' ? 'ÙÙˆØ¯Ø§ÙÙˆÙ†' : selectedNetwork === 'etisalat' ? 'Ø§ØªØµØ§Ù„Ø§Øª' : selectedNetwork === 'orange' ? 'Ø§ÙˆØ±Ø§Ù†Ø¬' : 'ÙˆÙŠ');
      }
      whatsappBtn.href = 'https://wa.me/' + obj.intl;
      updateTotalsDisplay();
    }

    generateBtn.addEventListener('click', () => {
      const phone = phoneInput.value.trim();
      const amount = amountInput.value.trim();
      const obj = buildActionLink(selectedNetwork, phone, amount);
      if (!obj) { alert('Ù…Ù† ÙØ¶Ù„Ùƒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ§Ù„Ø­ ÙˆØ§Ù„Ù…Ø¨Ù„Øº.'); return; }

      // Save to history with confirmed=false + date
      const now = new Date();
      addHistoryItem({ number: onlyDigits(phone), local: obj.local, intl: obj.intl, amount: obj.amount, network: selectedNetwork, date: now.toLocaleString('ar-EG'), confirmed: false });

      showResult(obj);

      // Try to open automatically:
      if (obj.type === 'instapay') {
        try { window.location.href = obj.deep; } catch(_) {}
        setTimeout(() => { window.location.href = obj.web; }, 1200);
      } else {
        try { window.location.href = obj.url; } catch(e){ console.error(e); }
      }
    });

    openLinkBtn.addEventListener('click', (e) => {
      const href = openLinkBtn.href;
      const fallback = openLinkBtn.getAttribute('data-fallback');
      if (!fallback) return;
      e.preventDefault();
      try { window.location.href = href; } catch(e){ console.error(e); }
      setTimeout(() => { window.location.href = fallback; }, 1200);
    });

    previewBtn.addEventListener('click', () => {
      const phone = phoneInput.value.trim();
      const amount = amountInput.value.trim();
      const obj = buildActionLink(selectedNetwork, phone, amount);
      if (!obj) { alert('Ù…Ù† ÙØ¶Ù„Ùƒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ§Ù„Ø­ ÙˆØ§Ù„Ù…Ø¨Ù„Øº.'); return; }
      showResult(obj);
    });

    copyBtn.addEventListener('click', async () => {
      const txt = resultText.textContent || '';
      try {
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = 'ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“';
        setTimeout(() => copyBtn.textContent = 'Ù†Ø³Ø®', 1500);
      } catch (e) {
        alert('Ù†Ø³Ø® ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠÙ‹Ø§.');
      }
    });

    /********** History modal UI & table **********/
    historyBtn.addEventListener('click', () => { renderHistory(); historyBackdrop.classList.remove('hidden'); historyBackdrop.style.display='flex'; });
    closeHistoryBtn.addEventListener('click', () => { historyBackdrop.classList.add('hidden'); historyBackdrop.style.display='none'; });

    clearHistoryBtn.addEventListener('click', () => {
      if (!confirm('Ù‡Ù„ Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§ØªØŸ')) return;
      clearHistory();
      renderHistory();
      updateTotalsDisplay();
    });

    function renderHistory() {
      const arr = loadHistory();
      historyTbody.innerHTML = '';
      if (!arr.length) {
        historyStats.innerHTML = `<p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.</p>`;
        modalTotalConfirmed.textContent = '0';
        return;
      }

      // stats
      const totalAmount = arr.reduce((s,t)=>s+Number(t.amount),0);
      const confirmedAmount = arr.filter(t=>t.confirmed).reduce((s,t)=>s+Number(t.amount),0);
      const totalCount = arr.length;
      const confirmedCount = arr.filter(t=>t.confirmed).length;

      historyStats.innerHTML = `ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <strong>${totalCount}</strong> â€” Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº: <strong>${totalAmount}</strong> Ø¬ â€” ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯: <strong>${confirmedCount}</strong> (${confirmedAmount} Ø¬)`;

      arr.forEach((t, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="white-space:nowrap">${t.date}</td>
          <td>${t.local || t.number}</td>
          <td>${t.amount}</td>
          <td>${t.network}</td>
          <td>${t.confirmed ? '<span class="badge confirmed">ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„</span>' : '<span class="badge pending">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span>'}</td>
          <td>
            ${t.confirmed ? '' : `<button data-idx="${idx}" class="confirm-row px-3 py-1 rounded bg-emerald-500 text-white">ØªØ£ÙƒÙŠØ¯</button>`}
            <button data-del="${idx}" class="delete-row px-3 py-1 rounded bg-red-100 ml-2">Ø­Ø°Ù</button>
          </td>
        `;
        historyTbody.appendChild(tr);
      });

      // attach handlers
      historyTbody.querySelectorAll('.confirm-row').forEach(b=>{
        b.addEventListener('click', (e)=>{
          const idx = Number(b.getAttribute('data-idx'));
          confirmFromHistory(idx);
        });
      });
      historyTbody.querySelectorAll('.delete-row').forEach(b=>{
        b.addEventListener('click', (e)=>{
          const idx = Number(b.getAttribute('data-del'));
          deleteFromHistory(idx);
        });
      });

      modalTotalConfirmed.textContent = confirmedAmount;
    }

    function confirmFromHistory(index) {
      const arr = loadHistory();
      if (!arr[index]) return;
      arr[index].confirmed = true;
      saveHistory(arr);
      renderHistory();
      updateTotalsDisplay();
    }

    function deleteFromHistory(index) {
      const arr = loadHistory();
      if (!arr[index]) return;
      if (!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ')) return;
      arr.splice(index,1);
      saveHistory(arr);
      renderHistory();
      updateTotalsDisplay();
    }

    function updateTotalsDisplay() {
      const arr = loadHistory();
      const total = arr.filter(x=>x.confirmed).reduce((s,x)=>s+Number(x.amount),0);
      totalConfirmedSpan.textContent = total;
      modalTotalConfirmed.textContent = total;
    }

    /********** Download CSV (includes date) **********/
    downloadCsvBtn.addEventListener('click', downloadHistoryCSV);
    function downloadHistoryCSV() {
      const arr = loadHistory();
      if (!arr.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„ØªØ­Ù…ÙŠÙ„Ù‡Ø§.'); return; }
      let csv = 'Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…,Ø§Ù„Ù…Ø¨Ù„Øº,Ø§Ù„Ø´Ø¨ÙƒØ©,ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯\\n';
      arr.forEach(t=>{
        csv += `"${t.date}",${t.number || t.local},${t.amount},${t.network},${t.confirmed ? 'Ù†Ø¹Ù…':'Ù„Ø§'}\\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'transactions_history.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    /********** Register Service Worker (PWA) **********/
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/Ban/firebase-messaging-sw.js')
        .then(()=>console.log('âœ… Firebase Messaging SW Registered'))
        .catch(err=>console.log('âŒ SW registration failed:', err));
    }

    // default amount
    amountInput.value = 25;
  </script>
</body>
</html> -->





<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙˆÙ„Ù‘Ø¯ Ø£ÙƒÙˆØ§Ø¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ â€“ Ø¨Ø§Ù† Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
  <meta name="theme-color" content="#0d9488" />
  <link rel="icon" href="/Ban/icons/icon-192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Cairo', 'Tajawal', system-ui, -apple-system, sans-serif;
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    :root {
      --bg-start: #f0f9ff;
      --bg-end: #ecfdf5;
      --card-bg: #ffffff;
      --text: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --primary: #0d9488;
      --primary-hover: #0f766e;
      --shadow: rgba(0, 0, 0, 0.1);
    }
    
    .dark {
      --bg-start: #0f172a;
      --bg-end: #1e293b;
      --card-bg: #1e293b;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #334155;
      --shadow: rgba(0, 0, 0, 0.3);
    }
    
    body {
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text);
      min-height: 100vh;
    }
    
    .card {
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 10px 40px var(--shadow);
      border: 1px solid var(--border);
    }
    
    .btn {
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
    }
    
    .btn:active {
      transform: translateY(2px) scale(0.98);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
    }
    
    .btn-primary:hover {
      box-shadow: 0 6px 16px rgba(13, 148, 136, 0.4);
    }
    
    .network-btn {
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      font-weight: 600;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .network-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(20, 184, 166, 0.1) 0%, rgba(13, 148, 136, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .network-btn:hover::before {
      opacity: 1;
    }
    
    .network-active {
      border-color: #14b8a6;
      background: linear-gradient(135deg, rgba(20, 184, 166, 0.15) 0%, rgba(13, 148, 136, 0.15) 100%);
      color: #0d9488;
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.2);
    }
    
    .network-active::after {
      content: 'âœ“';
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      background: #14b8a6;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    input, select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      font-size: 15px;
      transition: all 0.2s ease;
      font-family: 'Cairo', sans-serif;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #14b8a6;
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }
    
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 24px;
      max-width: 900px;
      width: 95%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }
    
    th {
      background: linear-gradient(135deg, rgba(20, 184, 166, 0.1) 0%, rgba(13, 148, 136, 0.1) 100%);
      padding: 12px 16px;
      text-align: right;
      font-weight: 700;
      color: var(--text);
      border-radius: 8px;
    }
    
    td {
      padding: 12px 16px;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }
    
    td:first-child {
      border-right: 1px solid var(--border);
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    td:last-child {
      border-left: 1px solid var(--border);
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }
    
    .badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      display: inline-block;
    }
    
    .confirmed {
      background: #dcfce7;
      color: #166534;
    }
    
    .pending {
      background: #fef3c7;
      color: #92400e;
    }
    
    .result-box {
      background: linear-gradient(135deg, rgba(20, 184, 166, 0.05) 0%, rgba(13, 148, 136, 0.05) 100%);
      border: 2px solid #14b8a6;
      border-radius: 16px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .code-display {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 16px;
      font-weight: bold;
      color: #0d9488;
      text-align: center;
      letter-spacing: 1px;
      margin: 12px 0;
    }
    
    .icon-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      border: 2px solid var(--border);
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .icon-btn:hover {
      border-color: #14b8a6;
      transform: translateY(-2px);
    }
    
    @media (max-width: 768px) {
      .modal-card {
        padding: 16px;
        width: 98%;
      }
      
      table {
        font-size: 13px;
      }
      
      th, td {
        padding: 8px;
      }
    }
  </style>

  <script>
    const userLang = navigator.language || navigator.userLanguage || 'ar';
    const manifest = document.createElement('link');
    manifest.rel = 'manifest';
    manifest.href = userLang.startsWith('ar') ? '/Ban/manifest-ar.json?v=1' : '/Ban/manifest-en.json?v=1';
    document.head.appendChild(manifest);
  </script>
</head>

<body class="min-h-screen p-4 md:p-6">
  <div class="max-w-5xl mx-auto">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6 card p-4">
      <div class="flex items-center gap-4">
        <img src="https://moslimtech.github.io/Ban/icons/icon-192.png" alt="logo" class="w-14 h-14 rounded-xl shadow-lg" />
        <div>
          <h1 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-emerald-600">Ù…ÙˆÙ„Ù‘Ø¯ Ø£ÙƒÙˆØ§Ø¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø´</h1>
          <p class="text-sm" style="color: var(--text-muted)">Ø¨Ø§Ù† Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª â€¢ Ø³Ù‡Ù„ â€¢ Ø³Ø±ÙŠØ¹ â€¢ Ø¢Ù…Ù†</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="themeToggle" class="icon-btn">ğŸŒ—</button>
        <a href="https://moslimtech.github.io/Ban/" class="icon-btn">ğŸ“¢</a>
      </div>
    </header>

    <!-- Main Form -->
    <main class="card p-6">
      <form id="cashForm" class="space-y-6">
        <!-- Phone & Amount -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-2" style="color: var(--text-muted)">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
            <div class="flex gap-2">
              <input id="phoneInput" type="tel" inputmode="tel" placeholder="01xxxxxxxxx" class="flex-1" />
              <button type="button" id="pickContactBtn" class="btn btn-primary px-4 rounded-xl">
                ğŸ‘¤
              </button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2" style="color: var(--text-muted)">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬Ù†ÙŠÙ‡)</label>
            <input id="amountInput" type="number" min="1" placeholder="25" />
          </div>
        </div>

        <!-- Network Selection -->
        <div>
          <label class="block text-sm font-semibold mb-3" style="color: var(--text-muted)">ğŸ“¶ Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¨ÙƒØ©</label>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
            <button type="button" data-net="vodafone" class="network-btn">ğŸ”´ ÙÙˆØ¯Ø§ÙÙˆÙ†</button>
            <button type="button" data-net="etisalat" class="network-btn">ğŸŸ¢ Ø§ØªØµØ§Ù„Ø§Øª</button>
            <button type="button" data-net="orange" class="network-btn">ğŸŸ  Ø£ÙˆØ±Ø§Ù†Ø¬</button>
            <button type="button" data-net="we" class="network-btn">ğŸŸ£ ÙˆÙŠ</button>
            <button type="button" data-net="instapay" class="network-btn">ğŸ’³ Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ</button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap items-center gap-3">
          <button id="generateBtn" type="button" class="btn btn-primary px-6 py-3 rounded-xl flex-1 md:flex-none">
            ğŸš€ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù†
          </button>
          <button id="previewBtn" type="button" class="btn px-6 py-3 rounded-xl" style="background: var(--card-bg); border: 2px solid var(--border);">
            ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø©
          </button>
          <button id="historyBtn" type="button" class="btn px-6 py-3 rounded-xl" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
            ğŸ“œ Ø§Ù„Ø³Ø¬Ù„
          </button>
        </div>

        <!-- Result Box -->
        <div id="resultBox" class="hidden result-box">
          <div class="flex items-start justify-between flex-wrap gap-4">
            <div class="flex-1 min-w-[250px]">
              <p class="text-sm font-semibold mb-2" style="color: var(--text-muted)">âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­</p>
              <div id="resultText" class="code-display"></div>
              
              <div class="flex flex-wrap gap-2 mt-4">
                <button id="copyBtn" class="btn px-4 py-2 rounded-lg" style="background: #0ea5e9; color: white;">ğŸ“‹ Ù†Ø³Ø®</button>
                <a id="openLinkBtn" class="btn px-4 py-2 rounded-lg" href="#" style="background: #10b981; color: white;">ğŸ”— ÙØªØ­</a>
                <a id="whatsappBtn" class="btn px-4 py-2 rounded-lg" href="#" style="background: #25d366; color: white;">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a>
              </div>
            </div>
            
            <div class="text-sm" style="color: var(--text-muted)">
              <div class="mb-2">ğŸŒ Ø§Ù„Ø´Ø¨ÙƒØ©: <strong id="showNetwork">-</strong></div>
              <div class="px-4 py-2 rounded-lg" style="background: rgba(20, 184, 166, 0.1);">
                ğŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¤ÙƒØ¯: <strong id="totalConfirmed" style="color: #0d9488;">0</strong> Ø¬
              </div>
            </div>
          </div>
        </div>
      </form>
    </main>

    <footer class="mt-6 text-center text-sm" style="color: var(--text-muted)">
      Â© 2025 Ø¨Ø§Ù† Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
    </footer>
  </div>

  <!-- History Modal -->
  <div id="historyBackdrop" class="modal-backdrop hidden">
    <div class="modal-card">
      <div class="flex items-center justify-between mb-4 pb-4" style="border-bottom: 2px solid var(--border);">
        <h3 class="font-bold text-xl">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h3>
        <div class="flex gap-2">
          <button id="downloadCsvBtn" class="btn px-3 py-2 rounded-lg" style="background: #3b82f6; color: white;" title="ØªØ­Ù…ÙŠÙ„ CSV">ğŸ“¥</button>
          <button id="clearHistoryBtn" class="btn px-3 py-2 rounded-lg" style="background: #ef4444; color: white;" title="Ø­Ø°Ù Ø§Ù„ÙƒÙ„">ğŸ—‘ï¸</button>
          <button id="closeHistoryBtn" class="btn px-3 py-2 rounded-lg" style="border: 2px solid var(--border);">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div id="historyStats" class="mb-4 p-4 rounded-lg" style="background: rgba(20, 184, 166, 0.1);"></div>

      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>ğŸ“± Ø§Ù„Ø±Ù‚Ù…</th>
              <th>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>ğŸ“¶ Ø§Ù„Ø´Ø¨ÙƒØ©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="historyTbody"></tbody>
        </table>
      </div>

      <div class="mt-6 pt-4 text-lg font-bold text-center" style="border-top: 2px solid var(--border);">
        ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¤ÙƒØ¯: <span id="modalTotalConfirmed" style="color: #0d9488;">0</span> Ø¬Ù†ÙŠÙ‡
      </div>
    </div>
  </div>

  <script>
    /********** Configuration **********/
    const templates = {
      vodafone: (localPhone, amount) => `*9*7*${localPhone}*${amount}#`,
      etisalat: (localPhone, amount) => `*777*${localPhone}*${amount}#`,
      orange: (localPhone, amount) => `*115*1*${localPhone}*${amount}#`,
      we: (localPhone, amount) => `*322*${localPhone}*${amount}#`,
      instapayDeep: (phone, amount) => `instapay://pay?recipient=${phone}&amount=${amount}`,
      instapayWeb: (phone, amount) => `https://ipn.eg/S/instapay?recipient=${phone}&amount=${amount}`
    };

    /********** Elements **********/
    const phoneInput = document.getElementById('phoneInput');
    const amountInput = document.getElementById('amountInput');
    const networkButtons = document.querySelectorAll('.network-btn');
    const generateBtn = document.getElementById('generateBtn');
    const previewBtn = document.getElementById('previewBtn');
    const historyBtn = document.getElementById('historyBtn');
    const resultBox = document.getElementById('resultBox');
    const resultText = document.getElementById('resultText');
    const copyBtn = document.getElementById('copyBtn');
    const openLinkBtn = document.getElementById('openLinkBtn');
    const whatsappBtn = document.getElementById('whatsappBtn');
    const showNetwork = document.getElementById('showNetwork');
    const totalConfirmedSpan = document.getElementById('totalConfirmed');
    const pickContactBtn = document.getElementById('pickContactBtn');
    const historyBackdrop = document.getElementById('historyBackdrop');
    const historyTbody = document.getElementById('historyTbody');
    const historyStats = document.getElementById('historyStats');
    const closeHistoryBtn = document.getElementById('closeHistoryBtn');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const modalTotalConfirmed = document.getElementById('modalTotalConfirmed');
    const themeToggle = document.getElementById('themeToggle');

    let selectedNetwork = 'vodafone';

    /********** Theme **********/
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    function applyTheme(t) {
      if (t === 'dark') {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme','dark');
        themeToggle.textContent = 'â˜€ï¸';
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme','light');
        themeToggle.textContent = 'ğŸŒ™';
      }
    }
    const saved = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
    applyTheme(saved);
    
    themeToggle.addEventListener('click', () => {
      const now = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(now);
    });

    /********** Network selection **********/
    function markSelected() {
      networkButtons.forEach(b => {
        if (b.dataset.net === selectedNetwork) b.classList.add('network-active');
        else b.classList.remove('network-active');
      });
    }
    networkButtons.forEach(btn => btn.addEventListener('click', () => { 
      selectedNetwork = btn.dataset.net; 
      markSelected(); 
    }));
    markSelected();

    /********** Contact picker **********/
    pickContactBtn.addEventListener('click', async () => {
      try {
        if (navigator.contacts && navigator.contacts.select) {
          const props = ['tel','name'];
          const opts = { multiple:false };
          const contacts = await navigator.contacts.select(props, opts);
          if (contacts && contacts.length) {
            const tel = (contacts[0].tel && contacts[0].tel[0]) || '';
            phoneInput.value = tel.replace(/\s|-|\(|\)/g,'');
            return;
          }
        }
        phoneInput.focus();
        alert('Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹.');
      } catch(e) {
        console.error(e);
        phoneInput.focus();
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹.');
      }
    });

    /********** Helpers **********/
    function onlyDigits(s=''){ return String(s||'').replace(/[^0-9]/g,''); }
    function toLocal(cleaned) {
      if (!cleaned) return '';
      if (cleaned.startsWith('20')) return '0' + cleaned.slice(2);
      if (cleaned.startsWith('2') && cleaned.length===11) return '0' + cleaned.slice(1);
      if (cleaned.startsWith('0')) return cleaned;
      if (cleaned.length === 9) return '0' + cleaned;
      return cleaned;
    }
    function toInternational(cleaned) {
      if (!cleaned) return '';
      if (cleaned.startsWith('0')) return '2' + cleaned.slice(1);
      if (cleaned.startsWith('20')) return cleaned;
      if (cleaned.startsWith('2') && cleaned.length>2) return cleaned;
      return cleaned;
    }

    /********** Build action links **********/
    function buildActionLink(network, phoneRaw, amountRaw) {
      const cleaned = onlyDigits(phoneRaw);
      const amount = Number(amountRaw) || 0;
      if (!cleaned || amount <= 0) return null;

      const local = toLocal(cleaned);
      const intl = toInternational(cleaned);

      if (network === 'instapay') {
        return { type:'instapay', deep: templates.instapayDeep(intl, amount), web: templates.instapayWeb(intl, amount), local, intl, amount };
      }

      const code = templates[network](local, amount);
      return { type:'ussd', url: 'tel:' + encodeURIComponent(code), code: code, local, intl, amount };
    }

    /********** History **********/
    const STORAGE_KEY = 'ban_cash_transactions_v1';
    function loadHistory() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch(e){ return []; }
    }
    function saveHistory(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
    function addHistoryItem(item) {
      const arr = loadHistory();
      arr.unshift(item);
      if (arr.length > 500) arr.pop();
      saveHistory(arr);
    }
    function clearHistory() { localStorage.removeItem(STORAGE_KEY); }

    /********** UI: show result **********/
    function showResult(obj) {
      resultBox.classList.remove('hidden');
      
      const networkNames = {
        vodafone: 'ÙÙˆØ¯Ø§ÙÙˆÙ† ğŸ”´',
        etisalat: 'Ø§ØªØµØ§Ù„Ø§Øª ğŸŸ¢',
        orange: 'Ø£ÙˆØ±Ø§Ù†Ø¬ ğŸŸ ',
        we: 'ÙˆÙŠ ğŸŸ£',
        instapay: 'Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ ğŸ’³'
      };
      
      if (obj.type === 'instapay') {
        resultText.textContent = obj.web;
        openLinkBtn.href = obj.deep;
        openLinkBtn.setAttribute('data-fallback', obj.web);
      } else {
        resultText.textContent = obj.code;
        openLinkBtn.href = obj.url;
        openLinkBtn.removeAttribute('data-fallback');
      }
      
      showNetwork.textContent = networkNames[selectedNetwork] || selectedNetwork;
      whatsappBtn.href = 'https://wa.me/' + obj.intl;
      updateTotalsDisplay();
    }

    generateBtn.addEventListener('click', () => {
      const phone = phoneInput.value.trim();
      const amount = amountInput.value.trim();
      const obj = buildActionLink(selectedNetwork, phone, amount);
      
      if (!obj) { 
        alert('âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ§Ù„Ø­ ÙˆØ§Ù„Ù…Ø¨Ù„Øº.'); 
        return; 
      }

      const now = new Date();
      addHistoryItem({ 
        number: onlyDigits(phone), 
        local: obj.local, 
        intl: obj.intl, 
        amount: obj.amount, 
        network: selectedNetwork, 
        date: now.toLocaleString('ar-EG'), 
        confirmed: false 
      });

      showResult(obj);

      if (obj.type === 'instapay') {
        try { window.location.href = obj.deep; } catch(_) {}
        setTimeout(() => { window.location.href = obj.web; }, 1200);
      } else {
        try { window.location.href = obj.url; } catch(e){ console.error(e); }
      }
    });

    openLinkBtn.addEventListener('click', (e) => {
      const href = openLinkBtn.href;
      const fallback = openLinkBtn.getAttribute('data-fallback');
      if (!fallback) return;
      e.preventDefault();
      try { window.location.href = href; } catch(e){ console.error(e); }
      setTimeout(() => { window.location.href = fallback; }, 1200);
    });

    previewBtn.addEventListener('click', () => {
      const phone = phoneInput.value.trim();
      const amount = amountInput.value.trim();
      const obj = buildActionLink(selectedNetwork, phone, amount);
      if (!obj) { alert('âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ§Ù„Ø­ ÙˆØ§Ù„Ù…Ø¨Ù„Øº.'); return; }
      showResult(obj);
    });

    copyBtn.addEventListener('click', async () => {
      const txt = resultText.textContent || '';
      try {
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = 'âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®';
        copyBtn.style.background = '#10b981';
        setTimeout(() => {
          copyBtn.textContent = 'ğŸ“‹ Ù†Ø³Ø®';
          copyBtn.style.background = '#0ea5e9';
        }, 2000);
      } catch (e) {
        alert('Ù†Ø³Ø® ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹.');
      }
    });

    /********** History modal **********/
    historyBtn.addEventListener('click', () => { 
      renderHistory(); 
      historyBackdrop.classList.remove('hidden'); 
    });
    
    closeHistoryBtn.addEventListener('click', () => { 
      historyBackdrop.classList.add('hidden'); 
    });

    clearHistoryBtn.addEventListener('click', () => {
      if (!confirm('âš ï¸ Ù‡Ù„ Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§ØªØŸ
\<Streaming stoppped because the conversation grew too long for this model\>
