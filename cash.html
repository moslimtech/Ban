<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© â€“ Ø¨Ø§Ù† Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
  <meta name="theme-color" content="#1e293b" />
  <link rel="icon" href="https://moslimtech.github.io/Ban/icons/icon-192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* --- CSS Section (No major changes) --- */
    body { font-family: 'Tajawal', system-ui, -apple-system, 'Segoe UI', Roboto, Arial; }
    .btn-anim { transition: transform .12s ease, box-shadow .12s ease, background-color .2s ease, border-color .2s ease; }
    .btn-anim:active { transform: translateY(1px) scale(.995); }
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:60; backdrop-filter: blur(4px); }
    .modal-card { width:95%; max-width:880px; max-height:85vh; overflow:auto; border-radius:12px; padding:16px; background:var(--card-bg); }
    :root {
      --bg: #f0f9ff; --card-bg: rgba(255, 255, 255, 0.95); --text: #0f172a; --muted: #475569; --border-color: #e5e7eb; --input-bg: #ffffff; --input-border: #d1d5db; --focus-border: #3b82f6; --tab-active-bg: #ffffff; --tab-inactive-text: #6b7280;
    }
    .dark {
      --bg: #0f172a; --card-bg: rgba(30, 41, 59, 0.7); --text: #e2e8f0; --muted: #94a3b8; --border-color: rgba(255, 255, 255, 0.1); --input-bg: rgba(51, 65, 85, 0.5); --input-border: rgba(255, 255, 255, 0.15); --focus-border: #38bdf8; --tab-active-bg: rgba(51, 65, 85, 0.6); --tab-inactive-text: #94a3b8;
    }
    body { background: var(--bg); color: var(--text); }
    .muted { color: var(--muted); }
    .main-card { background: var(--card-bg); border: 1px solid var(--border-color); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); backdrop-filter: blur(12px); border-radius: 16px; }
    input, select { background-color: var(--input-bg); border-color: var(--input-border); color: var(--text); }
    input:focus, select:focus { border-color: var(--focus-border); box-shadow: 0 0 0 3px var(--focus-border-shadow, rgba(59, 130, 246, 0.2)); }
    .dark input:focus, .dark select:focus { --focus-border-shadow: rgba(56, 189, 248, 0.2); }
    .dark .network-btn { background-color: rgba(51, 65, 85, 0.3); }
    .network-active { background: rgba(34, 197, 94, 0.12); border-color: #22c55e; }
    .dark .network-active { background: rgba(56, 189, 248, 0.1); border-color: var(--focus-border); box-shadow: 0 0 12px rgba(56, 189, 248, 0.3); }
    .badge { padding:6px 8px; border-radius:8px; font-size:13px; }
    .confirmed { background: #dcfce7; color:#166534; }
    .pending { background: #fff7ed; color:#92400e; }
    .received { background: #dbeafe; color:#1e40af; }
    .dark .confirmed { background: rgba(74, 222, 128, 0.15); color: #a7f3d0; }
    .dark .pending { background: rgba(251, 191, 36, 0.15); color: #fde68a; }
    .dark .received { background: rgba(96, 165, 250, 0.15); color: #bfdbfe; }
    .dark .received-item { background-color: rgba(56, 189, 248, 0.05); }
    th, td { border-bottom: 1px solid var(--border-color); padding:8px 10px; text-align:right; font-size:14px; }
    table { width:100%; border-collapse: collapse; }
    .color-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 8px; vertical-align: middle; }
    .instapay-icon { display: inline-flex; align-items: center; margin-left: 8px; vertical-align: middle; }
    .instapay-stripe { width: 8px; height: 10px; }
    .instapay-stripe:first-child { background-color: #facc15; }
    .instapay-stripe:last-child { background-color: #0f172a; }
    .dark .instapay-stripe:last-child { background-color: #e2e8f0; }
    .network-btn { flex-direction: row-reverse; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 sm:p-6">
  <div class="max-w-4xl w-full">
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-4">
        <img src="https://moslimtech.github.io/Ban/icons/icon-192.png" alt="logo" class="w-12 h-12 rounded-lg shadow" />
        <div>
          <h1 class="text-lg font-bold">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h1>
          <p class="text-sm muted">Ø¨Ø§Ù† Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a href="https://moslimtech.github.io/Ban/" class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-orange-100 dark:bg-slate-700 shadow btn-anim hover:shadow-md text-xl">ğŸ </a>
        <button id="themeToggle" class="w-10 h-10 rounded-full border border-slate-200 dark:border-slate-600 btn-anim flex items-center justify-center text-xl">ğŸŒ—</button>
        <button id="settingsBtn" class="w-10 h-10 rounded-full border border-slate-200 dark:border-slate-600 btn-anim flex items-center justify-center text-xl">âš™ï¸</button>
      </div>
    </header>

    <main class="main-card">
      <div class="flex border-b" style="border-color: var(--border-color);">
        <button id="sendTabBtn" class="tab-btn flex-1 py-3 px-4 text-sm font-semibold transition-colors duration-200">ØªØ­ÙˆÙŠÙ„ Ø£Ù…ÙˆØ§Ù„</button>
        <button id="receiveTabBtn" class="tab-btn flex-1 py-3 px-4 text-sm font-semibold transition-colors duration-200">ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ„Ø§Ù…</button>
      </div>
      <div class="p-5 sm:p-6">
        <!-- Ù„ÙˆØ­Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ù…ÙˆØ§Ù„ (Ù…ÙØ­Ø¯Ø«Ø©) -->
        <div id="sendPanel" class="tab-panel space-y-6">
          <div>
              <label for="sendWalletSelector" class="block text-sm font-medium muted mb-1">Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù† Ù…Ø­ÙØ¸Ø©:</label>
              <select id="sendWalletSelector" class="w-full px-3 py-2 rounded-lg border focus:outline-none"></select>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium muted mb-1">Ø¥Ù„Ù‰ Ø±Ù‚Ù… (Ø§Ù„Ù…Ø³ØªÙ„Ù…):</label>
              <div class="flex gap-2 items-center">
                <button type="button" id="pickContactBtn" class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-emerald-500 text-white btn-anim hover:bg-emerald-600 text-lg">ğŸ‘¤</button>
                <input id="phoneInput" type="tel" inputmode="tel" placeholder="01xxxxxxxxx" class="flex-1 px-3 py-2 rounded-lg border focus:outline-none" />
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium muted mb-1">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬Ù†ÙŠÙ‡)</label>
              <input id="amountInput" type="number" min="1" placeholder="25" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium muted mb-2">Ø¹Ø¨Ø± Ø´Ø¨ÙƒØ©:</label>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
              <button type="button" data-net="vodafone" class="network-btn px-3 py-2 rounded-lg border bg-white dark:bg-transparent flex items-center justify-center btn-anim">
                  <span class="color-dot" style="background-color: #ef4444;"></span>ÙÙˆØ¯Ø§ÙÙˆÙ†
              </button>
              <button type="button" data-net="etisalat" class="network-btn px-3 py-2 rounded-lg border bg-white dark:bg-transparent flex items-center justify-center btn-anim">
                <span class="color-dot" style="background-color: #22c55e;"></span>Ø§ØªØµØ§Ù„Ø§Øª
              </button>
              <button type="button" data-net="orange" class="network-btn px-3 py-2 rounded-lg border bg-white dark:bg-transparent flex items-center justify-center btn-anim">
                  <span class="color-dot" style="background-color: #f97316;"></span>Ø§ÙˆØ±Ø§Ù†Ø¬
              </button>
              <button type="button" data-net="we" class="network-btn px-3 py-2 rounded-lg border bg-white dark:bg-transparent flex items-center justify-center btn-anim">
                  <span class="color-dot" style="background-color: #8b5cf6;"></span>ÙˆÙŠ
              </button>
              <button type="button" data-net="instapay" class="network-btn px-3 py-2 rounded-lg border bg-white dark:bg-transparent flex items-center justify-center btn-anim">
                  <span class="instapay-icon"><span class="instapay-stripe"></span><span class="instapay-stripe"></span></span>Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ
              </button>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-3 justify-end pt-2">
            <button id="previewBtn" type="button" class="px-4 py-2 rounded-xl bg-white dark:bg-slate-700 border dark:border-slate-600 font-medium btn-anim hover:shadow flex items-center gap-2">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
            <button id="generateBtn" type="button" class="px-4 py-2 rounded-xl bg-teal-500 text-white font-semibold shadow-lg btn-anim hover:bg-teal-600 flex items-center gap-2">ğŸš€ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù†</button>
          </div>
        </div>

        <!-- Ù„ÙˆØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ù…ÙØ­Ø¯Ø«Ø©) -->
        <div id="receivePanel" class="tab-panel hidden space-y-4">
            <div>
              <label for="receiveWalletSelector" class="block text-sm font-medium muted mb-1">Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙÙŠ Ù…Ø­ÙØ¸Ø©:</label>
              <select id="receiveWalletSelector" class="w-full px-3 py-2 rounded-lg border focus:outline-none"></select>
            </div>
            <div>
              <label class="block text-sm font-medium muted mb-1">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù… (Ø¬Ù†ÙŠÙ‡)</label>
              <input id="receivedAmountInput" type="number" min="1" placeholder="Ù…Ø«Ø§Ù„: 100" class="w-full px-3 py-2 text-lg rounded-lg border focus:outline-none" />
            </div>
            <button id="recordReceivedBtn" type="button" class="w-full px-4 py-2 rounded-xl bg-blue-500 text-white font-semibold shadow-lg btn-anim hover:bg-blue-600 flex items-center justify-center gap-2">ğŸ“¥ ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ„Ø§Ù…</button>
        </div>
      </div>
      
      <div class="text-center p-4 border-t" style="border-color: var(--border-color);">
        <button id="historyBtn" type="button" class="px-4 py-2 rounded-xl bg-amber-100 dark:bg-amber-900/50 text-amber-800 dark:text-amber-300 font-medium btn-anim hover:shadow flex items-center gap-2 mx-auto">
          <span class="text-lg">ğŸ“œ</span> Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
        </button>
      </div>
    </main>

    <footer class="mt-4 text-center text-xs muted">Â© 2025 Ø¨Ø§Ù† Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</footer>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø¬Ù„ (Ù…ÙØ­Ø¯Ø«Ø©) -->
  <div id="historyBackdrop" class="modal-backdrop hidden">
    <div class="modal-card" role="dialog" aria-modal="true">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h3>
            <button id="closeHistoryBtn" class="px-3 py-2 bg-gray-200 dark:bg-slate-600 rounded-lg text-sm">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        <div id="historyStats" class="mb-3 text-sm muted"></div>
        <div id="historyTableWrapper" class="overflow-auto">
            <table id="historyTable">
              <thead>
                <tr>
                  <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
                  <th>ğŸ“± Ø¥Ù„Ù‰/Ù…Ù†</th>
                  <th>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ø§Ù„Ø±Ø¨Ø­</th>
                  <th>ğŸ“¶ Ø§Ù„Ø´Ø¨ÙƒØ©</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="historyTbody"></tbody>
            </table>
        </div>
        <div class="mt-4 text-right">
            <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: <span id="modalTotalProfit">0</span> Ø¬Ù†ÙŠÙ‡</strong>
        </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù„Ù… ØªØªØºÙŠØ±) -->
  <div id="settingsBackdrop" class="modal-backdrop hidden">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
        <button id="closeSettingsBtn" class="px-3 py-2 bg-gray-200 dark:bg-slate-600 rounded-lg text-sm">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="space-y-4">
        <div>
          <label for="profitMarginInput" class="block text-sm font-medium muted mb-1">Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ (%)</label>
          <input id="profitMarginInput" type="number" step="0.1" min="0" placeholder="Ù…Ø«Ø§Ù„: 2" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
          <p class="text-xs muted mt-1">Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø¨Ø© Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­.</p>
        </div>
        <hr class="dark:border-slate-700"/>
        <div>
          <h4 class="font-semibold mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸ (Ø£Ø±Ù‚Ø§Ù…Ùƒ)</h4>
          <div id="walletsList" class="space-y-2 mb-4"></div>
          <div class="p-4 rounded-lg bg-slate-50 dark:bg-slate-800/50 border dark:border-slate-700">
            <h5 class="font-semibold mb-3">Ø¥Ø¶Ø§ÙØ© Ù…Ø­ÙØ¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
            <form id="addWalletForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label for="walletNumber" class="block text-xs font-medium muted mb-1">Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©</label>
                <input id="walletNumber" type="tel" required placeholder="01xxxxxxxxx" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
              </div>
              <div>
                <label for="walletAlias" class="block text-xs font-medium muted mb-1">Ø§Ø³Ù… Ù…Ù…ÙŠØ² (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="walletAlias" type="text" placeholder="ÙÙˆØ¯Ø§ÙÙˆÙ† Ø´Ø®ØµÙŠ" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
              </div>
              <div>
                <label for="walletBalance" class="block text-xs font-medium muted mb-1">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ (Ø¬)</label>
                <input id="walletBalance" type="number" required value="0" min="0" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
              </div>
              <div>
                <label for="walletLimit" class="block text-xs font-medium muted mb-1">Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Ø´Ù‡Ø±ÙŠ)</label>
                <input id="walletLimit" type="number" required value="100" min="1" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
              </div>
              <div class="sm:col-span-2">
                <button type="submit" class="w-full px-4 py-2 rounded-xl bg-blue-500 text-white font-semibold btn-anim hover:bg-blue-600">
                  + Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­ÙØ¸Ø©
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- JavaScript Logic (Updated) ---

    // --- Element Definitions ---
    const settingsBtn = document.getElementById('settingsBtn'), settingsBackdrop = document.getElementById('settingsBackdrop'), closeSettingsBtn = document.getElementById('closeSettingsBtn'), profitMarginInput = document.getElementById('profitMarginInput'), addWalletForm = document.getElementById('addWalletForm'), walletsList = document.getElementById('walletsList');
    const sendTabBtn = document.getElementById('sendTabBtn'), receiveTabBtn = document.getElementById('receiveTabBtn'), sendPanel = document.getElementById('sendPanel'), receivePanel = document.getElementById('receivePanel');
    const historyBtn = document.getElementById('historyBtn'), themeToggle = document.getElementById('themeToggle');
    const sendWalletSelector = document.getElementById('sendWalletSelector'), receiveWalletSelector = document.getElementById('receiveWalletSelector'), phoneInput = document.getElementById('phoneInput'), amountInput = document.getElementById('amountInput'), networkButtons = document.querySelectorAll('.network-btn');
    const generateBtn = document.getElementById('generateBtn'), previewBtn = document.getElementById('previewBtn'), receivedAmountInput = document.getElementById('receivedAmountInput'), recordReceivedBtn = document.getElementById('recordReceivedBtn'), pickContactBtn = document.getElementById('pickContactBtn');
    const historyBackdrop = document.getElementById('historyBackdrop'), historyTbody = document.getElementById('historyTbody'), historyStats = document.getElementById('historyStats'), closeHistoryBtn = document.getElementById('closeHistoryBtn'), modalTotalProfit = document.getElementById('modalTotalProfit');
    let selectedNetwork = 'vodafone';

    // --- Database Management ---
    const DB_KEY = 'ban_pos_database_v1';
    const defaultDB = { settings: { profitMargin: 2.0 }, wallets: [], transactions: [] };
    function loadDB() { return JSON.parse(localStorage.getItem(DB_KEY) || JSON.stringify(defaultDB)); }
    function saveDB(db) { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    
    // --- Utility Functions ---
    function getWalletCalculations(wallet, allTransactions) {
        const walletTransactions = allTransactions.filter(t => t.sourceWalletId === wallet.id);
        const sent = walletTransactions.filter(t => t.type === 'sent').reduce((sum, t) => sum + t.amount, 0);
        const received = walletTransactions.filter(t => t.type === 'received').reduce((sum, t) => sum + t.amount, 0);
        const currentBalance = wallet.openingBalance - sent + received;
        return { txCount: walletTransactions.length, currentBalance };
    }
    function onlyDigits(value = '') { return String(value || '').replace(/[^0-9]/g, ''); }
    const templates = { vodafone: (p, a) => `*9*7*${p}*${a}#`, etisalat: (p, a) => `*777*${p}*${a}#`, orange: (p, a) => `*115*1*${p}*${a}#`, we: (p, a) => `*322*${p}*${a}#` };
    const networkLabels = { vodafone: 'ÙÙˆØ¯Ø§ÙÙˆÙ†', etisalat: 'Ø§ØªØµØ§Ù„Ø§Øª', orange: 'Ø£ÙˆØ±Ø§Ù†Ø¬', we: 'ÙˆÙŠ', instapay: 'Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ', received_cash: 'Ø§Ø³ØªÙ„Ø§Ù… Ù†Ù‚Ø¯ÙŠ' };
    
    // --- Settings Modal Logic ---
    settingsBtn.addEventListener('click', () => { settingsBackdrop.classList.remove('hidden'); loadSettingsIntoUI(); });
    closeSettingsBtn.addEventListener('click', () => { settingsBackdrop.classList.add('hidden'); populateWalletSelectors(); });
    profitMarginInput.addEventListener('change', () => {
        const db = loadDB();
        const newMargin = parseFloat(profitMarginInput.value);
        if (!isNaN(newMargin) && newMargin >= 0) { db.settings.profitMargin = newMargin; saveDB(db); } 
        else { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Ø³Ø¨Ø© Ø±Ø¨Ø­ ØµØ§Ù„Ø­Ø©.'); profitMarginInput.value = db.settings.profitMargin; }
    });
    addWalletForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const number = document.getElementById('walletNumber').value.trim(), alias = document.getElementById('walletAlias').value.trim(), balance = parseFloat(document.getElementById('walletBalance').value), limit = parseInt(document.getElementById('walletLimit').value);
        if (!number || isNaN(balance) || isNaN(limit)) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.'); return; }
        const db = loadDB();
        if (db.wallets.some(w => w.id === number)) { alert('Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ø§Ù„Ø±Ù‚Ù…) Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„.'); return; }
        db.wallets.push({ id: number, alias: alias, openingBalance: balance, limit: limit });
        saveDB(db);
        addWalletForm.reset();
        renderWalletsList();
    });
    function loadSettingsIntoUI() { const db = loadDB(); profitMarginInput.value = db.settings.profitMargin; renderWalletsList(); }
    function renderWalletsList() {
        const db = loadDB();
        walletsList.innerHTML = '';
        if (db.wallets.length === 0) { walletsList.innerHTML = `<p class="text-sm muted text-center">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ø­Ø§ÙØ¸ Ø¨Ø¹Ø¯.</p>`; return; }
        db.wallets.forEach(wallet => {
            const { currentBalance, txCount } = getWalletCalculations(wallet, db.transactions);
            const walletEl = document.createElement('div');
            walletEl.className = 'flex items-center justify-between p-2 rounded-lg bg-slate-100 dark:bg-slate-800';
            walletEl.innerHTML = `
                <div>
                    <p class="font-semibold">${wallet.alias || wallet.id}</p>
                    <p class="text-xs muted">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentBalance.toFixed(2)} Ø¬ | Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: ${txCount}/${wallet.limit}</p>
                </div>
                <button data-id="${wallet.id}" class="delete-wallet-btn px-2 py-1 text-xs text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50 rounded">Ø­Ø°Ù</button>`;
            walletsList.appendChild(walletEl);
        });
        walletsList.querySelectorAll('.delete-wallet-btn').forEach(btn => btn.addEventListener('click', handleDeleteWallet));
    }
    function handleDeleteWallet(e) {
        const walletId = e.target.dataset.id;
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø­ÙØ¸Ø© ${walletId}ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ ÙˆØ¬Ù…ÙŠØ¹ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙ‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`)) {
            const db = loadDB();
            db.wallets = db.wallets.filter(w => w.id !== walletId);
            db.transactions = db.transactions.filter(t => t.sourceWalletId !== walletId);
            saveDB(db);
            renderWalletsList();
        }
    }
    
    // --- Main UI Logic ---
    function populateWalletSelectors() {
        const db = loadDB();
        [sendWalletSelector, receiveWalletSelector].forEach(selector => selector.innerHTML = '');
        if (db.wallets.length === 0) {
            const defaultOption = `<option value="" disabled>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ø­ÙØ¸Ø© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸</option>`;
            [sendWalletSelector, receiveWalletSelector].forEach(selector => selector.innerHTML = defaultOption);
            return;
        }
        db.wallets.forEach(wallet => {
            const { currentBalance, txCount } = getWalletCalculations(wallet, db.transactions);
            const optionText = `${wallet.alias || wallet.id} (Ø±ØµÙŠØ¯: ${currentBalance.toFixed(2)} Ø¬ | ${txCount}/${wallet.limit})`;
            const optionHTML = `<option value="${wallet.id}">${optionText}</option>`;
            [sendWalletSelector, receiveWalletSelector].forEach(selector => selector.innerHTML += optionHTML);
        });
    }

    generateBtn.addEventListener('click', () => {
        const db = loadDB();
        const sourceWalletId = sendWalletSelector.value, recipientPhone = phoneInput.value.trim(), amount = parseFloat(amountInput.value);
        if (!sourceWalletId) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­ÙØ¸Ø© Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù†Ù‡Ø§.'); return; }
        if (!recipientPhone || isNaN(amount) || amount <= 0) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù…Ø³ØªÙ„Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­ÙŠÙ†.'); return; }
        const sourceWallet = db.wallets.find(w => w.id === sourceWalletId);
        const { currentBalance, txCount } = getWalletCalculations(sourceWallet, db.transactions);
        if (txCount >= sourceWallet.limit) { alert(`Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­ÙØ¸Ø© (${sourceWallet.limit}).`); return; }
        if (currentBalance < amount) { alert(`Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­ÙØ¸Ø© (${currentBalance.toFixed(2)} Ø¬) ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ø¥ØªÙ…Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.`); return; }
        
        const profit = amount * (db.settings.profitMargin / 100);
        const newTransaction = {
            id: Date.now(), type: 'sent', sourceWalletId: sourceWallet.id, recipient: onlyDigits(recipientPhone), amount: amount, profit: profit, network: selectedNetwork, date: new Date().toLocaleString('ar-EG'), confirmed: false
        };
        db.transactions.unshift(newTransaction);
        saveDB(db);
        populateWalletSelectors();
        
        const link = `tel:${encodeURIComponent(templates[selectedNetwork](onlyDigits(recipientPhone), amount))}`;
        if (confirm('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­. Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¢Ù† Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ØŸ')) {
            try { window.location.href = link; } catch (e) { console.error(e); alert('ÙØ´Ù„ ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§ØªØµØ§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.'); }
        }
        phoneInput.value = ''; amountInput.value = '';
    });

    recordReceivedBtn.addEventListener('click', () => {
        const db = loadDB();
        const targetWalletId = receiveWalletSelector.value, amount = parseFloat(receivedAmountInput.value);
        if (!targetWalletId) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­ÙØ¸Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙÙŠÙ‡Ø§.'); return; }
        if (isNaN(amount) || amount <= 0) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.'); return; }
        
        const profit = amount * (db.settings.profitMargin / 100);
        const newTransaction = {
            id: Date.now(), type: 'received', sourceWalletId: targetWalletId, recipient: '', amount: amount, profit: profit, network: 'received_cash', date: new Date().toLocaleString('ar-EG'), confirmed: true
        };
        db.transactions.unshift(newTransaction);
        saveDB(db);
        populateWalletSelectors();
        receivedAmountInput.value = '';
        alert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¨Ù„Øº ${amount} Ø¬Ù†ÙŠÙ‡ ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø©.`);
    });
    
    // --- History Modal Logic ---
    historyBtn.addEventListener('click', () => { renderHistory(); historyBackdrop.classList.remove('hidden'); });
    closeHistoryBtn.addEventListener('click', () => { historyBackdrop.classList.add('hidden'); });
    function renderHistory() {
        const db = loadDB();
        historyTbody.innerHTML = '';
        const totalProfit = db.transactions.reduce((sum, tx) => sum + tx.profit, 0);
        modalTotalProfit.textContent = totalProfit.toFixed(2);
        historyStats.innerHTML = `ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: <strong>${db.transactions.length}</strong>`;

        if (db.transactions.length === 0) { historyTbody.innerHTML = `<tr><td colspan="8" class="text-center muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø¹Ø¯.</td></tr>`; return; }
        db.transactions.forEach(tx => {
            const tr = document.createElement('tr');
            if (tx.type === 'received') tr.classList.add('received-item');
            const sourceWallet = db.wallets.find(w => w.id === tx.sourceWalletId);
            const statusBadge = tx.type === 'received' ? '<span class="badge received">ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span>' : (tx.confirmed ? '<span class="badge confirmed">ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„</span>' : '<span class="badge pending">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span>');
            const actions = `${tx.type === 'sent' && !tx.confirmed ? `<button data-id="${tx.id}" class="confirm-tx-btn px-2 py-1 text-xs rounded bg-emerald-500 text-white btn-anim">ØªØ£ÙƒÙŠØ¯</button>` : ''} <button data-id="${tx.id}" class="delete-tx-btn px-2 py-1 text-xs rounded bg-red-100 dark:bg-red-900/50 dark:text-red-300 ml-2 btn-anim">Ø­Ø°Ù</button>`;

            tr.innerHTML = `
                <td>${tx.date}</td>
                <td>${sourceWallet ? (sourceWallet.alias || sourceWallet.id) : 'Ù…Ø­Ø°ÙˆÙØ©'}</td>
                <td>${tx.recipient || '-'}</td>
                <td>${tx.amount.toFixed(2)}</td>
                <td>${tx.profit.toFixed(2)}</td>
                <td>${networkLabels[tx.network] || tx.network}</td>
                <td>${statusBadge}</td>
                <td class="whitespace-nowrap">${actions}</td>`;
            historyTbody.appendChild(tr);
        });
        historyTbody.querySelectorAll('.confirm-tx-btn').forEach(btn => btn.addEventListener('click', (e) => handleTxAction(e.target.dataset.id, 'confirm')));
        historyTbody.querySelectorAll('.delete-tx-btn').forEach(btn => btn.addEventListener('click', (e) => handleTxAction(e.target.dataset.id, 'delete')));
    }
    function handleTxAction(txId, action) {
        const db = loadDB();
        const txIndex = db.transactions.findIndex(t => t.id == txId);
        if (txIndex === -1) return;
        if (action === 'confirm') {
            db.transactions[txIndex].confirmed = true;
        } else if (action === 'delete') {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
                db.transactions.splice(txIndex, 1);
            }
        }
        saveDB(db);
        renderHistory();
        populateWalletSelectors(); // Update balances after action
    }

    // --- Theme & Tabs & Other Initializers ---
    function switchTab(activeTab) {
        const isSend = activeTab === 'send';
        sendPanel.classList.toggle('hidden', !isSend);
        receivePanel.classList.toggle('hidden', isSend);
        sendTabBtn.style.backgroundColor = isSend ? 'var(--tab-active-bg)' : 'transparent';
        sendTabBtn.style.color = isSend ? 'var(--text)' : 'var(--tab-inactive-text)';
        receiveTabBtn.style.backgroundColor = !isSend ? 'var(--tab-active-bg)' : 'transparent';
        receiveTabBtn.style.color = !isSend ? 'var(--text)' : 'var(--tab-inactive-text)';
    }
    sendTabBtn.addEventListener('click', () => switchTab('send'));
    receiveTabBtn.addEventListener('click', () => switchTab('receive'));
    function applyTheme(mode) {
        document.documentElement.classList.toggle('dark', mode === 'dark');
        localStorage.setItem('theme', mode);
        switchTab(sendPanel.classList.contains('hidden') ? 'receive' : 'send');
    }
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedTheme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
    applyTheme(savedTheme);
    themeToggle.addEventListener('click', () => {
        const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(newTheme);
        themeToggle.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    });
    themeToggle.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    function markSelected() { networkButtons.forEach(btn => btn.classList.toggle('network-active', btn.dataset.net === selectedNetwork)); }
    networkButtons.forEach(btn => btn.addEventListener('click', () => { selectedNetwork = btn.dataset.net; markSelected(); }));

    // Initial App Load
    document.addEventListener('DOMContentLoaded', () => {
      markSelected();
      switchTab('send');
      populateWalletSelectors();
    });
  </script>
</body>
</html>
