<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مدير المعاملات المالية – بان للإعلانات</title>
  <meta name="theme-color" content="#1e293b" />
  <link rel="icon" href="https://moslimtech.github.io/Ban/icons/icon-192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* --- CSS Section --- */
    body { font-family: 'Tajawal', system-ui, -apple-system, 'Segoe UI', Roboto, Arial; }
    .btn-anim { transition: transform .12s ease, box-shadow .12s ease, background-color .2s ease, border-color .2s ease; }
    .btn-anim:active { transform: translateY(1px) scale(.995); }
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:60; backdrop-filter: blur(4px); }
    .modal-card { width:95%; max-width:880px; max-height:85vh; overflow:auto; border-radius:12px; padding:16px; background:var(--card-bg); }
    :root {
      --bg: #f0f9ff; --card-bg: rgba(255, 255, 255, 0.95); --text: #0f172a; --muted: #475569; --border-color: #e5e7eb; --input-bg: #ffffff; --input-border: #d1d5db; --focus-border: #3b82f6; --tab-active-bg: #ffffff; --tab-inactive-text: #6b7280;
    }
    .dark {
      --bg: #0f172a; --card-bg: rgba(30, 41, 59, 0.7); --text: #e2e8f0; --muted: #94a3b8; --border-color: rgba(255, 255, 255, 0.1); --input-bg: rgba(51, 65, 85, 0.5); --input-border: rgba(255, 255, 255, 0.15); --focus-border: #38bdf8; --tab-active-bg: rgba(51, 65, 85, 0.6); --tab-inactive-text: #94a3b8;
    }
    body { background: var(--bg); color: var(--text); }
    .muted { color: var(--muted); }
    .main-card { background: var(--card-bg); border: 1px solid var(--border-color); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); backdrop-filter: blur(12px); border-radius: 16px; }
    input, select { background-color: var(--input-bg); border-color: var(--input-border); color: var(--text); }
    input:focus, select:focus { border-color: var(--focus-border); box-shadow: 0 0 0 3px var(--focus-border-shadow, rgba(59, 130, 246, 0.2)); }
    .dark input:focus, .dark select:focus { --focus-border-shadow: rgba(56, 189, 248, 0.2); }
    .dark .network-btn { background-color: rgba(51, 65, 85, 0.3); }
    .network-active { background: rgba(34, 197, 94, 0.12); border-color: #22c55e; }
    .dark .network-active { background: rgba(56, 189, 248, 0.1); border-color: var(--focus-border); box-shadow: 0 0 12px rgba(56, 189, 248, 0.3); }
    .badge { padding:6px 8px; border-radius:8px; font-size:13px; }
    .confirmed { background: #dcfce7; color:#166534; }
    .pending { background: #fff7ed; color:#92400e; }
    .received { background: #dbeafe; color:#1e40af; }
    .dark .confirmed { background: rgba(74, 222, 128, 0.15); color: #a7f3d0; }
    .dark .pending { background: rgba(251, 191, 36, 0.15); color: #fde68a; }
    .dark .received { background: rgba(96, 165, 250, 0.15); color: #bfdbfe; }
    .dark .received-item { background-color: rgba(56, 189, 248, 0.05); }
    th, td { border-bottom: 1px solid var(--border-color); padding:8px 10px; text-align:right; font-size:14px; }
    table { width:100%; border-collapse: collapse; }
    .color-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 8px; vertical-align: middle; }
    .instapay-icon { display: inline-flex; align-items: center; margin-left: 8px; vertical-align: middle; }
    .instapay-stripe { width: 8px; height: 10px; }
    .instapay-stripe:first-child { background-color: #facc15; }
    .instapay-stripe:last-child { background-color: #0f172a; }
    .dark .instapay-stripe:last-child { background-color: #e2e8f0; }
    .network-btn { flex-direction: row-reverse; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 sm:p-6">
  <div class="max-w-4xl w-full">
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-4">
        <img src="https://moslimtech.github.io/Ban/icons/icon-192.png" alt="logo" class="w-12 h-12 rounded-lg shadow" />
        <div>
          <h1 class="text-lg font-bold">مدير المعاملات المالية</h1>
          <p class="text-sm muted">بان للإعلانات</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a href="https://moslimtech.github.io/Ban/" class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-orange-100 dark:bg-slate-700 shadow btn-anim hover:shadow-md text-xl">🏠</a>
        <button id="themeToggle" class="w-10 h-10 rounded-full border border-slate-200 dark:border-slate-600 btn-anim flex items-center justify-center text-xl">🌗</button>
        <!-- زر الإعدادات الجديد -->
        <button id="settingsBtn" class="w-10 h-10 rounded-full border border-slate-200 dark:border-slate-600 btn-anim flex items-center justify-center text-xl">⚙️</button>
      </div>
    </header>

    <main class="main-card">
        <!-- الكود هنا كما هو حالياً... سنقوم بتعديله في الخطوة التالية -->
        <div class="flex border-b" style="border-color: var(--border-color);">
            <button id="sendTabBtn" class="tab-btn flex-1 py-3 px-4 text-sm font-semibold transition-colors duration-200">تحويل أموال</button>
            <button id="receiveTabBtn" class="tab-btn flex-1 py-3 px-4 text-sm font-semibold transition-colors duration-200">تسجيل استلام</button>
        </div>
        <div class="p-5 sm:p-6">
            <div id="sendPanel" class="tab-panel space-y-6">
                <!-- محتوى التحويل سيتم تحديثه لاحقاً -->
                <p class="muted text-center py-8">قم بإعداد المحافظ ونسبة الربح أولاً من قائمة الإعدادات ⚙️.</p>
            </div>
            <div id="receivePanel" class="tab-panel hidden">
                <!-- محتوى الاستلام سيتم تحديثه لاحقاً -->
                <p class="muted text-center py-8">قم بإعداد المحافظ ونسبة الربح أولاً من قائمة الإعدادات ⚙️.</p>
            </div>
        </div>
        <div class="text-center p-4 border-t" style="border-color: var(--border-color);">
            <button id="historyBtn" type="button" class="px-4 py-2 rounded-xl bg-amber-100 dark:bg-amber-900/50 text-amber-800 dark:text-amber-300 font-medium btn-anim hover:shadow flex items-center gap-2 mx-auto">
            <span class="text-lg">📜</span> عرض سجل المعاملات
            </button>
        </div>
    </main>

    <footer class="mt-4 text-center text-xs muted">© 2025 بان للإعلانات • جميع الحقوق محفوظة</footer>
  </div>

  <!-- نافذة السجل (لم تتغير) -->
  <div id="historyBackdrop" class="modal-backdrop hidden">
    <!-- ... -->
  </div>

  <!-- نافذة الإعدادات الجديدة -->
  <div id="settingsBackdrop" class="modal-backdrop hidden">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg">⚙️ الإعدادات العامة</h3>
        <button id="closeSettingsBtn" class="px-3 py-2 bg-gray-200 dark:bg-slate-600 rounded-lg text-sm">إغلاق</button>
      </div>

      <!-- قسم نسبة الربح -->
      <div class="space-y-4">
        <div>
          <label for="profitMarginInput" class="block text-sm font-medium muted mb-1">نسبة الربح (%)</label>
          <input id="profitMarginInput" type="number" step="0.1" min="0" placeholder="مثال: 2" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
          <p class="text-xs muted mt-1">سيتم تطبيق هذه النسبة على كل المعاملات لحساب الربح.</p>
        </div>

        <hr class="dark:border-slate-700"/>

        <!-- قسم إدارة المحافظ -->
        <div>
          <h4 class="font-semibold mb-2">إدارة المحافظ (أرقامك)</h4>
          <!-- قائمة المحافظ الحالية -->
          <div id="walletsList" class="space-y-2 mb-4">
            <!-- سيتم ملء هذه القائمة بواسطة الجافاسكريبت -->
          </div>
          
          <!-- نموذج إضافة محفظة جديدة -->
          <div class="p-4 rounded-lg bg-slate-50 dark:bg-slate-800/50 border dark:border-slate-700">
            <h5 class="font-semibold mb-3">إضافة محفظة جديدة</h5>
            <form id="addWalletForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label for="walletNumber" class="block text-xs font-medium muted mb-1">رقم المحفظة</label>
                <input id="walletNumber" type="tel" required placeholder="01xxxxxxxxx" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
              </div>
              <div>
                <label for="walletAlias" class="block text-xs font-medium muted mb-1">اسم مميز (اختياري)</label>
                <input id="walletAlias" type="text" placeholder="فودافون شخصي" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
              </div>
              <div>
                <label for="walletBalance" class="block text-xs font-medium muted mb-1">الرصيد الافتتاحي (ج)</label>
                <input id="walletBalance" type="number" required value="0" min="0" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
              </div>
              <div>
                <label for="walletLimit" class="block text-xs font-medium muted mb-1">حد المعاملات (شهري)</label>
                <input id="walletLimit" type="number" required value="100" min="1" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
              </div>
              <div class="sm:col-span-2">
                <button type="submit" class="w-full px-4 py-2 rounded-xl bg-blue-500 text-white font-semibold btn-anim hover:bg-blue-600">
                  + إضافة المحفظة
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script>
    // --- JavaScript Logic ---

    // تعريف كل العناصر المستخدمة في الصفحة
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsBackdrop = document.getElementById('settingsBackdrop');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const profitMarginInput = document.getElementById('profitMarginInput');
    const addWalletForm = document.getElementById('addWalletForm');
    const walletsList = document.getElementById('walletsList');
    
    // باقي العناصر القديمة (سنستخدمها لاحقاً)
    const sendTabBtn = document.getElementById('sendTabBtn');
    const receiveTabBtn = document.getElementById('receiveTabBtn');
    const sendPanel = document.getElementById('sendPanel');
    const receivePanel = document.getElementById('receivePanel');
    const historyBtn = document.getElementById('historyBtn');
    const themeToggle = document.getElementById('themeToggle');

    // --- النظام الجديد لإدارة البيانات ---
    const DB_KEY = 'ban_pos_database_v1';

    // هيكل البيانات الافتراضي
    const defaultDB = {
        settings: {
            profitMargin: 2.0 // نسبة ربح افتراضية 2%
        },
        wallets: [
            // مثال على شكل المحفظة
            // { id: '01012345678', alias: 'فودافون شخصي', openingBalance: 5000, limit: 100 }
        ],
        transactions: []
    };

    // وظيفة لتحميل قاعدة البيانات من localStorage
    function loadDB() {
        const data = localStorage.getItem(DB_KEY);
        // إذا لم توجد بيانات، نستخدم البيانات الافتراضية
        return data ? JSON.parse(data) : defaultDB;
    }

    // وظيفة لحفظ قاعدة البيانات في localStorage
    function saveDB(db) {
        localStorage.setItem(DB_KEY, JSON.stringify(db));
    }


    // --- وظائف إدارة الإعدادات والمحافظ ---

    // عرض نافذة الإعدادات
    settingsBtn.addEventListener('click', () => {
        settingsBackdrop.classList.remove('hidden');
        loadSettingsIntoUI(); // تحميل الإعدادات الحالية في الواجهة
    });

    // إغلاق نافذة الإعدادات
    closeSettingsBtn.addEventListener('click', () => {
        settingsBackdrop.classList.add('hidden');
    });

    // تحميل الإعدادات والمحافظ وعرضها في الواجهة
    function loadSettingsIntoUI() {
        const db = loadDB();
        // تحميل نسبة الربح
        profitMarginInput.value = db.settings.profitMargin;
        // عرض قائمة المحافظ
        renderWalletsList(db.wallets);
    }
    
    // حفظ نسبة الربح عند تغييرها
    profitMarginInput.addEventListener('change', () => {
        const db = loadDB();
        const newMargin = parseFloat(profitMarginInput.value);
        if (!isNaN(newMargin) && newMargin >= 0) {
            db.settings.profitMargin = newMargin;
            saveDB(db);
            // يمكن إضافة رسالة تأكيد هنا
        } else {
            alert('الرجاء إدخال نسبة ربح صالحة.');
            profitMarginInput.value = db.settings.profitMargin; // إعادة القيمة القديمة
        }
    });

    // عرض قائمة المحافظ في واجهة الإعدادات
    function renderWalletsList(wallets) {
        walletsList.innerHTML = ''; // تفريغ القائمة
        if (wallets.length === 0) {
            walletsList.innerHTML = `<p class="text-sm muted text-center">لم تقم بإضافة أي محافظ بعد.</p>`;
            return;
        }

        wallets.forEach(wallet => {
            const walletEl = document.createElement('div');
            walletEl.className = 'flex items-center justify-between p-2 rounded-lg bg-slate-100 dark:bg-slate-800';
            walletEl.innerHTML = `
                <div>
                    <p class="font-semibold">${wallet.alias || wallet.id}</p>
                    <p class="text-xs muted">الرصيد: ${wallet.openingBalance} ج | الحد: ${wallet.limit} معاملة</p>
                </div>
                <button data-id="${wallet.id}" class="delete-wallet-btn px-2 py-1 text-xs text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50 rounded">حذف</button>
            `;
            walletsList.appendChild(walletEl);
        });

        // إضافة مستمعي الأحداث لأزرار الحذف
        document.querySelectorAll('.delete-wallet-btn').forEach(btn => {
            btn.addEventListener('click', handleDeleteWallet);
        });
    }

    // إضافة محفظة جديدة
    addWalletForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const number = document.getElementById('walletNumber').value.trim();
        const alias = document.getElementById('walletAlias').value.trim();
        const balance = parseFloat(document.getElementById('walletBalance').value);
        const limit = parseInt(document.getElementById('walletLimit').value);

        if (!number || isNaN(balance) || isNaN(limit)) {
            alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح.');
            return;
        }

        const db = loadDB();

        // التحقق من أن الرقم غير موجود بالفعل
        if (db.wallets.some(w => w.id === number)) {
            alert('هذه المحفظة (الرقم) موجودة بالفعل.');
            return;
        }

        db.wallets.push({ id: number, alias: alias, openingBalance: balance, limit: limit });
        saveDB(db);
        
        addWalletForm.reset(); // تفريغ النموذج
        renderWalletsList(db.wallets); // إعادة عرض القائمة
    });

    // حذف محفظة
    function handleDeleteWallet(e) {
        const walletId = e.target.dataset.id;
        if (confirm(`هل أنت متأكد من حذف المحفظة ${walletId}؟ سيتم حذفها نهائياً.`)) {
            const db = loadDB();
            db.wallets = db.wallets.filter(w => w.id !== walletId);
            saveDB(db);
            renderWalletsList(db.wallets); // إعادة عرض القائمة
        }
    }


    // --- الوظائف القديمة (مؤقتاً) ---
    function switchTab(activeTab) {
      if (activeTab === 'send') {
        sendPanel.classList.remove('hidden'); receivePanel.classList.add('hidden');
        sendTabBtn.style.backgroundColor = 'var(--tab-active-bg)'; sendTabBtn.style.color = 'var(--text)';
        receiveTabBtn.style.backgroundColor = 'transparent'; receiveTabBtn.style.color = 'var(--tab-inactive-text)';
      } else {
        sendPanel.classList.add('hidden'); receivePanel.classList.remove('hidden');
        receiveTabBtn.style.backgroundColor = 'var(--tab-active-bg)'; receiveTabBtn.style.color = 'var(--text)';
        sendTabBtn.style.backgroundColor = 'transparent'; sendTabBtn.style.color = 'var(--tab-inactive-text)';
      }
    }
    sendTabBtn.addEventListener('click', () => switchTab('send'));
    receiveTabBtn.addEventListener('click', () => switchTab('receive'));

    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    function applyTheme(mode) {
      if (mode === 'dark') {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme','dark');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme','light');
      }
      switchTab(sendPanel.classList.contains('hidden') ? 'receive' : 'send');
    }
    const savedTheme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
    applyTheme(savedTheme);
    themeToggle.textContent = savedTheme === 'dark' ? '☀️' : '🌙';
    themeToggle.addEventListener('click', () => {
      const now = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(now);
      themeToggle.textContent = now === 'dark' ? '☀️' : '🌙';
    });
    
    // Initial setup
    switchTab('send'); // تفعيل تبويب التحويل عند تحميل الصفحة
    
  </script>
</body>
</html>
