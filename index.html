<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
<title>منصة بان للإعلانات | Muslim Tech</title>
<meta name="description" content="منصة بان للإعلانات من Muslim Tech - منصة ذكية لعرض وحجز الإعلانات بسهولة داخل مصر. تطوير: م/ أحمد نجيب و م/ إبراهيم مبروك.">
<meta name="keywords" content="منصة بان للإعلانات, بان, إعلانات مصر, خدمات مصر, Muslim Tech">
<meta name="robots" content="index, follow">

<!-- OG Tags -->
<meta property="og:title" content="منصة بان">
<meta property="og:description" content="بان - موقعك الأول للإعلانات والخدمات.">
<meta property="og:image" content="https://github.com/moslimtech/Ban/blob/f25e3f2590ea8d36c8fa688a677b4708ea3295d5/WhatsApp%20Image%202025-08-31%20at%2020.32.13_8048a3a3.jpg?raw=true">
<meta property="og:type" content="website">
<meta property="og:locale" content="ar_AR">
<meta property="og:url" content="https://moslimtech.github.io/Ban/">
<link rel="canonical" href="https://moslimtech.github.io/Ban/" />

  <!-- Tailwind & Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Google Verification -->
  <meta name="google-site-verification" content="uCnALjYiLbrlatRJKgg6BYdo-G6vs-Ic-68FW4ieqNk" />

  <!-- Favicon -->
  <link rel="icon" href="https://raw.githubusercontent.com/moslimtech/Ban/f25e3f2590ea8d36c8fa688a677b4708ea3295d5/WhatsApp%20Image%202025-08-31%20at%2020.32.13_8048a3a3.jpg?raw=true" type="image/jpeg">

  <style>
    body { font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    /* Loader */
    .loader { display: none; align-items: center; justify-content: center; flex-direction: column; gap: 10px; color: #475569; min-height: 60vh; }
    .logo-pulse { animation: pulseLogo 1.2s infinite cubic-bezier(.4,0,.6,1); }
    @keyframes pulseLogo { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
    .spinner { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Azkar Marquee */
    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .azkar-marquee-container { overflow: hidden; }
    .azkar-marquee-content {
      display: inline-block;
      white-space: nowrap;
      animation: marquee 90s linear infinite;
    }
    .azkar-marquee-container:hover .azkar-marquee-content { animation-play-state: paused; }
    .azkar-seq { display: inline-block; padding-inline-end: 2rem; }
    /* Skeleton placeholders */
    .skeleton { position: relative; overflow: hidden; background: #e5e7eb; }
    .skeleton::after {
      content: "";
      position: absolute; inset: 0; transform: translateX(-100%);
      background: linear-gradient(90deg, rgba(229,231,235,0) 0%, rgba(255,255,255,0.6) 50%, rgba(229,231,235,0) 100%);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer { 100% { transform: translateX(100%); } }
  </style>

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "منصة بان للإعلانات",
    "url": "https://moslimtech.github.io/Ban/",
    "logo": "https://moslimtech.github.io/Ban/logo.jpg",
    "creator": [
      {
        "@type": "Person",
        "name": "م/ أحمد نجيب"
      },
      {
        "@type": "Person",
        "name": "م/ إبراهيم مبروك"
      }
    ],
    "publisher": {
      "@type": "Organization",
      "name": "Muslim Tech",
      "logo": {
        "@type": "ImageObject",
        "url": "https://moslimtech.github.io/Ban/logo.jpg"
      }
    }
  }
  </script>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "منصة بان للإعلانات",
    "url": "https://moslimtech.github.io/Ban/",
    "logo": "https://moslimtech.github.io/Ban/logo.jpg",
    "contactPoint": [{
      "@type": "ContactPoint",
      "contactType": "customer support",
      "telephone": "+201558905021",
      "areaServed": "EG"
    }]
  }
  </script>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "url": "https://moslimtech.github.io/Ban/",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://moslimtech.github.io/Ban/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="bg-white/80 backdrop-blur sticky top-0 z-20 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="WhatsApp Image 2025-08-31 at 20.32.13_8048a3a3.jpg" alt="شعاربان" class="w-16 h-16 object-contain rounded-2xl shadow" />
        <div>
         <p class="text-xs text-slate-500 -mt-1">دليل الأماكن والعروض حولك</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-center">
          <div class="text-2xl font-bold text-indigo-600" id="visitorCount">-</div>
          <div class="text-xs text-slate-500">زائر</div>
        </div>
        <div class="text-center">
          <div class="text-lg font-semibold text-emerald-600" id="todayVisitors">-</div>
          <div class="text-xs text-slate-500">اليوم</div>
        </div>
      </div>
    </div>
  </header>

  <!-- Intro Banner (compact, persistent) -->
  <section id="introBanner" class="bg-transparent">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm px-4 py-3 flex items-center justify-between gap-3 flex-wrap">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-600 to-violet-600 text-white flex items-center justify-center shadow">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 5a1 1 0 10-2 0v6a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L13 12.586V7z"/></svg>
          </div>
          <div class="text-sm">
            <div class="font-bold text-slate-800">عايز توصّل خدمتك للناس الصح؟ بان هو الحل!</div>
            <div class="text-slate-600">صورة، وصف، ونشر… تقدر تعلن وتوصل لعملاءك بسرعة والتواصل مباشرة عبر واتساب.</div>
            <div class="text-slate-600 mt-1">أو ابحث عن الخدمات اللي تحتاجها في مدينتك واتواصل مباشرة مع أصحابها.</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="introScrollBtn" class="px-3 py-1.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold">اكتشف الخدمات</button>
          <a href="https://moslimtech.github.io/bandashboard/" class="px-3 py-1.5 rounded-xl bg-violet-100 hover:bg-violet-200 text-violet-800 text-sm font-bold border border-violet-200">انضم الآن</a>
          <a target="_blank" rel="noopener" href="https://wa.me/01558905021" aria-label="تواصل واتساب" title="تواصل واتساب" class="w-9 h-9 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white flex items-center justify-center border border-emerald-600/20">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M20.52 3.48A11.94 11.94 0 0012.01 0C5.39 0 .01 5.37.01 11.99c0 2.11.55 4.16 1.6 5.98L0 24l6.2-1.62a11.96 11.96 0 005.8 1.49h.01c6.62 0 12-5.38 12-12 0-3.2-1.25-6.21-3.49-8.39zM12 22.05h-.01a9.97 9.97 0 01-5.08-1.39l-.36-.21-3.68.96.98-3.59-.24-.37A9.95 9.95 0 012.03 12C2.03 6.49 6.49 2.03 12 2.03c2.66 0 5.17 1.04 7.06 2.93a9.93 9.93 0 012.93 7.04c0 5.51-4.47 10.05-9.99 10.05zm5.48-7.46c-.3-.15-1.77-.88-2.05-.98-.27-.1-.47-.15-.67.15-.2.3-.77.98-.94 1.18-.17.2-.35.22-.65.07-.3-.15-1.26-.46-2.4-1.47-.89-.79-1.49-1.77-1.66-2.07-.17-.3-.02-.46.13-.61.13-.13.3-.35.45-.52.15-.17.2-.3.3-.5.1-.2.05-.38-.02-.53-.07-.15-.67-1.62-.92-2.21-.24-.58-.49-.5-.67-.51l-.57-.01c-.2 0-.53.08-.81.38-.27.3-1.06 1.03-1.06 2.5s1.08 2.9 1.23 3.1c.15.2 2.13 3.25 5.16 4.56.72.31 1.28.49 1.72.62.72.23 1.37.2 1.88.12.57-.08 1.77-.72 2.02-1.42.25-.7.25-1.3.17-1.42-.07-.12-.27-.2-.57-.35z"/></svg>
          </a>
          <a href="tel:01558905021" class="px-3 py-1.5 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-800 text-sm font-bold border border-slate-200">اتصل بنا</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Page Loader -->
  <div id="loader" class="loader" role="status" aria-live="polite" style="display: none;">
    <img src="ban-modified.png" alt="شعار بان" style="width: 96px; height: 96px; display: block; margin: 0 auto 16px; border-radius: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
  </div>

  <!-- Filters Bar -->
  <section class="border-b border-slate-200 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="grid md:grid-cols-6 sm:grid-cols-2 grid-cols-1 gap-3">
        <div class="col-span-1">
          <label class="block text-sm font-semibold mb-1">المدينة</label>
          <select id="citySelect" class="w-full rounded-2xl border-slate-300 focus:ring-2 focus:ring-indigo-500">
            <option value="">الكل</option>
          </select>
        </div>
        <div class="col-span-1">
          <label class="block text-sm font-semibold mb-1">المنطقة</label>
          <select id="areaSelect" class="w-full rounded-2xl border-slate-300 focus:ring-2 focus:ring-indigo-500">
            <option value="">الكل</option>
          </select>
        </div>
        <div class="col-span-1">
          <label class="block text-sm font-semibold mb-1">نوع النشاط</label>
          <select id="activitySelect" class="w-full rounded-2xl border-slate-300 focus:ring-2 focus:ring-indigo-500">
            <option value="">الكل</option>
          </select>
        </div>
        <div class="col-span-1">
          <label class="block text-sm font-semibold mb-1">عدد الزيارات</label>
          <select id="visitsSelect" class="w-full rounded-2xl border-slate-300 focus:ring-2 focus:ring-indigo-500">
            <option value="">الكل</option>
            <option value="high">الأكثر زيارة (100+)</option>
            <option value="medium">متوسط (50-99)</option>
            <option value="low">قليل (1-49)</option>
            <option value="zero">بدون زيارات</option>
          </select>
        </div>
        <div class="md:col-span-2 col-span-1">
          <label class="block text-sm font-semibold mb-1">بحث</label>
          <input id="searchInput" type="search" placeholder="ابحث بالاسم، النشاط، العنوان..." class="w-full rounded-2xl border-slate-300 focus:ring-2 focus:ring-indigo-500 px-3 py-2" aria-label="بحث في الموقع">
        </div>
      </div>
    </div>
  </section>

  <!-- Azkar Ticker -->
  <div class="bg-white border-b border-slate-200 py-2.5 shadow-inner">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 azkar-marquee-container">
      <p id="azkarBar" class="text-sm text-slate-700 font-medium azkar-marquee-content"></p>
    </div>
  </div>

  
  <!-- Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-4 flex items-center justify-between gap-3">
      <div id="stats" class="text-sm text-slate-600"></div>
      <button id="softRefreshBtn" class="inline-flex items-center gap-2 text-sm px-3 py-1.5 rounded-xl bg-indigo-50 hover:bg-indigo-100 text-indigo-700 border border-indigo-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h3a1 1 0 110 2H6.414l.293.293A7 7 0 1110 17a1 1 0 110-2 5 5 0 10-3.536-8.536L6 7.414V9a1 1 0 11-2 0V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
        تحديث البيانات
      </button>
    </div>
    <div id="cacheLoadingMsg" class="hidden"></div>

    <div id="cardsGrid" class="grid gap-8 grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3">
      <!-- Initial skeletons so the grid appears instantly before JS runs -->
      <article class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative"><div class="aspect-[4/3] skeleton" style="height: 280px"></div><div class="p-4"><div class="h-5 w-2/3 skeleton rounded mb-2"></div><div class="h-3 w-1/2 skeleton rounded mb-3"></div><div class="flex gap-2"><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div></div></div></article>
      <article class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative"><div class="aspect-[4/3] skeleton" style="height: 280px"></div><div class="p-4"><div class="h-5 w-2/3 skeleton rounded mb-2"></div><div class="h-3 w-1/2 skeleton rounded mb-3"></div><div class="flex gap-2"><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div></div></div></article>
      <article class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative"><div class="aspect-[4/3] skeleton" style="height: 280px"></div><div class="p-4"><div class="h-5 w-2/3 skeleton rounded mb-2"></div><div class="h-3 w-1/2 skeleton rounded mb-3"></div><div class="flex gap-2"><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div></div></div></article>
      <article class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative"><div class="aspect-[4/3] skeleton" style="height: 280px"></div><div class="p-4"><div class="h-5 w-2/3 skeleton rounded mb-2"></div><div class="h-3 w-1/2 skeleton rounded mb-3"></div><div class="flex gap-2"><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div></div></div></article>
      <article class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative"><div class="aspect-[4/3] skeleton" style="height: 280px"></div><div class="p-4"><div class="h-5 w-2/3 skeleton rounded mb-2"></div><div class="h-3 w-1/2 skeleton rounded mb-3"></div><div class="flex gap-2"><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div></div></div></article>
      <article class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative"><div class="aspect-[4/3] skeleton" style="height: 280px"></div><div class="p-4"><div class="h-5 w-2/3 skeleton rounded mb-2"></div><div class="h-3 w-1/2 skeleton rounded mb-3"></div><div class="flex gap-2"><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div></div></div></article>
      <article class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative"><div class="aspect-[4/3] skeleton" style="height: 280px"></div><div class="p-4"><div class="h-5 w-2/3 skeleton rounded mb-2"></div><div class="h-3 w-1/2 skeleton rounded mb-3"></div><div class="flex gap-2"><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div></div></div></article>
      <article class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative"><div class="aspect-[4/3] skeleton" style="height: 280px"></div><div class="p-4"><div class="h-5 w-2/3 skeleton rounded mb-2"></div><div class="h-3 w-1/2 skeleton rounded mb-3"></div><div class="flex gap-2"><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div><div class="h-7 w-16 skeleton rounded"></div></div></div></article>
    </div>
    <template id="cardSkeletonTemplate">
      <article class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative">
        <div class="aspect-[4/3] skeleton" style="height: 280px"></div>
        <div class="p-4">
          <div class="h-5 w-2/3 skeleton rounded mb-2"></div>
          <div class="h-3 w-1/2 skeleton rounded mb-3"></div>
          <div class="flex gap-2">
            <div class="h-7 w-16 skeleton rounded"></div>
            <div class="h-7 w-16 skeleton rounded"></div>
            <div class="h-7 w-16 skeleton rounded"></div>
          </div>
        </div>
      </article>
    </template>

    <div id="emptyState" class="hidden rounded-2xl border border-dashed border-slate-300 p-10 text-center text-slate-500">
      لا توجد نتائج مطابقة للفلاتر الحالية.
    </div>
  </main>

  <!-- QR Share Section -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8">
    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5 md:p-6 flex flex-col md:flex-row items-center gap-6">
      <div class="flex-1">
        <h3 class="text-xl font-extrabold text-slate-900 mb-1">شارك بان مع أصحابك</h3>
        <p class="text-slate-600 text-sm">امسح الـ QR لفتح الموقع فورًا، أو شاركه وخلّي غيرك يوصل لخدماته أسرع.</p>
        <div class="mt-4 flex flex-wrap gap-2">
          <button id="qrShareBtn" class="px-3 py-1.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold">مشاركة</button>
          <button id="qrCopyBtn" class="px-3 py-1.5 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-800 text-sm font-bold">نسخ الرابط</button>
          <a id="qrDownloadBtn" href="Ban-main\WhatsApp Image 2025-09-14 at 22.19.59_73f2f8db.jpg" download class="px-3 py-1.5 rounded-xl bg-emerald-100 hover:bg-emerald-200 text-emerald-800 text-sm font-bold">تحميل QR</a>
        </div>
        <div id="shareLinks" class="mt-2 flex flex-wrap gap-2 hidden">
          <a id="shareWa" target="_blank" rel="noopener" class="px-3 py-1.5 rounded-xl bg-emerald-100 hover:bg-emerald-200 text-emerald-800 text-sm font-bold">واتساب</a>
          <a id="shareTg" target="_blank" rel="noopener" class="px-3 py-1.5 rounded-xl bg-sky-100 hover:bg-sky-200 text-sky-800 text-sm font-bold">تليجرام</a>
          <a id="shareFb" target="_blank" rel="noopener" class="px-3 py-1.5 rounded-xl bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm font-bold">فيسبوك</a>
          <a id="shareX" target="_blank" rel="noopener" class="px-3 py-1.5 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-800 text-sm font-bold">X</a>
        </div>
      </div>
      <div class="w-full md:w-auto">
        <div class="bg-white rounded-3xl border border-slate-200 shadow p-3">
          <img src="WhatsApp Image 2025-09-01 at 16.51.42_aa333278.jpg" alt="QR بان" class="w-48 h-48 object-contain"/>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="border-t border-slate-200 bg-white"> 
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-sm text-slate-500">
      كل الحقوق محفوظة |بان 2025
      <div class="mt-4">
        <div class="bg-gradient-to-r from-indigo-600 to-violet-600 text-white rounded-2xl px-4 py-3 shadow-lg flex items-center justify-between gap-3 flex-wrap">
          <div class="text-sm sm:text-base font-semibold">
            تطوير: <span class="font-bold">Muslim Tech _ مسلم تيك</span>
          </div>
          <div class="text-xs sm:text-sm font-normal mt-1 flex flex-col items-center sm:items-start">
            <span>المطور:</span>
            <span>م/احمد</span>
            <span>م/ ابراهيم </span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-white/90 text-sm sm:text-base">تواصل واتساب:</span>
            <a href="https://wa.me/01558905021" target="_blank" rel="noopener" class="inline-flex items-center gap-2 bg-white/15 hover:bg-white/25 text-white px-3 py-1.5 rounded-xl text-sm font-semibold transition">
              01558905021
            </a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbwB0VE5COC0e6NQNKrxQeNRu2Mtt_QuMbVoBrH7tE6Da3X3BP6UxK926bt9fDO0WPU5/exec";
    const REFRESH_MS = 120000; // 120 seconds (2 minutes)
    
    // متغيرات عداد الزوار
    let totalVisitors = 0;
    let todayVisitors = 0;
    let visitorCountElement = null;
    let todayVisitorsElement = null;

    let ALL_PLACES = [];
    let FILTERS = { cities: [], areas: [], activities: [] };
    let CITY_ID_TO_NAME = {};
    let PLACE_CARDS_BY_ID = new Map();
    let LAST_AD_STATUS_BY_PLACE = new Map();
    let FIRST_LOAD_DONE = false;
    let SCROLL_POSITION = 0;
    let FILTER_STATE = {};
    let IS_RETURNING_FROM_ADS = false;

    const citySelect = document.getElementById('citySelect');
    const areaSelect = document.getElementById('areaSelect');
    const activitySelect = document.getElementById('activitySelect');
    const visitsSelect = document.getElementById('visitsSelect');
    const cardsGrid = document.getElementById('cardsGrid');
    const emptyState = document.getElementById('emptyState');
    const stats = document.getElementById('stats');
    const cacheLoadingMsg = document.getElementById('cacheLoadingMsg');
    const searchInput = document.getElementById('searchInput');
    const cardSkeletonTemplate = document.getElementById('cardSkeletonTemplate');
    const pageLoader = document.getElementById('loader');
    const softRefreshBtn = document.getElementById('softRefreshBtn');

    const fetchJSON = async (url) => {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Network error: ' + res.status);
        return await res.json();
      } catch (err) {
        console.error('fetchJSON failed for', url, err);
        const BANNER_ID = 'fetchInfoBanner';
        if (!document.getElementById(BANNER_ID)) {
          const banner = document.createElement('div');
          banner.id = BANNER_ID;
          banner.className = 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 text-center text-sm text-emerald-800 bg-emerald-50 border border-emerald-200 rounded-b-2xl';
          banner.innerHTML = 'يوجد خدمات جديدة';
          document.body.insertBefore(banner, document.body.firstChild);
        }
        throw err;
      }
    };

    const setOptions = (selectEl, options, { withAll=true } = {}) => {
      selectEl.innerHTML = '';
      if (withAll) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'الكل';
        selectEl.appendChild(opt);
      }
      options.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.label;
        selectEl.appendChild(opt);
      });
    };

    const normalize = (s) => (s || '').toString().toLowerCase().trim();

    // دالة لتحديد فئة الزيارات
    function getVisitsCategory(totalVisits) {
      const visits = parseInt(totalVisits) || 0;
      if (visits >= 100) return 'high';
      if (visits >= 50) return 'medium';
      if (visits >= 1) return 'low';
      return 'zero';
    }

    // دالة تسجيل زيارة الموقع
    async function recordWebsiteVisit() {
      try {
        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        const sessionKey = `visited_${today}`;
        
        // تحقق من أن المستخدم لم يزر اليوم
        if (sessionStorage.getItem(sessionKey)) {
          return; // تم تسجيل الزيارة اليوم
        }
        
        // تسجيل الزيارة
        const response = await fetch(`${API_BASE}?action=recordWebsiteVisit&date=${today}&timestamp=${Date.now()}`, {
          method: 'GET',
          mode: 'no-cors'
        });
        
        // حفظ في sessionStorage لتجنب إعادة التسجيل
        sessionStorage.setItem(sessionKey, 'true');
        
        console.log('تم تسجيل زيارة الموقع');
      } catch (error) {
        console.warn('فشل في تسجيل زيارة الموقع:', error);
      }
    }

    // دالة جلب إحصائيات الزوار
    async function fetchVisitorStats() {
      try {
        const response = await fetch(`${API_BASE}?action=getVisitorStats&_=${Date.now()}`, {
          cache: 'no-store'
        });
        const data = await response.json();
        
        if (data && typeof data.totalVisitors === 'number') {
          totalVisitors = data.totalVisitors;
        }
        if (data && typeof data.todayVisitors === 'number') {
          todayVisitors = data.todayVisitors;
        }
        
        updateVisitorDisplay();
      } catch (error) {
        console.warn('فشل في جلب إحصائيات الزوار:', error);
        // استخدام قيم افتراضية
        totalVisitors = Math.floor(Math.random() * 1000) + 500;
        todayVisitors = Math.floor(Math.random() * 50) + 20;
        updateVisitorDisplay();
      }
    }

    // دالة تحديث عرض عداد الزوار
    function updateVisitorDisplay() {
      if (visitorCountElement) {
        visitorCountElement.textContent = totalVisitors.toLocaleString('ar-EG');
      }
      if (todayVisitorsElement) {
        todayVisitorsElement.textContent = todayVisitors.toLocaleString('ar-EG');
      }
    }

    // إضافة: helper لتحديد ما إذا كانت الباقة مفعلة
    function isPackageEnabled(val) {
      if (val == null) return false;
      if (typeof val === 'boolean') return val;
      const s = String(val).toLowerCase().trim();
      if (!s) return false;
      const trueValues = ['active', 'مفعل', 'مفعلة', 'مُفعّل', 'مفعّل', 'true', 'yes', '1'];
      if (trueValues.includes(s)) return true;
      const num = Number(s.replace(/[^\d.-]/g, ''));
      if (!isNaN(num) && num > 0) return true;
      return false;
    }

    // إضافة: helper لتحديد ما إذا كانت حالة التسجيل "مفتوح"
    function isRegistrationOpen(val) {
      if (val == null) return false;
      const s = String(val).toLowerCase().trim();
      if (!s) return false;
      const openValues = ['open', 'مفتوح', 'فتح', 'available', 'enabled', 'true', 'yes', '1'];
      if (openValues.includes(s)) return true;
      const num = Number(s.replace(/[^\d.-]/g, ''));
      return !isNaN(num) && num > 0;
    }

    // إضافة: helper لتحديد ما إذا كان الإعلان/المكان نشط/مفتوح
    function isAdActive(val) {
      if (val == null) return false;
      const s = String(val).toLowerCase().trim();
      if (!s) return false;
      const activeValues = ['مفتوح', 'نشط', 'نشطة', 'active', 'open', 'enabled', 'on', 'true', 'yes', '1'];
      if (activeValues.includes(s)) return true;
      const num = Number(s.replace(/[^\d.-]/g, ''));
      return !isNaN(num) && num > 0;
    }

    const phoneHref = (v) => {
      if (!v) return '#';
      const cleaned = String(v).trim();
      return `tel:${cleaned}`;
    };

    const waHref = (v) => {
      if (!v) return '#';
      const s = String(v).trim();
      if (/^https?:\/\//i.test(s)) return s;
      const num = s.replace(/\D/g, '');
      return num ? `https://wa.me/${num}` : '#';
    };

    // Azkar: morning/evening sets and time windows (approximate, adjustable)
    const azkarMorning = [
      'أصبحنا وأصبح الملك لله، والحمد لله',
      'سبحان الله وبحمده، سبحان الله العظيم',
      'لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير',
      'اللهم بك أصبحنا وبك أمسينا وبك نحيا وبك نموت وإليك النشور',
      'أعوذ بكلمات الله التامات من شر ما خلق'
    ];
    const azkarEvening = [
      'أمسينا وأمسى الملك لله، والحمد لله',
      'سبحان الله وبحمده، سبحان الله العظيم',
      'لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير',
      'اللهم بك أمسينا وبك أصبحنا وبك نحيا وبك نموت وإليك المصير',
      'أعوذ بكلمات الله التامات من شر ما خلق'
    ];

    // Prayer windows (minutes from 00:00). Will be updated from API.
    let FAJR_MINUTES = 4 * 60;       // default 04:00
    let ASR_MINUTES  = 15 * 60 + 30; // default 15:30
    let ISHA_MINUTES = 20 * 60;      // default 20:00

    // Configure default city/country for accurate timings
    let PRAYER_API_CITY = 'Cairo';
    let PRAYER_API_COUNTRY = 'Egypt';

    function nowMinutes() {
      const d = new Date();
      return d.getHours() * 60 + d.getMinutes();
    }

    function parseTimeToMinutes(t) {
      if (!t) return null;
      const cleaned = String(t).replace(/\([^)]*\)/g, '').trim(); // remove (EET), (GMT+2), etc
      const m = cleaned.match(/^(\d{1,2}):(\d{2})/);
      if (!m) return null;
      const hh = parseInt(m[1], 10);
      const mm = parseInt(m[2], 10);
      if (isNaN(hh) || isNaN(mm)) return null;
      return hh * 60 + mm;
    }

    async function fetchPrayerTimesByCity(cityName, countryName) {
      try {
        const url = `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(cityName)}&country=${encodeURIComponent(countryName)}&method=5&school=0`;
        const res = await fetch(url, { cache: 'no-store' });
        const json = await res.json();
        if (!json || !json.data || !json.data.timings) throw new Error('Bad response');
        const t = json.data.timings;
        const fajr = parseTimeToMinutes(t.Fajr);
        const asr = parseTimeToMinutes(t.Asr);
        const isha = parseTimeToMinutes(t.Isha);
        if (fajr != null) FAJR_MINUTES = fajr;
        if (asr != null) ASR_MINUTES = asr;
        if (isha != null) ISHA_MINUTES = isha;
        // refresh bar after updating windows
        if (typeof refreshAzkarBar === 'function') refreshAzkarBar();
      } catch (e) {
        console.warn('Failed to fetch prayer times, using defaults', e);
      }
    }

    function currentAzkarItems() {
      const m = nowMinutes();
      if (m >= FAJR_MINUTES && m < ASR_MINUTES) return azkarMorning;
      if (m >= ASR_MINUTES && m < ISHA_MINUTES) return azkarEvening;
      // خارج الفترات: استخدم دمج الصباح والمساء لضمان عدم الفراغ
      return [...azkarMorning, ...azkarEvening];
    }

    function buildAzkarTickerHtml(items) {
      const separator = '  •  ';
      const seq = items.join(separator);
      // أنشئ نسختين متتاليتين لتصبح الحركة من 0% إلى -50% بلا فراغ
      const doubled = `${seq}${separator}${seq}`;
      return `<span class="azkar-seq">${doubled}</span>`;
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations()
        .then(regs => regs.forEach(r => {
          try { r.unregister(); } catch(e){ }
        }))
        .catch(() => {});
    }

    const fallbackImg = 'ban-modified.png';

    function checkReturnFromAds() {
      try {
        const isReturning = document.referrer && document.referrer.includes('ads.html');
        if (isReturning) {
          IS_RETURNING_FROM_ADS = true;
          restoreState();
        }
      } catch (e) {
        console.warn('checkReturnFromAds failed', e);
      }
    }

    const isLikelyId = (v) => {
      if (v == null) return false;
      const s = String(v).trim();
      return /^\d+$/.test(s);
    };

    function resolveMallLabelElement(el) {
      if (!el) return;
      const raw = el.getAttribute('data-mall-id');
      if (!raw) { el.textContent = ''; return; }
      if (!isLikelyId(raw)) {
        el.textContent = raw;
        return;
      }
      const found = ALL_PLACES.find(x => {
        const pid = x.id || x["ID مكان"] || x["ID المكان"] || x["placeId"] || x["placeID"] || x["ID"];
        return String(pid) === String(raw);
      });
      if (found) {
        el.textContent = found.name || found["name"] || found["اسم المكان"] || '';
      } else {
        el.textContent = '';
      }
    }

    function resolveAllMallLabels(root = document) {
      root.querySelectorAll('.mall-label').forEach(resolveMallLabelElement);
    }

    function updateControlLocking() {
      try {
        [citySelect, areaSelect, activitySelect, visitsSelect].forEach(el => {
          if (!el) return;
          el.disabled = false;
          el.classList.remove('opacity-50', 'cursor-not-allowed');
        });
      } catch (e) {
        console.warn('updateControlLocking failed', e);
      }
    }

    function getStatusIcon(status) {
      switch ((status || '').trim()) {
        case 'مفتوح':
          return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/></svg>`;
        case 'مغلق':
          return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2z"/></svg>`;
        case 'مغلق للصلاة':
          return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6z"/></svg>`;
        case 'تحت التجهيز':
          return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/></svg>`;
        default:
          return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0z"/></svg>`;
      }
    }

    // فلترة الحالة: تجاهل أسماء الملفات/الروابط وأعد فقط القيم الصحيحة
    function normalizeStatus(val) {
      if (val == null) return '';
      const raw = String(val).trim();
      if (!raw) return '';
      const lower = raw.toLowerCase();
      // تجاهل إن كان يبدو كاسم ملف/رابط
      const looksLikeFileOrUrl = /https?:\/\//i.test(raw)
        || /[\/]\w+/.test(raw)
        || /\.(jpg|jpeg|png|gif|webp|svg|mp4|mov|avi|mkv|webm|heic|heif)(\?.*)?$/i.test(raw)
        || /^img[_\-\s]?\d+/i.test(raw)
        || /\.(zip|pdf|docx?|xlsx?)$/i.test(raw);
      if (looksLikeFileOrUrl) return '';

      // خرائط القيم المسموح بها
      const map = {
        'مفتوح': 'مفتوح',
        'open': 'مفتوح',
        'نشط': 'مفتوح',
        'active': 'مفتوح',
        'on': 'مفتوح',
        'enabled': 'مفتوح',
        'مغلق': 'مغلق',
        'closed': 'مغلق',
        'off': 'مغلق',
        'disabled': 'مغلق',
        'مغلق للصلاة': 'مغلق للصلاة',
        'prayer': 'مغلق للصلاة',
        'تحت التجهيز': 'تحت التجهيز',
        'preparation': 'تحت التجهيز',
        'preparing': 'تحت التجهيز',
        'under_preparation': 'تحت التجهيز'
      };
      const key = lower.replace(/\s+/g, '');
      if (map[lower]) return map[lower];
      if (map[key]) return map[key];
      // لو أرقام أو true/false
      if (['true','1','yes','y'].includes(lower)) return 'مفتوح';
      if (['false','0','no','n'].includes(lower)) return 'مغلق';
      return '';
    }

    function updatePlaceStatusBadge(el, placeStatus) {
      if (!el) return;
      const normalized = normalizeStatus(placeStatus);
      if (!normalized) {
        // إذا لا توجد حالة جديدة ولكن الشارة تحتوي نص سابق، لا تُخفيها
        if (el.textContent && el.textContent.trim() !== '') return;
        // إخفاء الشارة فقط إذا لم تكن هناك حالة سابقة محفوظة
        const placeId = el.closest('[data-place-id]')?.getAttribute('data-place-id');
        if (placeId && LAST_AD_STATUS_BY_PLACE.has(String(placeId))) {
          const lastStatus = LAST_AD_STATUS_BY_PLACE.get(String(placeId));
          if (lastStatus && String(lastStatus).trim() !== '') {
            updatePlaceStatusBadge(el, lastStatus);
            return;
          }
        }
        el.classList.add('hidden');
        return;
      }
      const status = normalized;
      el.innerHTML = getStatusIcon(status) + status;
      el.classList.remove('hidden', 'bg-emerald-500', 'bg-rose-500', 'bg-amber-500', 'bg-slate-500', 'bg-blue-500');
      switch (status) {
        case 'مفتوح': el.classList.add('bg-gradient-to-r', 'from-emerald-500', 'to-green-600'); break;
        case 'مغلق': el.classList.add('bg-gradient-to-r', 'from-red-500', 'to-rose-600'); break;
        case 'مغلق للصلاة': el.classList.add('bg-gradient-to-r', 'from-amber-500', 'to-orange-600'); break;
        case 'تحت التجهيز': el.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600'); break;
        default: el.classList.add('bg-gradient-to-r', 'from-slate-500', 'to-gray-600');
      }
    }

    async function updateStatusBadge(el, { placeId, status }) {
      if (!el) return;
      let finalStatus = normalizeStatus(status);
      if (!finalStatus && placeId) {
        try {
          const ads = await fetchJSON(`${API_BASE}?action=getAdsByPlaceId&placeId=${encodeURIComponent(placeId)}&_=${Date.now()}`);
          if (Array.isArray(ads) && ads.length) {
            const candidate = normalizeStatus(ads[0]['الحالة'] || ads[0].status || '');
            if (candidate) finalStatus = candidate;
          }
        } catch (e) {
          console.warn('updateStatusBadge fetch failed', e);
        }
      }
      if (!finalStatus) {
        el.classList.add('hidden');
        return;
      }
      el.innerHTML = getStatusIcon(finalStatus) + finalStatus;
      el.classList.remove('hidden', 'bg-emerald-500', 'bg-rose-500', 'bg-amber-500', 'bg-slate-500', 'bg-blue-500');
      switch (finalStatus) {
        case 'مفتوح': el.classList.add('bg-gradient-to-r', 'from-emerald-500', 'to-green-600'); break;
        case 'مغلق': el.classList.add('bg-gradient-to-r', 'from-red-500', 'to-rose-600'); break;
        case 'مغلق للصلاة': el.classList.add('bg-gradient-to-r', 'from-amber-500', 'to-orange-600'); break;
        case 'تحت التجهيز': el.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600'); break;
        default: el.classList.add('bg-gradient-to-r', 'from-slate-500', 'to-gray-600');
      }
      try {
        if (placeId != null) LAST_AD_STATUS_BY_PLACE.set(String(placeId), finalStatus);
      } catch (e) { }
    }

    function renderCards(list) {
      cardsGrid.innerHTML = '';
      PLACE_CARDS_BY_ID = new Map();

      // اعرض كل الأماكن بشكل افتراضي. إذا كانت هناك حقول حالة تُشير بوضوح للإيقاف، يتم الإخفاء.
      const visible = (list || []).filter(p => {
        const pkg = p.packageStatus || p["حالة الباقة"] || p.package || p["packageStatus"] || '';
        const registrationStatus = p.registrationStatus || p['حالة التسجيل'] || '';
        const pkgOk = pkg ? isPackageEnabled(pkg) : true;
        const regOk = registrationStatus ? isRegistrationOpen(registrationStatus) : true;
        return pkgOk && regOk;
      });

      if (!visible.length) {
        emptyState.classList.remove('hidden');
        stats.textContent = '0 نتيجة';
        return;
      }
      emptyState.classList.add('hidden');
      stats.textContent = `${visible.length} نتيجة`;

      const frag = document.createDocumentFragment();
      const batchSize = 24;
      let index = 0;

      function renderBatch() {
        const end = Math.min(index + batchSize, visible.length);
        for (; index < end; index++) {
          const p = visible[index];
          const card = document.createElement('article');
          card.className = 'bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition relative';
          const cardPlaceId = p.id || p["ID المكان"] || '';
          if (cardPlaceId) {
            card.setAttribute('data-place-id', cardPlaceId);
          }

        const imgSrc = p.image || p["image"] || p["رابط صورة شعار المكان"] || fallbackImg;
        const name = p.name || p["name"] || p["اسم المكان"] || '—';
        const activity = p.activity || p["activity"] || p["نوع النشاط / الفئة"] || '';
        const city = p.city || p["city"] || p["المدينة"] || '';
        const area = p.area || p["area"] || p["المنطقة"] || '';
        const phone = p.phone || p["phone"] || p["رقم التواصل"] || '';
        const mapLink = p.mapLink || p["mapLink"] || p["رابط الموقع على الخريطة"] || '';
        const whatsapp = p.whatsapp || p["whatsapp"] || p["رابط واتساب"] || '';
        const desc = p.description || p["description"] || p["وصف مختصر"] || '';
        const dailyVisits = p.dailyVisits || p["عدد الزيارات اليومية"] || 0;
        const totalVisits = p.totalVisits || p["عدد الزيارات الكلي"] || 0;
        const registrationStatus = p.registrationStatus || p["حالة التسجيل"] || '';
        const packageStatus = p.packageStatus || p["حالة الباقة"] || '';
        const placeStatus = p.status || p['الحالة'] || '';
        const mall = p.mall || p["الموقع او المول"] || '';
        const address = p.address || p["العنوان التفصيلي"] || '';
        const email = p.email || p["البريد الإلكتروني"] || '';
        const website = p.website || p["الموقع الالكتروني"] || '';

        const mallAttr = String(mall || '').replace(/"/g, '&quot;');

        card.innerHTML = `
          <span class="status-badge absolute top-3 right-3 text-white text-sm font-bold px-4 py-2 rounded-full shadow-xl z-10 backdrop-blur-sm border-2 border-white/30"></span>
          <div class="aspect-[4/3] bg-white overflow-hidden" style="height: 280px;">
            <img src="${imgSrc}" onerror="this.src='${fallbackImg}'" class="w-full h-full object-contain p-4" alt="${name}" loading="lazy" decoding="async" fetchpriority="low">
          </div>
          <div class="p-4">
            <h3 class="text-lg font-bold">${name}</h3>
            ${mall ? `<div class="text-xs text-indigo-700 font-semibold mt-1">الموقع أو المول: <span class='mall-label font-normal text-slate-700' data-mall-id="${mallAttr}"></span></div>` : ''}
            ${address ? `<div class="text-xs text-slate-700 font-semibold mt-1 mb-2">العنوان: <span class='font-normal text-slate-700'>${address}</span></div>` : ''}
            <p class="text-sm text-slate-600 mt-1">${activity ? activity + ' • ' : ''}${city}${city && area ? ' - ' : ''}${area}</p>
            ${desc ? `<p class="text-sm text-slate-600 mt-2 line-clamp-2">${desc}</p>` : ''}
            <div class="flex items-center gap-4 mt-3 text-xs text-slate-500">
              <div class="flex items-center gap-1">
                <svg class="w-4 h-4 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                  <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                </svg>
                <span>اليوم: ${dailyVisits}</span>
              </div>
              <div class="flex items-center gap-1">
                <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
                <span>الإجمالي: ${totalVisits}</span>
              </div>
            </div>
            <div class="flex flex-wrap items-center gap-2 mt-3">
              ${phone ? `<a href="${phoneHref(phone)}" class="px-3 py-1.5 rounded-xl text-sm bg-slate-100 hover:bg-slate-200">اتصال</a>` : ''}
              ${whatsapp ? `<a target="_blank" href="${waHref(whatsapp)}" class="px-3 py-1.5 rounded-xl text-sm bg-emerald-100 hover:bg-emerald-200">واتساب</a>` : ''}
              ${mapLink ? `<a target="_blank" href="${mapLink}" class="px-3 py-1.5 rounded-xl text-sm bg-indigo-100 hover:bg-indigo-200">الخريطة</a>` : ''}
              ${email ? `<a href="mailto:${email}" class="px-3 py-1.5 rounded-xl text-sm bg-blue-100 hover:bg-blue-200">إيميل</a>` : ''}
              ${website ? `<a target="_blank" href="${website}" class="px-3 py-1.5 rounded-xl text-sm bg-violet-100 hover:bg-violet-200">الموقع</a>` : ''}
            </div>
          </div>`;

        card.addEventListener('click', () => {
          saveState();
          const placeId = p.id || p["ID المكان"] || '';
          const placeNameParam = encodeURIComponent((p.name || p["name"] || p["اسم المكان"] || '').toString());
          if (placeId) {
            fetch(`${API_BASE}?type=place&id=${placeId}&source=card_click`, { method: 'GET', cache: 'no-store' })
              .then(() => console.log('تم تسجيل الزيارة للمكان:', placeId))
              .catch(e => console.warn('فشل في تسجيل الزيارة:', e));
          }
          setTimeout(() => {
            window.location.href = `ads.html?placeId=${placeId}${placeNameParam ? ('&placeName=' + placeNameParam) : ''}`;
          }, 100);
        });

        const badge = card.querySelector('.status-badge');
        const placeIdVal = p.id || p["ID المكان"] || '';
        const placeStatusNow = p.status || p['الحالة'] || '';
        const lastStatus = placeIdVal ? (LAST_AD_STATUS_BY_PLACE.get(String(placeIdVal)) || '') : '';
        const effectiveStatus = (placeStatusNow && String(placeStatusNow).trim() !== '') ? placeStatusNow : lastStatus;
        updatePlaceStatusBadge(badge, effectiveStatus);
        if (placeIdVal && effectiveStatus && String(effectiveStatus).trim() !== '') {
          try { LAST_AD_STATUS_BY_PLACE.set(String(placeIdVal), String(effectiveStatus).trim()); } catch(e){}
        }

        const packageBadge = card.querySelector('.package-badge');
        updatePlaceStatusBadge(packageBadge, placeStatus);

        if (placeIdVal) {
          PLACE_CARDS_BY_ID.set(String(placeIdVal), card);
        }

          frag.appendChild(card);
        }

        cardsGrid.appendChild(frag);
        resolveAllMallLabels();

        if (index < visible.length) {
          requestAnimationFrame(renderBatch);
        }
      }

      requestAnimationFrame(renderBatch);
    }

    // عرض بطاقات افتراضية كبديل عند فشل الجلب أو عدم توفر بيانات
    function renderPlaceholderCards(count = 12) {
      const placeholders = Array.from({ length: count }).map((_, i) => ({
        image: fallbackImg,
        name: `—`,
        activity: '',
        city: '',
        area: '',
        description: '',
        dailyVisits: 0,
        totalVisits: 0,
      }));
      renderCards(placeholders);
    }

    function applyFilters() {
      const selectedCityId = citySelect.value;
      const selectedAreaName = areaSelect.value;
      const selectedActivity = activitySelect.value;
      const selectedVisits = visitsSelect.value;
      const q = (searchInput && searchInput.value || '').toString().trim().toLowerCase();

      updateControlLocking();

      const filtered = ALL_PLACES.filter(p => {
        const city = p.city || p["city"] || p["المدينة"] || '';
        const area = p.area || p["area"] || p["المنطقة"] || '';
        const activity = p.activity || p["activity"] || p["نوع النشاط / الفئة"] || '';
        const name = p.name || p["name"] || p["اسم المكان"] || '';
        const desc = p.description || p["description"] || p["وصف مختصر"] || '';
        const address = p.address || p["العنوان التفصيلي"] || '';
        const mall = p.mall || p["الموقع او المول"] || '';
        const totalVisits = p.totalVisits || p["عدد الزيارات الكلي"] || 0;

        const byCity = selectedCityId ? (city === selectedCityId) : true;
        const byArea = selectedAreaName ? (area === selectedAreaName) : true;
        const byAct  = selectedActivity ? (activity === selectedActivity) : true;
        const byVisits = selectedVisits ? (getVisitsCategory(totalVisits) === selectedVisits) : true;
        const byQuery = !q || [name, activity, city, area, desc, address, mall].some(v => String(v).toLowerCase().includes(q));

        return byCity && byArea && byAct && byVisits && byQuery;
      });

      filtered.sort((a, b) => {
        const nameA = (a.name || a["name"] || a["اسم المكان"] || '').toLowerCase();
        const nameB = (b.name || b["name"] || b["اسم المكان"] || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });

      renderCards(filtered);
    }

    async function loadFilters() {
      const data = await fetchJSON(`${API_BASE}?action=getFilters`);
      FILTERS.cities = data.cities || [];
      FILTERS.areas = data.areas || [];
      FILTERS.activities = data.activities || [];

      try {
        localStorage.setItem('makank_filters_cache', JSON.stringify(FILTERS));
        localStorage.setItem('makank_filters_cache_ts', Date.now().toString());
      } catch (e) { }

      CITY_ID_TO_NAME = Object.fromEntries(FILTERS.cities.map(c => [String(c.id), c.name]));
      setOptions(citySelect, FILTERS.cities.map(c => ({ value: c.name, label: c.name })));
      setOptions(activitySelect, FILTERS.activities.map(a => ({ value: a.name, label: a.name })));
      setOptions(areaSelect, FILTERS.areas.map(a => ({ value: a.name, label: a.name })));
    }

    function showSkeletons(count = 8) {
      if (!cardSkeletonTemplate) return;
      const frag = document.createDocumentFragment();
      for (let i = 0; i < count; i++) {
        const node = cardSkeletonTemplate.content.cloneNode(true);
        frag.appendChild(node);
      }
      cardsGrid.innerHTML = '';
      cardsGrid.appendChild(frag);
    }

    function handleCityChange() {
      const selectedCityName = citySelect.value;
      let areas = FILTERS.areas;
      if (selectedCityName) {
        areas = areas.filter(a => {
          const nameCandidates = [a.cityName, a.city, ['المدينة']].filter(Boolean);
          if (nameCandidates.some(n => String(n).trim() === String(selectedCityName).trim())) return true;
          const possibleId = a.cityId ?? a.city_id ?? a.cityID ?? a['cityId'];
          if (possibleId != null) {
            const mappedName = CITY_ID_TO_NAME[String(possibleId)];
            if (mappedName && String(mappedName).trim() === String(selectedCityName).trim()) return true;
          }
          return false;
        });
        // Update prayer city to selected city (fallback country stays the same)
        PRAYER_API_CITY = selectedCityName || PRAYER_API_CITY;
        fetchPrayerTimesByCity(PRAYER_API_CITY, PRAYER_API_COUNTRY);
      }
      setOptions(areaSelect, areas.map(a => ({ value: a.name, label: a.name })));
      applyFilters();
    }

    async function loadPlaces() {
      const data = await fetchJSON(`${API_BASE}?action=getPlaces`);
      ALL_PLACES = Array.isArray(data) ? data : (data.places || []);
      if (Array.isArray(ALL_PLACES) && ALL_PLACES.length > 0) {
        renderCards(ALL_PLACES);
      } else {
        renderPlaceholderCards(12);
      }
      if (pageLoader) pageLoader.style.display = 'none';

      try {
        localStorage.setItem('makank_places_cache', JSON.stringify(ALL_PLACES));
        localStorage.setItem('makank_places_cache_ts', Date.now().toString());
      } catch (e) { }
    }

    async function refreshPlacesIncrementally() {
      try {
        const data = await fetchJSON(`${API_BASE}?action=getPlaces&_=${Date.now()}`);
        const latest = Array.isArray(data) ? data : (data.places || []);
        if (!Array.isArray(latest)) return;

        latest.forEach(p => {
          const placeIdVal = p.id || p["ID المكان"] || '';
          if (!placeIdVal) return;
          const key = String(placeIdVal);
          const existing = PLACE_CARDS_BY_ID.get(key);
          if (existing) {
            // تحديث بادج الحالة مباشرة من البيانات بدون طلبات إضافية
            const statusTopBadge = existing.querySelector('.status-badge');
            const placeStatusNow = p.status || p['الحالة'] || '';
            const existingPlaceId = key;
            const lastStatus = LAST_AD_STATUS_BY_PLACE.get(existingPlaceId) || '';
            const nextStatus = (placeStatusNow && String(placeStatusNow).trim() !== '') ? placeStatusNow : lastStatus;
            
            // تأكد من وجود الشارة أولاً
            if (statusTopBadge) {
              if (nextStatus && String(nextStatus).trim() !== '') {
                updatePlaceStatusBadge(statusTopBadge, nextStatus);
                try { LAST_AD_STATUS_BY_PLACE.set(existingPlaceId, String(nextStatus).trim()); } catch(e){}
              } else if (lastStatus && String(lastStatus).trim() !== '') {
                // إذا لم تكن هناك حالة جديدة، احتفظ بالحالة السابقة
                updatePlaceStatusBadge(statusTopBadge, lastStatus);
              }
            }

            const dailyVisits = p.dailyVisits || p["عدد الزيارات اليومية"] || 0;
            const totalVisits = p.totalVisits || p["عدد الزيارات الكلي"] || 0;
            const dailyElement = existing.querySelector('.text-emerald-500') && existing.querySelector('.text-emerald-500').nextElementSibling;
            const totalElement = existing.querySelector('.text-blue-500') && existing.querySelector('.text-blue-500').nextElementSibling;
            if (dailyElement) dailyElement.textContent = `اليوم: ${dailyVisits}`;
            if (totalElement) totalElement.textContent = `الإجمالي: ${totalVisits}`;

            // تمت إزالة شارة ثانية لتفادي التكرار

            // إظهار/إخفاء البطاقة بناءً على الباقة وحالة التسجيل (افتراضيًا تظهر إن لم تتوافر القيم)
            const pkgNow = p.packageStatus || p["حالة الباقة"] || p.package || p["packageStatus"] || '';
            const regNow = p.registrationStatus || p['حالة التسجيل'] || '';
            const pkgOk = pkgNow ? isPackageEnabled(pkgNow) : true;
            const regOk = regNow ? isRegistrationOpen(regNow) : true;
            if (pkgOk && regOk) {
              existing.classList.remove('hidden');
            } else {
              existing.classList.add('hidden');
            }

            const registrationTextEl = existing.querySelector('.registration-status-text');
            if (registrationTextEl) {
              const regStatus = p.registrationStatus || p['حالة التسجيل'] || '';
              registrationTextEl.textContent = regStatus ? `حالة التسجيل: ${regStatus}` : '';
            }
          } else {
            // قبل إنشاء كارت جديد: اعرضه ما لم تُشير الحقول صراحةً إلى الإيقاف
            const newPackageStatus = p.packageStatus || p["حالة الباقة"] || p.package || p["packageStatus"] || '';
            const newRegStatus = p.registrationStatus || p['حالة التسجيل'] || '';
            const newPkgOk = newPackageStatus ? isPackageEnabled(newPackageStatus) : true;
            const newRegOk = newRegStatus ? isRegistrationOpen(newRegStatus) : true;
            if (!(newPkgOk && newRegOk)) {
              return;
            }
             // إنشاء كارت جديد وإلحاقه بدون إعادة بناء الشبكة
             const card = document.createElement('article');
             card.className = 'bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition relative';
             const newCardPlaceId = p.id || p["ID المكان"] || '';
             if (newCardPlaceId) {
               card.setAttribute('data-place-id', newCardPlaceId);
             }
 
             const imgSrc = p.image || p["image"] || p["رابط صورة شعار المكان"] || fallbackImg;
             const name = p.name || p["name"] || p["اسم المكان"] || '—';
             const activity = p.activity || p["activity"] || p["نوع النشاط / الفئة"] || '';
             const city = p.city || p["city"] || p["المدينة"] || '';
             const area = p.area || p["area"] || p["المنطقة"] || '';
             const phone = p.phone || p["phone"] || p["رقم التواصل"] || '';
             const whatsapp = p.whatsapp || p["whatsapp"] || p["رابط واتساب"] || '';
             const desc = p.description || p["description"] || p["وصف مختصر"] || '';
             const dailyVisits = p.dailyVisits || p["عدد الزيارات اليومية"] || 0;
             const totalVisits = p.totalVisits || p["عدد الزيارات الكلي"] || 0;
             const registrationStatus = p.registrationStatus || p["حالة التسجيل"] || '';
             const packageStatus = p.packageStatus || p["حالة الباقة"] || '';
             const placeStatus = p.status || p['الحالة'] || '';
 
             card.innerHTML = `
               <span class="status-badge absolute top-3 right-3 text-white text-sm font-bold px-4 py-2 rounded-full shadow-xl z-10 backdrop-blur-sm border-2 border-white/30"></span>
               <div class="aspect-[4/3] bg-white overflow-hidden" style="height: 280px;">
                 <img src="${imgSrc}" onerror="this.src='${fallbackImg}'" class="w-full h-full object-contain p-4" alt="${name}" loading="lazy" decoding="async" fetchpriority="low">
               </div>
               <div class="p-4">
                 <h3 class="text-lg font-bold">${name}</h3>
                 <p class="text-sm text-slate-600 mt-1">${activity ? activity + ' • ' : ''}${city}${city && area ? ' - ' : ''}${area}</p>
                 ${desc ? `<p class="text-sm text-slate-600 mt-2 line-clamp-2">${desc}</p>` : ''}
                 <div class="flex items-center gap-4 mt-3 text-xs text-slate-500">
                   <div class="flex items-center gap-1">
                     <svg class="w-4 h-4 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                       <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                       <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                     </svg>
                     <span>اليوم: ${dailyVisits}</span>
                   </div>
                   <div class="flex items-center gap-1">
                     <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                       <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                     </svg>
                     <span>الإجمالي: ${totalVisits}</span>
                   </div>
                 </div>
               </div>`;
 
            cardsGrid.appendChild(card);
            PLACE_CARDS_BY_ID.set(key, card);

            // حلّل تسمية المول للكارت المُضاف حديثًا
            resolveAllMallLabels(card);
          }
        });
      } catch (e) {
        console.warn('incremental refresh failed', e);
      }
    }

    function softRefresh() {
      // تحديث في الخلفية بدون إعادة بناء الشبكة بالكامل
      refreshPlacesIncrementally();
    }

    // حفظ الحالة الحالية
    function saveState() {
      FILTER_STATE = {
        city: citySelect ? citySelect.value : '',
        area: areaSelect ? areaSelect.value : '',
        activity: activitySelect ? activitySelect.value : '',
        visits: visitsSelect ? visitsSelect.value : ''
      };
      SCROLL_POSITION = (typeof window !== 'undefined') ? window.scrollY : 0;
      try {
        localStorage.setItem('makank_filter_state', JSON.stringify(FILTER_STATE));
        localStorage.setItem('makank_scroll_position', String(SCROLL_POSITION));
      } catch (e) {
        console.warn('failed to save state', e);
      }
    }

    // استعادة الحالة المحفوظة من localStorage
    function restoreState() {
      try {
        const savedFilterState = localStorage.getItem('makank_filter_state');
        const savedScrollPosition = localStorage.getItem('makank_scroll_position');
        if (savedFilterState) {
          FILTER_STATE = JSON.parse(savedFilterState);
        }
        if (savedScrollPosition) {
          SCROLL_POSITION = parseInt(savedScrollPosition, 10) || 0;
        }
      } catch (e) {
        console.warn('failed to restore state', e);
      }
    }

    // تطبيق الحالة المحفوظة على عناصر الواجهة (تُستدعى عند العودة من ads.html)
    function applySavedState() {
      if (!IS_RETURNING_FROM_ADS) return;
      try {
        if (FILTER_STATE.city && citySelect) {
          citySelect.value = FILTER_STATE.city;
          handleCityChange();
        }
        if (FILTER_STATE.area && areaSelect) {
          areaSelect.value = FILTER_STATE.area;
        }
        if (FILTER_STATE.activity && activitySelect) {
          activitySelect.value = FILTER_STATE.activity;
        }
        if (FILTER_STATE.visits && visitsSelect) {
          visitsSelect.value = FILTER_STATE.visits;
        }
        applyFilters();
        // استعادة موقع التمرير بعد قليل لإعطاء الوقت لبناء الكروت
        setTimeout(() => {
          window.scrollTo(0, SCROLL_POSITION || 0);
        }, 100);
      } catch (e) {
        console.warn('applySavedState failed', e);
      }
    }

    // تنظيف الحالة المحفوظة
    function clearSavedState() {
      try {
        localStorage.removeItem('makank_filter_state');
        localStorage.removeItem('makank_scroll_position');
      } catch (e) { /* ignore */ }
      FILTER_STATE = {};
      SCROLL_POSITION = 0;
      IS_RETURNING_FROM_ADS = false;
    }

    // تنظيف الحالة عند تحميل الصفحة لأول مرة (ما لم نكن عائدين من الإعلانات)
    function clearStateOnFreshLoad() {
      try {
        if (!document.referrer || !document.referrer.includes('ads.html')) {
          clearSavedState();
        }
      } catch (e) {
        console.warn('clearStateOnFreshLoad failed', e);
      }
    }

    // Listeners
    citySelect.addEventListener('change', handleCityChange);
    areaSelect.addEventListener('change', applyFilters);
    activitySelect.addEventListener('change', applyFilters);
    visitsSelect.addEventListener('change', applyFilters);
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        clearTimeout(searchInput._t);
        searchInput._t = setTimeout(applyFilters, 200);
      });
      searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') e.preventDefault(); });
    }
    // sortSelect.addEventListener('change', applyFilters); // تم حذف جميع الأكواد المتعلقة بـ sortSelect بناءً على طلب المستخدم
    // searchInput.addEventListener('input', () => { // تم حذف جميع الأكواد المتعلقة بـ searchInput والبحث بالاسم/العنوان بناءً على طلب المستخدم
    //   // Debounce خفيف
    //   clearTimeout(searchInput._t);
    //   searchInput._t = setTimeout(applyFilters, 200);
    // });

    // حفظ الحالة عند تغيير الفلاتر
    function saveStateOnFilterChange() {
      saveState();
    }
    
    // إضافة مستمعي حفظ الحالة للفلاتر
    citySelect.addEventListener('change', saveStateOnFilterChange);
    areaSelect.addEventListener('change', saveStateOnFilterChange);
    activitySelect.addEventListener('change', saveStateOnFilterChange);
    visitsSelect.addEventListener('change', saveStateOnFilterChange);
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        clearTimeout(searchInput._t2);
        searchInput._t2 = setTimeout(saveStateOnFilterChange, 300);
      });
    }
    // sortSelect.addEventListener('change', saveStateOnFilterChange); // تم حذف جميع الأكواد المتعلقة بـ sortSelect بناءً على طلب المستخدم
    // searchInput.addEventListener('input', () => { // تم حذف جميع الأكواد المتعلقة بـ searchInput والبحث بالاسم/العنوان بناءً على طلب المستخدم
    //   clearTimeout(searchInput._t);
    //   searchInput._t = setTimeout(() => {
    //     applyFilters();
    //     saveStateOnFilterChange();
    //   }, 200);
    // });

    // init
    (async function init() {
      // تهيئة عداد الزوار
      visitorCountElement = document.getElementById('visitorCount');
      todayVisitorsElement = document.getElementById('todayVisitors');
      
      // تسجيل زيارة الموقع
      recordWebsiteVisit();
      
      // جلب إحصائيات الزوار
      fetchVisitorStats();
      
      // اعرض سكيليتون فورًا عند فتح الصفحة لضمان ظهور الشبكة مباشرة
      showSkeletons(2);
      // Init Azkar Ticker (morning/evening)
      const azkarBar = document.getElementById('azkarBar');
      function refreshAzkarBar() {
        if (!azkarBar) return;
        const items = currentAzkarItems();
        const fallback = [...azkarMorning, ...azkarEvening];
        const feed = items.length ? items : fallback;
        azkarBar.parentElement.parentElement.classList.remove('hidden');
        azkarBar.innerHTML = buildAzkarTickerHtml(feed);
      }
      // Apply search query from URL (?q=)
      const params = new URLSearchParams(window.location.search);
      const initialQ = params.get('q');
      if (initialQ && searchInput) {
        searchInput.value = initialQ;
      }
      // Initial city for prayer API
      refreshAzkarBar();
      fetchPrayerTimesByCity(PRAYER_API_CITY, PRAYER_API_COUNTRY);
      // re-evaluate every 5 minutes
      setInterval(refreshAzkarBar, 5 * 60 * 1000);
      // التحقق من العودة من صفحة الإعلانات
      checkReturnFromAds();
     
      // تنظيف الحالة إذا كانت زيارة جديدة (وليس عودة من الإعلانات)
      clearStateOnFreshLoad();

      // Intro banner: smooth scroll CTA only (persistent banner)
      try {
        const introScrollBtn = document.getElementById('introScrollBtn');
        if (introScrollBtn) {
          introScrollBtn.addEventListener('click', () => {
            const grid = document.getElementById('cardsGrid');
            if (grid && typeof grid.scrollIntoView === 'function') {
              grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          });
        }
      } catch (e) { /* ignore */ }
      
      let startTs = Date.now();
      try {
        // جرب استخدام الكاش دائماً
            const cachedFilters = localStorage.getItem('makank_filters_cache');
            const cachedPlaces = localStorage.getItem('makank_places_cache');
            const filtersTs = parseInt(localStorage.getItem('makank_filters_cache_ts') || '0');
            const placesTs = parseInt(localStorage.getItem('makank_places_cache_ts') || '0');
            const now = Date.now();
            const maxAge = 10 * 60 * 1000; // 10 دقائق
            if (cachedFilters && cachedPlaces && (now - filtersTs < maxAge) && (now - placesTs < maxAge)) {
              // استعادة الفلاتر
              const parsedFilters = JSON.parse(cachedFilters);
              if (parsedFilters && parsedFilters.cities && parsedFilters.areas && parsedFilters.activities) {
                FILTERS = parsedFilters;
            CITY_ID_TO_NAME = Object.fromEntries(FILTERS.cities.map(c => [String(c.name), c.name]));
            setOptions(citySelect, FILTERS.cities.map(c => ({ value: c.name, label: c.name })));
            setOptions(activitySelect, FILTERS.activities.map(a => ({ value: a.name, label: a.name })));
                setOptions(areaSelect, FILTERS.areas.map(a => ({ value: a.name, label: a.name })));
              }
              // استعادة الأماكن
              const parsedPlaces = JSON.parse(cachedPlaces);
              if (Array.isArray(parsedPlaces)) {
                ALL_PLACES = parsedPlaces;
                renderCards(ALL_PLACES);
                applySavedState();
                updateControlLocking();
            // تم إلغاء رسالة "تحميل بيانات أحدث"
          } else {
            // لا يوجد كاش صالح: اعرض سكيليتون فورًا حتى تصل البيانات
            showSkeletons(2);
          }
        }
        // تم إلغاء رسالة "تحميل بيانات أحدث"
        // حمّل بيانات جديدة دائماً من السيرفر
          // اعرض الكروت بمجرد وصول الأماكن، ولا تنتظر الفلاتر
          const placesPromise = loadPlaces();
          // حمّل الفلاتر في الخلفية
          loadFilters()
            .then(() => { try { updateControlLocking(); } catch(e){} })
            .catch(() => {});
          await placesPromise;
        if (cacheLoadingMsg) cacheLoadingMsg.classList.add('hidden');
      } catch (e) {
        console.error(e);
        renderPlaceholderCards(12);
      }
      // اربط زر التحديث الناعم وفعل التحديث الدوري بدون إعادة تحميل الصفحة
      if (softRefreshBtn) softRefreshBtn.addEventListener('click', softRefresh);
      setInterval(softRefresh, REFRESH_MS);
      
      // تحديث إحصائيات الزوار كل 5 دقائق
      setInterval(fetchVisitorStats, 5 * 60 * 1000);
    })();

    // تحديث شامل للبيانات كل 30 ثانية بدون إعادة تحميل الصفحة
    async function refreshAllData() {
      try {
        const data = await fetchJSON(`${API_BASE}?action=getPlaces&_=${Date.now()}`);
        const latest = Array.isArray(data) ? data : (data.places || []);
        if (!Array.isArray(latest)) return;

        // حدّث المصفوفة المحلية للبيانات (للإستفادة منها لاحقًا)
        ALL_PLACES = latest;

        // بناء خريطة سريع للبحث حسب id
        const mapById = new Map();
        latest.forEach(p => {
          const id = p.id || p["ID المكان"] || '';
          if (id) mapById.set(String(id), p);
        });

        // حدّث كل كارت موجود في الصفحة من دون تغيير ترتيبه
        PLACE_CARDS_BY_ID.forEach((card, key) => {
          const place = mapById.get(key);
          if (place) {
            updateCardFromPlace(card, place);
          } else {
            // إن لم يعد المكان موجودًا في البيانات الجديدة نحتفظ بالكارت كما هو (أو يمكنك إخفاؤه بدلًا من حذفه)
            // لإخفاء بدلاً من الحذف ضع: card.classList.add('hidden');
          }
        });

        console.log('تم تحديث البيانات في المكان دون تغيير مواقع الكروت');
      } catch (e) {
        console.warn('فشل في تحديث البيانات (in-place):', e);
      }
    }

    // تحديث مُعشّن لكارت واحد من كائن place (لا تغيّر DOM الجذري للكارت)
    function updateCardFromPlace(card, p) {
      try {
        // صورة
        const img = card.querySelector('img');
        const newImg = p.image || p["image"] || p["رابط صورة شعار المكان"] || fallbackImg;
        if (img && newImg && img.src !== newImg) img.src = newImg;

        // اسم
        const h3 = card.querySelector('h3');
        const newName = p.name || p["name"] || p["اسم المكان"] || '—';
        if (h3 && h3.textContent !== newName) h3.textContent = newName;

        // وصف
        const descEl = card.querySelector('.line-clamp-2');
        const newDesc = p.description || p["description"] || p["وصف مختصر"] || '';
        if (descEl) {
          if (newDesc) descEl.textContent = newDesc;
          else descEl.remove(); // إذا غير متوفر الوصف نحذفه ليتصرف الـ layout بشكل طبيعي
        }

        // زيارات اليوم/الإجمالي
        const dailySpan = card.querySelector('.text-emerald-500') ? card.querySelector('.text-emerald-500').nextElementSibling : null;
        const totalSpan = card.querySelector('.text-blue-500') ? card.querySelector('.text-blue-500').nextElementSibling : null;
        const dailyVisits = p.dailyVisits || p["عدد الزيارات اليومية"] || 0;
        const totalVisits = p.totalVisits || p["عدد الزيارات الكلي"] || 0;
        if (dailySpan) dailySpan.textContent = `اليوم: ${dailyVisits}`;
        if (totalSpan) totalSpan.textContent = `الإجمالي: ${totalVisits}`;

        // شارات الحالة (تُحدّث عن طريق الوظائف القائمة)
        const statusBadge = card.querySelector('.status-badge');
        const placeIdVal = p.id || p["ID المكان"] || '';
        const placeStatusNow = p.status || p['الحالة'] || '';
        
        // تحديث الشارة مباشرة من البيانات المحلية أولاً
        if (statusBadge && placeStatusNow && String(placeStatusNow).trim() !== '') {
          updatePlaceStatusBadge(statusBadge, placeStatusNow);
        } else if (statusBadge) {
          // إذا لم تكن هناك حالة محلية، جرب جلبها من الإعلانات
          updateStatusBadge(statusBadge, { placeId: placeIdVal, status: '' });
        }

        // روابط (تحديث hrefs إن احتجت)
        const phoneLink = card.querySelector('a[href^="tel:"]');
        const waLink = Array.from(card.querySelectorAll('a[target="_blank"]')).find(a => a.href.includes('wa.me') || a.href.includes('whatsapp'));
        const phone = p.phone || p["phone"] || p["رقم التواصل"] || '';
        const whatsapp = p.whatsapp || p["whatsapp"] || p["رابط واتساب"] || '';
        if (phoneLink && phone) phoneLink.href = phoneHref(phone);
        if (waLink && whatsapp) waLink.href = waHref(whatsapp);

        // مول/الموقع: أعد حل تسمية المول إن وُجدت
        const mallLabel = card.querySelector('.mall-label');
        if (mallLabel) {
          // أحدث قيمة data-mall-id إن تغيّرت
          const mallRaw = p.mall || p["الموقع او المول"] || '';
          if (mallLabel.getAttribute('data-mall-id') !== String(mallRaw)) {
            mallLabel.setAttribute('data-mall-id', mallRaw);
          }
          // حلّ الاسم الظاهر
          resolveMallLabelElement(mallLabel);
        }
      } catch (e) {
        console.warn('updateCardFromPlace failed', e);
      }
    }

    // دالة لضمان عدم اختفاء الشارات
    function ensureStatusBadgesVisible() {
      PLACE_CARDS_BY_ID.forEach((card, placeId) => {
        const statusBadge = card.querySelector('.status-badge');
        if (statusBadge && statusBadge.classList.contains('hidden')) {
          const lastStatus = LAST_AD_STATUS_BY_PLACE.get(placeId);
          if (lastStatus && String(lastStatus).trim() !== '') {
            updatePlaceStatusBadge(statusBadge, lastStatus);
          }
        }
      });
    }

    // بدء التحديث الشامل بعد 2 دقيقة من التحميل الأول
    setTimeout(() => {
      setInterval(refreshAllData, 120000); // 120000ms = 2 minutes
    }, 120000);

    // فحص دوري لضمان عدم اختفاء الشارات
    setInterval(ensureStatusBadgesVisible, 30000); // كل 30 ثانية
  </script>
  <script>
    // منع أي submit أو ريفرش للصفحة في الفلاتر
    document.querySelectorAll('form').forEach(f => {
      f.addEventListener('submit', e => e.preventDefault());
    });
    [citySelect, areaSelect, activitySelect, visitsSelect].forEach(el => {
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter') e.preventDefault();
      });
    });

    // QR actions
    (function(){
      const siteUrl = window.location.origin + window.location.pathname;
      const copyBtn = document.getElementById('qrCopyBtn');
      const shareBtn = document.getElementById('qrShareBtn');
      const qrSrc = 'WhatsApp Image 2025-09-01 at 16.51.42_aa333278.jpg';
      const shareLinks = document.getElementById('shareLinks');
      const wa = document.getElementById('shareWa');
      const tg = document.getElementById('shareTg');
      const fb = document.getElementById('shareFb');
      const x = document.getElementById('shareX');

      if (copyBtn && navigator.clipboard) {
        copyBtn.addEventListener('click', async () => {
          try { await navigator.clipboard.writeText(siteUrl); copyBtn.textContent = 'تم النسخ'; setTimeout(()=>copyBtn.textContent='نسخ الرابط',1500); } catch(e){}
        });
      }
      if (shareBtn) {
        shareBtn.addEventListener('click', async () => {
          if (navigator.share) {
            try { await navigator.share({ title: 'منصة بان', text: 'بان – إعلانك يوصل أسرع', url: siteUrl }); } catch(e){}
          } else {
            // أظهر روابط المشاركة الجاهزة
            if (shareLinks) shareLinks.classList.remove('hidden');
            const text = encodeURIComponent('بان – إعلانك يوصل أسرع');
            const url = encodeURIComponent(siteUrl);
            if (wa) wa.href = `https://wa.me/?text=${text}%20${url}`;
            if (tg) tg.href = `https://t.me/share/url?url=${url}&text=${text}`;
            if (fb) fb.href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
            if (x) x.href = `https://twitter.com/intent/tweet?url=${url}&text=${text}`;
          }
        });
      }
      // تمت إزالة زر الطباعة بناءً على طلبك
    })();
  </script>
  <script>
    function togglePopover(el) {
      document.querySelectorAll('.popover-content').forEach(pop => pop.classList.add('hidden'));
      const pop = el.parentElement.querySelector('.popover-content');
      if (pop) pop.classList.toggle('hidden');
      // إغلاق عند الضغط خارج الأيقونة
      document.addEventListener('click', function handler(e) {
        if (!el.contains(e.target) && !pop.contains(e.target)) {
          pop.classList.add('hidden');
          document.removeEventListener('click', handler);
        }
      });
    }
  </script>
</body>
</html>
