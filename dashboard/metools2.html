<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>فاتورة / عرض أسعار</title>
  <!-- html2canvas & jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: "Tajawal", sans-serif; background: #f3f4f6; }
    table input[type="text"], table input[type="number"] { outline: none; border: none; background: transparent; width: 100%; }
    table input[type="number"]::-webkit-outer-spin-button,
    table input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .watermark { position: absolute; top: 70%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); font-size: 60px; color: rgba(200,200,200,0.18); pointer-events: none; z-index: 0; }
    .remove-row-btn { display: inline-block; }
    [contenteditable]:empty:before { content: attr(data-placeholder); color: #9CA3AF; }
    @media print { body * { visibility: hidden; } #docPreview, #docPreview * { visibility: visible; } #docPreview { position: absolute; top:0; right:0; left:0;} .remove-row-btn { display:none !important; } }
  </style>
</head>
<body class="p-4">

<div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 relative">
  <!-- نوع المستند -->
  <div class="mb-4 flex gap-2">
    <button onclick="setDocType('فاتورة')" class="px-3 py-2 bg-blue-600 text-white rounded">فاتورة</button>
    <button onclick="setDocType('عرض سعر')" class="px-3 py-2 bg-green-600 text-white rounded">عرض سعر</button>
  </div>

  <!-- معاينة المستند -->
  <div id="docPreview" class="relative border rounded p-4 bg-white">
    <div class="watermark" id="watermark"></div>
    <h1 id="docTitle" class="text-xl font-bold text-center mb-2">فاتورة</h1>

    <h2 contenteditable="true" id="placeTitle" data-placeholder="اسم المكان" class="text-lg font-bold text-center mb-2" oninput="updatePreview()"></h2>
    <p contenteditable="true" id="placeNumberText" data-placeholder="رقم المكان (اختياري)" class="text-center text-gray-600 mb-2" oninput="updatePreview()"></p>

    <div class="mb-4 flex justify-between gap-2">
      <span><strong>اسم العميل:</strong> <span contenteditable="true" id="customerText" data-placeholder="اسم العميل" oninput="updatePreview()"></span></span>
      <input type="datetime-local" id="datetimeInput" oninput="updatePreview()">
    </div>

    <!-- جدول الأصناف -->
    <div class="overflow-x-auto mb-3">
      <table id="itemsTable" class="w-full text-center border table-fixed min-w-full">
        <thead>
          <tr id="tableHead"></tr>
        </thead>
        <tbody id="items"></tbody>
      </table>
    </div>

    <!-- إجمالي / ملاحظات -->
    <div id="totalSection" class="text-right font-bold text-lg">الإجمالي: <span id="total">0</span> ج.م</div>
    <div id="notesSection" class="mt-3 hidden">
      <div contenteditable="true" id="generalNotes" data-placeholder="ملاحظات عامة..." class="border p-2 min-h-[60px]" oninput="updatePreview()"></div>
    </div>
  </div>

  <!-- أزرار التحكم -->
  <div class="flex gap-2 mt-4">
    <button onclick="addRow()" class="px-3 py-2 bg-blue-500 text-white rounded">📝 إضافة صنف</button>
    <button onclick="downloadPDF()" class="px-3 py-2 bg-red-600 text-white rounded">📥 تحميل PDF</button>
    <button onclick="printDoc()" class="px-3 py-2 bg-gray-700 text-white rounded">🖨️ طباعة</button>
    <button onclick="shareDoc()" class="px-3 py-2 bg-green-600 text-white rounded">⚡ مشاركة</button>
  </div>
</div>

<script>
const { jsPDF } = window.jspdf;
let docType = "فاتورة";

function setDocType(type) {
  docType = type;
  document.getElementById("docTitle").textContent = type;
  buildTable();
  toggleSections();
  updatePreview();
}

function buildTable() {
  const head = document.getElementById("tableHead");
  head.innerHTML = "";
  if (docType === "فاتورة") {
    head.innerHTML = `<th class="border p-1">الصنف</th>
                      <th class="border p-1">الكمية</th>
                      <th class="border p-1">السعر</th>
                      <th class="border p-1">الإجمالي</th>
                      <th class="border p-1">X</th>`;
  } else {
    head.innerHTML = `<th class="border p-1">الصنف</th>
                      <th class="border p-1">الوحدة</th>
                      <th class="border p-1">السعر</th>
                      <th class="border p-1">ملاحظات</th>
                      <th class="border p-1">X</th>`;
  }
  document.getElementById("items").innerHTML = ""; // يبدأ فارغ
}

function toggleSections() {
  document.getElementById("totalSection").style.display = docType==='فاتورة'?'block':'none';
  document.getElementById("notesSection").style.display = docType==='عرض سعر'?'block':'none';
}

function addRow() {
  let row = '';
  if(docType==='فاتورة'){
    row = `<tr>
      <td class="border p-1"><input type="text" placeholder="اسم الصنف" oninput="updatePreview()"></td>
      <td class="border p-1"><input type="number" value="1" min="1" oninput="updateTotal()"></td>
      <td class="border p-1"><input type="number" value="0" min="0" oninput="updateTotal()"></td>
      <td class="border p-1 total">0</td>
      <td class="border p-1 remove-row-btn"><button onclick="this.closest('tr').remove(); updateTotal()">X</button></td>
    </tr>`;
  } else {
    row = `<tr>
      <td class="border p-1"><input type="text" placeholder="اسم الصنف" oninput="updatePreview()"></td>
      <td class="border p-1"><input type="text" placeholder="الوحدة" oninput="updatePreview()"></td>
      <td class="border p-1"><input type="number" value="0" oninput="updatePreview()"></td>
      <td class="border p-1"><input type="text" placeholder="ملاحظات" oninput="updatePreview()"></td>
      <td class="border p-1 remove-row-btn"><button onclick="this.closest('tr').remove(); updatePreview()">X</button></td>
    </tr>`;
  }
  document.getElementById('items').insertAdjacentHTML('beforeend', row);
  updateTotal();
}

function updateTotal() {
  let total = 0;
  document.querySelectorAll('#items tr').forEach(tr=>{
    if(docType==='فاتورة'){
      const qty = parseFloat(tr.children[1].children[0].value||0);
      const price = parseFloat(tr.children[2].children[0].value||0);
      const sum = qty*price;
      tr.querySelector('.total').textContent = sum.toFixed(2);
      total += sum;
    }
  });
  document.getElementById('total').textContent = total.toFixed(2);
}

function updatePreview() {
  const placeName = document.getElementById('placeTitle').textContent.trim();
  document.getElementById('watermark').textContent = placeName||'';
}

function hideEmptyElements() {
  // اختياري لإخفاء الحقول الفارغة عند الطباعة/التصدير
}

function showAllElements() {
  // إعادة إظهار كل العناصر
}

function downloadPDF() {
  const docElement = document.getElementById('docPreview');
  html2canvas(docElement,{scale:2}).then(canvas=>{
    const imgData = canvas.toDataURL('image/jpeg',1.0);
    const pdf = new jsPDF('p','mm','a4');
    const pageWidth = 210;
    const imgProps = pdf.getImageProperties(imgData);
    const pdfWidth = pageWidth-20;
    const pdfHeight = (imgProps.height*pdfWidth)/imgProps.width;
    pdf.addImage(imgData,'JPEG',10,10,pdfWidth,pdfHeight);
    pdf.save(docType+'.pdf');
  });
}

function printDoc(){ window.print(); }
async function shareDoc(){ alert('سيتم مشاركة الملف بعد توليده'); }

window.addEventListener('load',()=>{
  const now = new Date();
  document.getElementById('datetimeInput').value = now.toISOString().slice(0,16);
  buildTable();
  toggleSections();
});
</script>

</body>
</html>
