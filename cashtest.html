<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙˆÙ„Ù‘Ø¯ Ø£ÙƒÙˆØ§Ø¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ â€“ Ø¨Ø§Ù† Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
  <meta name="theme-color" content="#0d9488" />
  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø§Ø± Ù…Ø·Ù„Ù‚ -->
  <link rel="icon" href="https://moslimtech.github.io/Ban/icons/icon-192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Ø§Ù„Ø®Ø·ÙˆØ· */
    body { font-family: 'Tajawal', system-ui, -apple-system, 'Segoe UI', Roboto, Arial; }

    /* ØªØ£Ø«ÙŠØ±Ø§Øª Glassmorphism */
    .glass { background: rgba(255,255,255,0.6); backdrop-filter: blur(6px); }

    /* ØªØ£Ø«ÙŠØ± Ø­Ø±ÙƒØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    .btn-anim { transition: transform .12s ease, box-shadow .12s ease; }
    .btn-anim:active { transform: translateY(2px) scale(.995); }

    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù€ Modal */
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:60; }
    .modal-card { width:95%; max-width:880px; max-height:85vh; overflow:auto; border-radius:12px; padding:16px; background:var(--card-bg); }

    /* Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø«ÙŠÙ… (ÙØ§ØªØ­/Ø¯Ø§ÙƒÙ†) */
    :root {
      --bg: linear-gradient(180deg,#f0f9ff,#ecfdf5);
      --card-bg: rgba(255,255,255,0.95);
      --text: #0f172a;
      --muted: #475569;
    }
    .dark {
      --bg: linear-gradient(180deg,#071627,#042f2f);
      --card-bg: rgba(2,6,23,0.75);
      --text: #e6eef0;
      --muted: #94a3b8;
    }
    body { background: var(--bg); color: var(--text); }
    .muted { color: var(--muted); }

    /* Ø³ØªØ§ÙŠÙ„ Ø²Ø± Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ù†Ø´Ø· (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø©) */
    .network-active {
        background: rgba(34,197,94,0.12); /* Ø®Ù„ÙÙŠØ© Ø®Ø¶Ø±Ø§Ø¡ ÙØ§ØªØ­Ø© */
        border-color: #22c55e; /* Ø­Ø¯ÙˆØ¯ Ø®Ø¶Ø±Ø§Ø¡ ØµÙ„Ø¨Ø© */
        color: #166534; /* Ù†Øµ Ø£Ø®Ø¶Ø± Ø¯Ø§ÙƒÙ† */
    }

    /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù„ÙˆÙ†Ø© Ø¯Ø§Ø®Ù„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø¨ÙƒØ§Øª */
    .color-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-left: 8px; /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ù†Ù‚Ø·Ø© ÙˆØ§Ù„Ù†Øµ (Ù„Ù„Ø§ØªØ¬Ø§Ù‡ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±) */
        vertical-align: middle;
    }

    /* Ø³ØªØ§ÙŠÙ„ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ Ø§Ù„Ù…Ø®Ø·Ø·Ø© */
    .instapay-icon {
        display: inline-flex;
        align-items: center;
        margin-left: 8px; /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù†Øµ */
        vertical-align: middle;
    }
    .instapay-stripe {
        width: 8px;
        height: 10px;
    }
    .instapay-stripe:first-child { background-color: #facc15; } /* Ø£ØµÙØ± */
    .instapay-stripe:last-child { background-color: #0f172a; } /* Ø¯Ø§ÙƒÙ† */

    /* ØªØ¹Ø¯ÙŠÙ„ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø¨ÙƒØ§Øª Ù„ØªÙ†Ø§Ø³Ø¨ RTL */
    .network-btn {
        flex-direction: row-reverse; /* Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù†Øµ */
    }

    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ modal */
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px 10px; border-bottom:1px solid rgba(0,0,0,0.06); text-align:right; font-size:14px; }
    .badge { padding:6px 8px; border-radius:8px; font-size:13px; }
    .confirmed { background: #dcfce7; color:#166534; }
    .pending { background: #fff7ed; color:#92400e; }

    /* Ø¥Ø¶Ø§ÙØ© Ø¸Ù„ ÙˆØ­Ø¯ÙˆØ¯ Ø®ÙÙŠÙØ© Ù„Ù„ÙƒØ§Ø±Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø©) */
    .modal-card.glass {
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
  </style>

  <!-- manifest by language (Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù€ PWA) -->
  <script>
    const userLang = navigator.language || navigator.userLanguage || 'ar';
    const manifest = document.createElement('link');
    manifest.rel = 'manifest';
    // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª manifest-ar.json Ùˆ manifest-en.json ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
    // Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠØŒ Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ù…ÙˆÙ‚Ø¹ Ù…Ù„ÙØ§ØªÙƒ
    if (userLang.startsWith('ar')) manifest.href = '/Ban/manifest-ar.json?v=1';
    else manifest.href = '/Ban/manifest-en.json?v=1';
    document.head.appendChild(manifest);
  </script>
</head>
<body class="min-h-screen flex items-center justify-center p-6">
  <div class="max-w-4xl w-full">
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-4">
        <!-- Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
        <img src="https://moslimtech.github.io/Ban/icons/icon-192.png" alt="logo" class="w-12 h-12 rounded-lg shadow" />
        <div>
          <h1 class="text-lg font-bold">Ù…ÙˆÙ„Ù‘Ø¯ Ø£ÙƒÙˆØ§Ø¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ â€“ Ø¨Ø§Ù† Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h1>
          <p class="text-sm muted">Ø³Ù‡Ù„ â€¢ Ø³Ø±ÙŠØ¹ â€¢ Ø¢Ù…Ù†</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <!-- Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù†Ø²Ù„) -->
        <a href="https://moslimtech.github.io/Ban/" class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-orange-100 shadow btn-anim hover:shadow-md text-xl">ğŸ </a>
        <!-- Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… (ÙØ§ØªØ­/Ø¯Ø§ÙƒÙ†) -->
        <button id="themeToggle" class="w-10 h-10 rounded-full border btn-anim flex items-center justify-center text-xl">ğŸŒ—</button>
      </div>
    </header>

    <main class="modal-card glass p-5">
      <form id="cashForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium muted mb-1 flex items-center gap-1">
              <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‡Ø§ØªÙ -->
              <svg class="w-4 h-4 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.774a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
              Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…
            </label>
            <div class="flex gap-2 items-center">
              <!-- Ø²Ø± Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ -->
              <button type="button" id="pickContactBtn" class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-emerald-500 text-white btn-anim hover:bg-emerald-600 text-lg">ğŸ‘¤</button>
              <!-- Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ -->
              <input id="phoneInput" type="tel" inputmode="tel" placeholder="01xxxxxxxxx" class="flex-1 px-3 py-2 rounded-lg border focus:outline-none" />
            </div>
            <p class="text-xs muted mt-1 mr-12 text-left">Ù…Ø«Ø§Ù„: 01012345678</p>
          </div>

          <div>
            <label class="block text-sm font-medium muted mb-1 flex items-center gap-1">
              <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø§Ù„ -->
              <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.457 4.907a1 1 0 01-.708 1.41l-2.008.402a1 1 0 01-1.127-.514L9.896 15.68a1 1 0 01.442-.319l2.25-.45a1 1 0 011.41.708zM15 11a1 1 0 100-2 1 1 0 000 2zm-5 6a1 1 0 110-2 1 1 0 010 2z" clip-rule="evenodd"></path></svg>
              Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬Ù†ÙŠÙ‡)
            </label>
            <!-- Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº -->
            <input id="amountInput" type="number" min="1" value="25" placeholder="25" class="w-full px-3 py-2 rounded-lg border focus:outline-none" />
            <p class="text-xs muted mt-1">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰: 1 Ø¬Ù†ÙŠÙ‡</p>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium muted mb-2 flex items-center gap-1">
            <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø´Ø¨ÙƒØ© -->
            <svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path></svg>
            Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¨ÙƒØ©
          </label>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¨ÙƒØ© Ù…Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ù†ØµÙˆØµ -->
            <button type="button" data-net="vodafone" class="network-btn px-3 py-2 rounded-lg border bg-white flex items-center justify-center btn-anim">
                <span class="color-dot" style="background-color: #ef4444;"></span>ÙÙˆØ¯Ø§ÙÙˆÙ†
            </button>
            <button type="button" data-net="etisalat" class="network-btn px-3 py-2 rounded-lg border bg-white flex items-center justify-center btn-anim">
                <span class="color-dot" style="background-color: #22c55e;"></span>Ø§ØªØµØ§Ù„Ø§Øª
            </button>
            <button type="button" data-net="orange" class="network-btn px-3 py-2 rounded-lg border bg-white flex items-center justify-center btn-anim">
                <span class="color-dot" style="background-color: #f97316;"></span>Ø§ÙˆØ±Ø§Ù†Ø¬
            </button>
            <button type="button" data-net="we" class="network-btn px-3 py-2 rounded-lg border bg-white flex items-center justify-center btn-anim">
                <span class="color-dot" style="background-color: #8b5cf6;"></span>ÙˆÙŠ
            </button>
            <button type="button" data-net="instapay" class="network-btn px-3 py-2 rounded-lg border bg-white flex items-center justify-center btn-anim">
                <span class="instapay-icon"><span class="instapay-stripe"></span><span class="instapay-stripe"></span></span>Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ
            </button>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-3 justify-end">
          <!-- Ø²Ø± "ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù†" -->
          <button id="generateBtn" type="button" class="px-4 py-2 rounded-xl bg-teal-500 text-white font-semibold shadow-lg btn-anim hover:bg-teal-600 flex items-center gap-2">
            <span class="text-lg">ğŸš€</span> ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù†
          </button>
          <!-- Ø²Ø± "Ù…Ø¹Ø§ÙŠÙ†Ø©" -->
          <button id="previewBtn" type="button" class="px-4 py-2 rounded-xl bg-white border font-medium btn-anim hover:shadow flex items-center gap-2">
            <span class="text-lg">ğŸ‘ï¸</span> Ù…Ø¹Ø§ÙŠÙ†Ø©
          </button>
          <!-- Ø²Ø± "Ø§Ù„Ø³Ø¬Ù„" -->
          <button id="historyBtn" type="button" class="px-4 py-2 rounded-xl bg-amber-500 text-white btn-anim hover:bg-amber-600 flex items-center gap-2">
            <span class="text-lg">ğŸ“œ</span> Ø§Ù„Ø³Ø¬Ù„
          </button>
        </div>

        <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯) -->
        <div id="resultBox" class="mt-4 hidden p-4 rounded-lg bg-white border">
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
            <div class="flex-1">
              <p class="text-sm muted">ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·/Ø§Ù„ÙƒÙˆØ¯ â€” Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£Ùˆ Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯:</p>
              <pre id="resultText" class="code mt-2 text-sm bg-gray-50 p-2 rounded overflow-x-auto"></pre>
              <div class="mt-3 flex flex-wrap gap-2">
                <button id="copyBtn" class="px-3 py-2 rounded bg-sky-600 text-white btn-anim hover:bg-sky-700">Ù†Ø³Ø®</button>
                <a id="openLinkBtn" class="px-3 py-2 rounded bg-emerald-500 text-white btn-anim hover:bg-emerald-600" href="#" target="_blank" rel="noopener">ÙØªØ­</a>
                <a id="whatsappBtn" class="px-3 py-2 rounded bg-green-600 text-white btn-anim hover:bg-green-700" href="#" target="_blank" rel="noopener">ÙˆØ§ØªØ³Ø§Ø¨</a>
              </div>
            </div>
            <div class="text-sm muted text-right">
              <div>Ø§Ù„Ø´Ø¨ÙƒØ©: <span id="showNetwork">-</span></div>
              <div class="mt-2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¤ÙƒØ¯: <strong id="totalConfirmed">0</strong> Ø¬</div>
            </div>
          </div>
        </div>

      </form>
    </main>

    <!-- ÙÙˆØªØ± Ø§Ù„ØµÙØ­Ø© -->
    <footer class="mt-4 text-center text-xs muted">Â© 2025 Ø¨Ø§Ù† Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</footer>
  </div>

  <!-- History Modal (ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø§Ù„Ø³Ø¬Ù„") -->
  <div id="historyBackdrop" class="modal-backdrop hidden">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="flex flex-wrap items-center justify-between mb-3 gap-2">
        <h3 class="font-bold text-lg">ğŸ“œ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
        <div class="flex flex-wrap gap-2">
          <button id="downloadCsvBtn" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ CSV</button>
          <button id="clearHistoryBtn" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
          <button id="closeHistoryBtn" class="px-3 py-2 bg-gray-200 rounded-lg text-sm">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div id="historyStats" class="mb-3 text-sm muted"></div>

      <div id="historyTableWrapper" class="overflow-auto">
        <table id="historyTable" class="bg-transparent">
          <thead>
            <tr>
              <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>ğŸ“± Ø§Ù„Ø±Ù‚Ù…</th>
              <th>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>ğŸ“¶ Ø§Ù„Ø´Ø¨ÙƒØ©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="historyTbody">
            <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙÙˆÙ Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
          </tbody>
        </table>
      </div>

      <div class="mt-4 text-right">
        <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¤ÙƒØ¯: <span id="modalTotalConfirmed">0</span> Ø¬Ù†ÙŠÙ‡</strong>
      </div>
    </div>
  </div>

  <script>
    /********** Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ **********/
    const templates = {
      vodafone: (localPhone, amount) => `*9*7*${localPhone}*${amount}#`,
      etisalat: (localPhone, amount) => `*777*${localPhone}*${amount}#`,
      orange: (localPhone, amount) => `*115*1*${localPhone}*${amount}#`,
      we: (localPhone, amount) => `*322*${localPhone}*${amount}#`,
      instapayDeep: (phone, amount) => `instapay://pay?recipient=${phone}&amount=${amount}`,
      instapayWeb: (phone, amount) => `https://ipn.eg/S/instapay?recipient=${phone}&amount=${amount}`
    };

    const networkLabels = {
      vodafone: 'ÙÙˆØ¯Ø§ÙÙˆÙ†',
      etisalat: 'Ø§ØªØµØ§Ù„Ø§Øª',
      orange: 'Ø£ÙˆØ±Ø§Ù†Ø¬',
      we: 'ÙˆÙŠ',
      instapay: 'Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ'
    };

    /********** Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© (Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø§Ù„Ù€ HTML ID) **********/
    const phoneInput = document.getElementById('phoneInput');
    const amountInput = document.getElementById('amountInput');
    const networkButtons = document.querySelectorAll('.network-btn');
    const generateBtn = document.getElementById('generateBtn');
    const previewBtn = document.getElementById('previewBtn');
    const historyBtn = document.getElementById('historyBtn');
    const resultBox = document.getElementById('resultBox');
    const resultText = document.getElementById('resultText');
    const copyBtn = document.getElementById('copyBtn');
    const openLinkBtn = document.getElementById('openLinkBtn');
    const whatsappBtn = document.getElementById('whatsappBtn');
    const showNetwork = document.getElementById('showNetwork');
    const totalConfirmedSpan = document.getElementById('totalConfirmed');

    const pickContactBtn = document.getElementById('pickContactBtn');
    const historyBackdrop = document.getElementById('historyBackdrop');
    const historyTbody = document.getElementById('historyTbody');
    const historyStats = document.getElementById('historyStats');
    const closeHistoryBtn = document.getElementById('closeHistoryBtn');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const modalTotalConfirmed = document.getElementById('modalTotalConfirmed');
    const themeToggle = document.getElementById('themeToggle');

    let selectedNetwork = 'vodafone'; // ÙÙˆØ¯Ø§ÙÙˆÙ† Ù‡ÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©

    /********** ÙˆØ¸ÙŠÙØ© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… (ÙØ§ØªØ­/Ø¯Ø§ÙƒÙ†) **********/
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    function applyTheme(mode) {
      if (mode === 'dark') {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme','dark');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme','light');
      }
    }
    const savedTheme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
    applyTheme(savedTheme);
    themeToggle.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'; // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø«ÙŠÙ…
    themeToggle.addEventListener('click', () => {
      const now = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(now);
      themeToggle.textContent = now === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'; // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø«ÙŠÙ… Ø¨Ø¹Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
    });

    /********** ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¨ØµØ±ÙŠØ§Ù‹ **********/
    function markSelected() {
      networkButtons.forEach(btn => {
        btn.classList.toggle('network-active', btn.dataset.net === selectedNetwork);
      });
    }
    networkButtons.forEach(btn => btn.addEventListener('click', () => {
      selectedNetwork = btn.dataset.net;
      markSelected();
    }));
    markSelected(); // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©

    /********** Ø§Ù„ØªÙ‚Ø§Ø· Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ (Ø£ÙØ¶Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù…ÙƒÙ†Ø©) **********/
    pickContactBtn.addEventListener('click', async () => {
      try {
        if (navigator.contacts && navigator.contacts.select) {
          const contacts = await navigator.contacts.select(['tel','name'], { multiple:false });
          if (contacts && contacts.length) {
            const tel = (contacts[0].tel && contacts[0].tel[0]) || '';
            phoneInput.value = tel.replace(/\s|-|\(|\)/g,''); // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù…
            return;
          }
        }
        phoneInput.focus(); // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ØŒ Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        alert('Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ù…Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ Ù…ØªØµÙØ­ÙƒØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹.');
      } catch (error) {
        console.error("Error accessing contacts:", error); // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØªØ¨Ø¹
        phoneInput.focus();
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ â€” Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹.');
      }
    });

    /********** ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªÙ†Ø¸ÙŠÙ ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… **********/
    function onlyDigits(value=''){ return String(value||'').replace(/[^0-9]/g,''); }
    function toLocal(cleaned) {
      if (!cleaned) return '';
      if (cleaned.startsWith('20')) return '0' + cleaned.slice(2); // 2010... -> 010...
      if (cleaned.startsWith('2') && cleaned.length===11) return '0' + cleaned.slice(1); // 210... (Ù…ØµØ±) -> 010...
      if (cleaned.startsWith('0')) return cleaned; // 010...
      if (cleaned.length === 9) return '0' + cleaned; // 10... (Ø¥Ø°Ø§ ÙƒØ§Ù† 9 Ø£Ø±Ù‚Ø§Ù…ØŒ Ø§ÙØªØ±Ø¶ 0 Ù‚Ø¨Ù„Ù‡Ø§)
      return cleaned;
    }
    function toInternational(cleaned) {
      if (!cleaned) return '';
      if (cleaned.startsWith('0')) return '2' + cleaned.slice(1); // 010... -> 2010...
      if (cleaned.startsWith('20')) return cleaned; // 2010...
      if (cleaned.startsWith('2') && cleaned.length>2) return cleaned; // 2010...
      return cleaned;
    }

    /********** Ø¨Ù†Ø§Ø¡ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (ÙƒÙˆØ¯ USSD Ø£Ùˆ Ø±Ø§Ø¨Ø· Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ) **********/
    function buildActionLink(network, phoneRaw, amountRaw) {
      const cleaned = onlyDigits(phoneRaw);
      const amount = Number(amountRaw) || 0;
      if (!cleaned || amount <= 0) return null; // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª

      const local = toLocal(cleaned);
      const intl = toInternational(cleaned);

      if (network === 'instapay') {
        // Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ ÙŠØ³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± (Deep link) ÙˆØ±Ø§Ø¨Ø· ÙˆÙŠØ¨ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        return { type:'instapay', deep: templates.instapayDeep(intl, amount), web: templates.instapayWeb(intl, amount), local, intl, amount };
      }

      // Ø§Ù„Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ØªØ³ØªØ®Ø¯Ù… Ø£ÙƒÙˆØ§Ø¯ USSD
      const code = templates[network](local, amount);
      return { type:'ussd', url: 'tel:' + encodeURIComponent(code), code, local, intl, amount };
    }

    /********** Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (LocalStorage) **********/
    const STORAGE_KEY = 'ban_cash_transactions_v1';
    function loadHistory() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch (error) { console.error("Error loading history from localStorage:", error); return []; }
    }
    function saveHistory(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
    function addHistoryItem(item) {
      const arr = loadHistory();
      arr.unshift(item); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
      if (arr.length > 500) arr.pop(); // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ù…Ø­Ø¯ÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
      saveHistory(arr);
    }
    function clearHistory() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
        localStorage.removeItem(STORAGE_KEY);
        alert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø¬Ù„.');
      }
    }

    /********** Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆÙØªØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·/Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ **********/
    function showResult(result) {
      resultBox.classList.remove('hidden'); // Ø¥Ø¸Ù‡Ø§Ø± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      if (result.type === 'instapay') {
        resultText.textContent = result.web; // Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ù„Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ
        openLinkBtn.href = result.deep; // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù‡Ùˆ Deep link
        openLinkBtn.setAttribute('data-fallback', result.web); // Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ ÙƒØ§Ø­ØªÙŠØ§Ø·ÙŠ
      } else {
        resultText.textContent = result.code; // Ø¹Ø±Ø¶ ÙƒÙˆØ¯ USSD
        openLinkBtn.href = result.url; // Ø±Ø§Ø¨Ø· 'tel:'
        openLinkBtn.removeAttribute('data-fallback'); // Ù„Ø§ ÙŠÙˆØ¬Ø¯ fallback Ù„Ù€ USSD
      }
      showNetwork.textContent = networkLabels[selectedNetwork] || '-';
      whatsappBtn.href = 'https://wa.me/' + result.intl; // Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆÙ„ÙŠ
      updateTotalsDisplay(); // ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¤ÙƒØ¯
    }

    generateBtn.addEventListener('click', () => {
      const phone = phoneInput.value.trim();
      const amount = amountInput.value.trim();
      const result = buildActionLink(selectedNetwork, phone, amount);
      if (!result) {
        alert('Ù…Ù† ÙØ¶Ù„Ùƒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ§Ù„Ø­ ÙˆØ§Ù„Ù…Ø¨Ù„Øº.');
        return;
      }

      // Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ ÙƒÙ€ "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"
      const now = new Date();
      addHistoryItem({
        number: onlyDigits(phone),
        local: result.local,
        intl: result.intl,
        amount: result.amount,
        network: selectedNetwork,
        networkLabel: networkLabels[selectedNetwork], // Ù„Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù„Ù„Ø´Ø¨ÙƒØ©
        date: now.toLocaleString('ar-EG'),
        confirmed: false
      });

      showResult(result);

      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙØªØ­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:
      if (result.type === 'instapay') {
        // Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ Ø§Ù„Ù€ Deep link Ø£ÙˆÙ„Ø§Ù‹
        try { window.location.href = result.deep; } catch(e) { console.error("Error opening deep link:", e); }
        // Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø©ØŒ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØªØ­ Deep link (Ù„Ø£Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…Ø«Ø¨Øª Ù…Ø«Ù„Ø§Ù‹)ØŒ Ø¬Ø±Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨
        setTimeout(() => { window.location.href = result.web; }, 1200);
      } else {
        // Ù„Ø£ÙƒÙˆØ§Ø¯ USSDØŒ ÙŠØªÙ… Ø§Ù„ÙØªØ­ Ù…Ø¨Ø§Ø´Ø±Ø©
        try { window.location.href = result.url; } catch(e){ console.error("Error opening USSD link:", e); }
      }
    });

    openLinkBtn.addEventListener('click', (event) => {
      const fallback = openLinkBtn.getAttribute('data-fallback');
      if (!fallback) return; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ fallback Ù„Ø£ÙƒÙˆØ§Ø¯ USSDØŒ Ù„Ø°Ø§ Ù†ÙØ° Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±Ø©
      event.preventDefault(); // Ù…Ù†Ø¹ Ø³Ù„ÙˆÙƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ù†Ø¬Ø±Ø¨ Ø§Ù„Ù€ deep link Ø£ÙˆÙ„Ø§Ù‹
      const href = openLinkBtn.href;
      try { window.location.href = href; } catch (err) { console.error("Error opening deep link from button:", err); }
      setTimeout(() => { window.location.href = fallback; }, 1200); // Ø¬Ø±Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ ÙƒØ§Ø­ØªÙŠØ§Ø·ÙŠ
    });

    previewBtn.addEventListener('click', () => {
      const phone = phoneInput.value.trim();
      const amount = amountInput.value.trim();
      const result = buildActionLink(selectedNetwork, phone, amount);
      if (!result) {
        alert('Ù…Ù† ÙØ¶Ù„Ùƒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ§Ù„Ø­ ÙˆØ§Ù„Ù…Ø¨Ù„Øº.');
        return;
      }
      showResult(result);
    });

    copyBtn.addEventListener('click', async () => {
      const txt = resultText.textContent || '';
      try {
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = 'ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“'; // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ø³Ø®
        setTimeout(() => (copyBtn.textContent = 'Ù†Ø³Ø®'), 1500); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø¹Ø¯ ÙØªØ±Ø©
      } catch (error) {
        console.error("Error copying to clipboard:", error);
        alert('Ù†Ø³Ø® ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹.');
      }
    });

    /********** ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù€ Modal Ù„Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ **********/
    historyBtn.addEventListener('click', () => {
      renderHistory();
      historyBackdrop.classList.remove('hidden');
      historyBackdrop.style.display = 'flex';
    });
    closeHistoryBtn.addEventListener('click', () => {
      historyBackdrop.classList.add('hidden');
      historyBackdrop.style.display = 'none';
    });

    // ØªÙ… Ù†Ù‚Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù„Ù€ clearHistory Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù†ÙØ³Ù‡Ø§
    clearHistoryBtn.addEventListener('click', clearHistory);

    function renderHistory() {
      const arr = loadHistory();
      historyTbody.innerHTML = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù…
      if (!arr.length) {
        historyStats.innerHTML = `<p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.</p>`;
        modalTotalConfirmed.textContent = '0';
        return;
      }

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§
      const totalAmount = arr.reduce((sum,item)=>sum+Number(item.amount),0);
      const confirmedAmount = arr.filter(item=>item.confirmed).reduce((sum,item)=>sum+Number(item.amount),0);
      const totalCount = arr.length;
      const confirmedCount = arr.filter(item=>item.confirmed).length;

      historyStats.innerHTML =
        `ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <strong>${totalCount}</strong> â€” Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº: <strong>${totalAmount}</strong> Ø¬ â€” ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯: <strong>${confirmedCount}</strong> (${confirmedAmount} Ø¬)`;

      arr.forEach((item, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="white-space:nowrap">${item.date}</td>
          <td>${item.local || item.number}</td>
          <td>${item.amount}</td>
          <td>${item.networkLabel || networkLabels[item.network] || item.network}</td>
          <td>${item.confirmed ? '<span class="badge confirmed">ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„</span>' : '<span class="badge pending">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span>'}</td>
          <td style="white-space:nowrap">
            ${item.confirmed ? '' : `<button data-idx="${idx}" class="confirm-row px-2 py-1 rounded bg-emerald-500 text-white text-xs btn-anim">ØªØ£ÙƒÙŠØ¯</button>`}
            <button data-del="${idx}" class="delete-row px-2 py-1 rounded bg-red-100 ml-2 text-xs btn-anim">Ø­Ø°Ù</button>
          </td>
        `;
        historyTbody.appendChild(tr);
      });

      // Ø¥Ø±ÙØ§Ù‚ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (handlers) Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      historyTbody.querySelectorAll('.confirm-row').forEach(btn =>
        btn.addEventListener('click', () => confirmFromHistory(Number(btn.getAttribute('data-idx'))))
      );
      historyTbody.querySelectorAll('.delete-row').forEach(btn =>
        btn.addEventListener('click', () => deleteFromHistory(Number(btn.getAttribute('data-del'))))
      );

      modalTotalConfirmed.textContent = confirmedAmount; // ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¤ÙƒØ¯ ÙÙŠ Ø§Ù„Ù€ modal
    }

    function confirmFromHistory(index) {
      const arr = loadHistory();
      if (!arr[index]) return;
      arr[index].confirmed = true; // ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© "ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯"
      saveHistory(arr);
      renderHistory(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø³Ø¬Ù„
      updateTotalsDisplay(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
    }

    function deleteFromHistory(index) {
      const arr = loadHistory();
      if (!arr[index]) return;
      if (confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
        arr.splice(index,1); // Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
        saveHistory(arr);
        renderHistory(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø³Ø¬Ù„
        updateTotalsDisplay(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
      }
    }

    function updateTotalsDisplay() {
      const arr = loadHistory();
      const total = arr.filter(item=>item.confirmed).reduce((sum,item)=>sum+Number(item.amount),0);
      totalConfirmedSpan.textContent = total; // ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¤ÙƒØ¯ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      modalTotalConfirmed.textContent = total; // ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¤ÙƒØ¯ ÙÙŠ Ø§Ù„Ù€ modal
    }

    /********** ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ ÙƒÙ…Ù„Ù CSV **********/
    downloadCsvBtn.addEventListener('click', () => {
      const arr = loadHistory();
      if (!arr.length) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„ØªØ­Ù…ÙŠÙ„Ù‡Ø§.');
        return;
      }
      // ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø®Ø·Ø£ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù€ String
      let csv = `Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…,Ø§Ù„Ù…Ø¨Ù„Øº,Ø§Ù„Ø´Ø¨ÙƒØ©,ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯
`;
      arr.forEach(item=>{
        const label = item.networkLabel || networkLabels[item.network] || item.network;
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ… Ù…Ø­Ø§Ø·Ø© Ø¨Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØµÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        csv += `"${item.date || ''}","${item.number || item.local || ''}","${item.amount || 0}","${label || ''}","${item.confirmed ? 'Ù†Ø¹Ù…':'Ù„Ø§'}"
`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'transactions_history.csv'; // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
      a.click();
      URL.revokeObjectURL(url); // ØªØ­Ø±ÙŠØ± Ø§Ù„Ù€ URL Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    });

    /********** ØªØ³Ø¬ÙŠÙ„ Service Worker (Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù€ PWA) **********/
    // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙˆÙŠÙ‡Ø¯Ù Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ ØªÙ‚Ø¯Ù…ÙŠ (PWA)
    // Ø¥Ø°Ø§ ÙƒÙ†Øª Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Firebase Cloud MessagingØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø³Ø§Ø± Ø£Ùˆ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡
    if ('serviceWorker' in navigator) {
      // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…Ø³Ø§Ø± firebase-messaging-sw.js ØµØ­ÙŠØ­ Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Firebase Cloud Messaging
      navigator.serviceWorker.register('/Ban/firebase-messaging-sw.js')
        .then(()=>console.log('âœ… Firebase Messaging SW Registered'))
        .catch(err=>console.log('âŒ SW registration failed:', err));
    }

    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    amountInput.value = 25;
  </script>
</body>
</html>
